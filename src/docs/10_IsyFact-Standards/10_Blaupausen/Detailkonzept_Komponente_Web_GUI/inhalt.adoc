[[anforderungen]]
= Anforderungen

[[allgemeine-anforderungen]]
== Allgemeine Anforderungen

Die in diesem Dokument aufgestellten Vorgaben setzen folgende Anforderungen um:

*Einfachheit der Verwendung von JSF*: Hier werden die Konfiguration und der Einsatz der verwendeten Technologien festgelegt.
Dazu zählen:

** Einsatz von Facelets
** Einsatz von Tag Libraries
** Fehlerbehandlung
** Anbindung von Hilfesystemen

*Einfachheit des Einsatzes von Spring Web Flow:* Die Definition der Dialogschritte und die Abhängigkeiten zu den zugehörigen Daten für die Darstellung wird über Spring Web Flow festgelegt.
Hierzu werden folgende Themenbereiche genauer definiert:

** Konfiguration der Dialog Abläufe (Flow)
** Anbindung der Backend Services (Spring Beans)

*Einfachheit des Session Management:* Hier wird definiert, wie die Behandlung von Session Informationen erfolgen soll und welche wiederverwendbaren Services zur Verfügung gestellt werden.

[[sicherheitsanforderungen]]
== Sicherheitsanforderungen

Web-Anwendungen sind besonderen Gefährdungen ausgesetzt.
Folgende Anforderungen müssen bei der Entwicklung von Web-Anwendungen berücksichtigt werden:

* Entwickler müssen sich mit den TOP10 Risiken für Web-Anwendungen gemäß OWASP vertraut machen (siehe <<OWASP10>>)
* Vertrauliche Informationen dürfen nicht als GET-Parameter übermittelt werden.
Dies verhindert, dass solche Informationen ungewollt in Log-Dateien, Caches usw.
gespeichert werden.

[[verwendete-basistechnologien]]
= Verwendete Basistechnologien

Die Übersicht der Basistechnologien soll dem Leser einen einfacheren Einstieg in die angewendeten Frameworks und Technologien ermöglichen, zusätzlich findet sich noch ein Verweis auf die konkret eingesetzten Implementierungen.
Hierbei werden auch Architekturprinzipien angesprochen, welche in den Technologien Verwendung finden.

Für detaillierte Informationen über die verwendeten Technologien sei auf entsprechende Literatur verwiesen:
<<WikiJSF>>, <<SWF>> und <<Spring>>.



[[jsf-facelets]]
== JSF / Facelets

Nachfolgend soll kurz eine Erläuterung der Begrifflichkeiten vorgenommen werden:

*Java Server Faces (JSF)* ist ein Framework für die Entwicklung von Webanwendungen.
Es implementiert wie auch weitere Java-Frameworks die MVC-Architektur.
Der Schwerpunkt von JSF ist die Bereitstellung grafischer Komponenten wie z.B. Tabellen, Formulare, Kalender,Menüs, Editoren, usw. für die Entwicklung von Webanwendungen.
Zentrales Konzept hinter JSF ist die Bereitstellung eines Komponentenbaumes.
Aus diesem Baum wird zum Schluss der Bearbeitung die HTML Seite generiert.

Für JSF kommt die SUN Referenzimplementierung zum Einsatz und wird im Bereich der Komponenten um die Apache Tomahawk Bibliothek erweitert <<SUNRI>>, <<Tomahawk>>.

*Facelets* sind eine alternative View Technologie für JSF.
Hiermit sind kleine, wieder verwendbare GUI-Komponenten möglich, die durch ein entsprechendes XML-Tag in eine Seite inkludiert werden.
Im Gegensatz zu Taglibs erfolgt ein Include der Komponente und kein Aufruf von Java-Code für die
Generierung von gerendertem GUI-Code.
Hierbei wird der Templating Mechanismus der Facelets verwendet.
Facelets bieten vielfältige Möglichkeiten, Vorlagenfragmente zu einer Gesamtseite zusammenzusetzen, um z.B. auf jeder Seite eine einheitliche Kopfzeile zu realisieren.

Weiter können Facelets mit herkömmlichen HTML-Editoren bearbeitet werden und sind somit einfacher zu verstehen und zu editieren.
Die Ablage erfolgt in XHTML-Dokumenten.
Als Implementierung kommt die SUN Bibliothek für Facelets <<Facelets>> zum Einsatz.

*Model-View-Controller (MVC, „Modell / Präsentation / Steuerung“)* bezeichnet ein Architekturmuster zur Strukturierung von Software-Entwicklung in die drei Einheiten _Datenmodell_ (engl. _Model_), _Präsentation_ (engl. _View_) und _Programmsteuerung_ (engl. _Controller_).
Ziel des Musters ist es, einen flexiblen Programmentwurf zu gestalten, der u. A. eine spätere Änderung oder Erweiterung erleichtert und eine Wiederverwendung der einzelnen Komponenten ermöglicht.
Dieses Muster ist in <<image-MVCPat>> dargestellt.

:desc-image-MVCPat: MVC Pattern
[id="image-MVCPat",reftext="{figure-caption} {counter:figures}"]
.{desc-image-MVCPat}
image::MVC.png[align="center"]

[[bearbeitungsmodell-einer-jsf-anfrage]]
=== Bearbeitungsmodell einer JSF Anfrage

Die Spezifikation der Java Server Faces definiert einen sogenannten Lebenszyklus <<WikiJSF>> , den eine
JSF-Anwendung mit jedem Aufruf erneut durchläuft.
Dieser Lebenszyklus ist in sechs _Phasen_ (englisch _Phases_) aufgeteilt.

:desc-image-PhasemodJSF: Phasenmodell JSF
[id="image-PhasemodJSF",reftext="{figure-caption} {counter:figures}"]
.{desc-image-PhasemodJSF}
image::jsf-phasen.png[align="center"]

1.  _Restore View_ („Sicht wiederherstellen“) wählt anhand der eingehenden Anforderung eine Sicht (_View_) aus und baut den dazu passenden Komponentenbaum bei Bedarf auf.
2.  _Apply Request Values_ („Anforderungsparameter anwenden“) extrahiert Parameter aus der Anforderung (üblicherweise ein HTTP-Post-Request) und weist sie den passenden JSF-Komponenten zu, beispielsweise Eingabefeldern.
3.  _Process Validations_ („Validierung ausführen“) überprüft die Gültigkeit der zuvor ermittelten Eingaben.
Dazu werden eigene Validator-Objekte verwendet, die den Komponenten in der View-Definition zugewiesen wurden.
4.  _Update Model Values_ („Modell aktualisieren“) weist den Modellobjekten die zuvor ermittelten Werte zu.
5.  _Invoke Application_ („Anwendung aufrufen“) ruft durch die Anwendung definierte Methoden auf, beispielsweise wenn ein Button betätigt wurde.
6.  _Render Response_ („Antwort wiedergeben“) erzeugt schließlich die Antwort auf die ursprüngliche Anfrage, beispielsweise eine HTML-Seite.
Hierzu werden sogenannte _Renderer_ aufgerufen, die den View-Komponenten zugeordnet sind.

Treten Fehler auf, oder soll als Antwort beispielsweise eine HTML-Seite aufgerufen werden, die keine
JSF-Komponenten enthält, so können einzelne Phasen übersprungen werden.

[[datenmodell]]
=== Datenmodell

Die Daten für die Visualisierung in JSF werden in Model Beans gehalten.
Hierfür wird nicht auf den durch JSF zur Verfügung gestellten Mechanismus der Managed Beans zurückgegriffen.
Das Datenmodell wird über Spring Web Flow direkt aus Model Beans verfügbar gemacht.
Damit ist die Verwaltung des Models unter Kontrolle des Dialogflusses welcher über Spring Web Flow gesteuert wird.
Die einem Flow zugeordneten Model Beans werden durch den Flow instanziiert und unterliegen somit dem Flow-Lebenszyklus.

[[facelets]]
=== Facelets

Mit den Facelets werden das visuelle Layout und die Controls für die Ansicht im Browser definiert.
Durch die Nähe zu HTML sind schnell die notwendigen Ansichten designed und können getestet werden.
Das Mapping der Controls auf die Daten geschieht über die in JSF verwendete Expression Language (EL).
Mit der EL werden direkt die Attribute des zugehörigen Beans genutzt.

Ein weiterer Vorteil von Facelets ist die Verwendung von Templates.
Durch diese ist es möglich, bereits einen zum Styleguide <<Styleguide>> konformen Rahmen zur Verfügung zu stellen, in welchen die
Applikation lediglich durch definierte Einfügungen ihre Inhalte einbetten.

[[taglibs]]
=== Taglibs

Durch den Einsatz von Facelets ist die direkte Einbettung von Tag Libraries nicht möglich.
Vielmehr müssen diese noch separat mit einer Deskription versehen werden, aus welcher die einzelnen Tags
ersichtlich sind und ihr Mapping auf die zugehörigen Klassen definiert ist.

Für den Einsatz der myFaces Tomahawk Library wird eine entsprechende Konfiguration zur Verfügung gestellt.
Der Einsatz dieser Library unterliegt für den Einsatz in der IsyFact der allgemeinen Einschränkung bei der Verwendung von JavaScript.
Siehe auch Kapitel <<benoetigte-bibliotheken>>.

[[spring-web-flow]]
== Spring Web Flow

Spring Web Flow ist ein Framework für die Ablaufsteuerung von Anwendungsfällen innerhalb von Web-Anwendungen.
Ein solcher „Flow“ innerhalb von Spring Web Flow ist eine Abfolge zusammenhängender Masken, wie z.B. das Durchlaufen der Schritte zur Registrierung eines neuen Benutzers in einer Web Anwendung.

Ein erklärtes Ziel von Spring Web Flow ist die Unterstützung der Browser-Navigation, die in der Web-Entwicklung immer wieder zu Problemen führt.
Das Framework übernimmt dabei die Navigation zwischen den einzelnen Views und stellt darüber hinaus einen eigenen Scope Container für Model Beans zur Verfügung.
Dieser erweitert die Web-Anwendung um die folgenden Scopes:

* Flash: Gültig, solange der Flow aktiv ist, jedoch werden Flash Scope Beans nach jedem View-State geleert und dienen somit dazu, Daten zwischen zwei User Events zu transferieren.
* Flow: Steht über die gesamte Laufzeit des Flows zur Verfügung.
* Conversation: Die Lebensdauer ist mit dem Flow Scope identisch, nur stehen Conversation Scope Beans auch in den zugehörigen Subflows zur Verfügung.

Spring Web Flow implementiert im Kern einen finiten Zustandsautomaten, der auf definierte Anfangs- und Endzustände angewiesen ist.

Der Ablauf der logisch zusammenhängenden Views wird in einem so genannten Flow definiert.
Innerhalb eines Flows stehen verschiedene States zur Verfügung.
Zunächst muss jeder Flow einen Start State und einen End State besitzen.
Der Start State definiert den Einstiegspunkt und aktiviert den jeweiligen Flow.
Dieser bleibt so lange aktiv, bis ein End State erreicht wird.

Wie bereits erwähnt, setzt sich Spring Web Flow das Ziel, die Browser-Navigation mit „Back-/Forward-Button“ zu unterstützen.
Um diese Funktionalität zu gewährleisten, muss die Möglichkeit bestehen, den Zustand einer View zu speichern und wieder abzurufen.
Hierfür steht ein so genanntes Repository zur Verfügung, welches die Zustände der einzelnen Views innerhalb eines Flows zwischenspeichert.
Dadurch kann man den Zustand jeder View innerhalb eines Flows zu einem beliebigen Zeitpunkt reproduzieren.

[[flows-subflows]]
=== Flows / Subflows

Ein Flow kann wahlweise als XML-Datei oder mittels der Java-API realisiert werden.
Ein Flow besteht in der Regel aus mehreren Zuständen (innerhalb von Web Flow als States bezeichnet), die nacheinander und in Abhängigkeit von der jeweiligen Benutzerinteraktion durchlaufen werden.

Auch die Modularisierung von Flows in kleine Einheiten ist durch so genannte Subflows bzw.
Inline-Flows ohne weiteres möglich.
Ein Subflow wird wie jede andere Flow-Definition erstellt.
Der Unterschied zu einem normalen Flow liegt lediglich darin, dass der Subflow innerhalb eines Flows aufgerufen wird.
Eine Flow-Definition kann beliebig viele Subflows enthalten, welche wiederum weitere Subflows aufrufen können.

[[back-button-handling]]
=== Back-Button Handling

Während der Ausführung von Flows werden die Variablen mit einer Zwischenspeicherung in das Repository geschrieben.
Hierbei wird immer, wenn ein Flow durch eine User-Interaktion unterbrochen wird, der aktuelle Status gespeichert.
Das Repository liefert diesen bei der Fortsetzung des Flows zurück.
Der dafür notwendige „Flow-Execution-Key“, der Schlüssel, der zur Identifikation des aktuellen Flow-Status dient,
wird hierbei von Spring Web Flow erzeugt.

Dieses Speichern des Status von vorhergehenden Schritten im Flow unterstützt so in Kombination mit
einem „Post Redirect Get“ Mechanismus (PRG-Pattern) die Nutzung des Back-Buttons im Browser.
Da jeder Request im Flow einen eindeutigen Execution Key an den Server sendet, kann, wenn man im
Flow zurückgeht, auch der alte Status zum Zeitpunkt dieses Request angezeigt werden, selbst wenn der Server von dem Click auf den Back-Button selbst nichts mitbekommt.

[[spring-dependency-injection]]
== Spring Dependency Injection

Das Spring Framework ist ein Java EE Framework.
In ihm werden die Bestandteile eines Systems als „Beans“ definiert.
Neben seiner Kern-Funktionalität, der Verwaltung, Konfiguration und aspektorientierten Erweiterung von Beans, bietet Spring viele Funktionalitäten, welche die Entwicklung einer Anwendung erleichtern.

Für das Web-GUI findet primär der Basisteil von Spring Verwendung, in welchem der Anwendung über Dependency Injection Beans zur Verfügung gestellt werden <<Spring>>.

[[transaktionsbehandlung]]
== Transaktionsbehandlung

Die GUI-Komponente und der Anwendungskern (AWK) sind Teil derselben Web-Applikation und werden per Spring-Konfiguration miteinander verbunden.

Oft gibt es den Fall, dass über die GUI eine Aktion in einer anderen Anwendung ausgelöst werden soll.
Ein Beispiel dafür ist die GUI einer Fachanwendung zur Datenerfassung, wobei die Speicherung der Daten über einen Service einer anderen Fachanwendung implementiert ist.
In diesem Fall enthält der Anwendungskern der Fachanwendung zur Datenerfassung nur wenig Funktionalität: in ihm werden die Daten für den Serviceaufruf der nachgelagerten Fachanwendung aufbereitet und der Serviceaufruf selbst durchgeführt.
Wichtig in diesem Fall ist, dass es nach Zielarchitektur keine Transaktionen über Serviceaufrufe hinweg gibt.

In diesem Abschnitt wird die Behandlung von Transaktionen innerhalb einer Anwendung beschrieben.
Grundregel dabei ist, dass die Komponente GUI die Transaktion steuert.
Dabei muss die Komponente GUI die Brücke schlagen zwischen der _fachlichen Transaktion_, die dem Nutzer dargestellt wird und der _technischen Transaktion,_ die in der Datenbank abgebildet wird.

Die fachliche Transaktion entspricht einem Dialogablauf.
Ein Beispiel dafür: Der Nutzer kann in der Regel über mehrere Masken hinweg Daten eingeben.
Abschließend drückt er in ein Dialog den „OK“- bzw.
den „Abbrechen“-Button.
Für den Nutzer ist klar, dass alle die von ihm eingegebenen Daten im Sinne einer Transaktion behandelt werden müssen, d. h. sie werden entweder vom System komplett übernommen oder komplett verworfen.

Aus technischer Sicht ist die Behandlung dieses Ablaufs etwas komplizierter: Die Daten, die der Nutzer in den verschiedenen Dialogen eingibt, müssen zunächst zwischengespeichert werden, bevor dann bei Betätigung eines Buttons die technische Transaktion in der Datenbank erfolgt.
Das Zwischenspeichern der Werte benötigt allerdings ebenfalls technische Transaktionen.
Da der Prozess der Web-Anwendung zustandslos ist, muss das Zwischenspeichern ebenfalls in der Datenbank erfolgen.
Hier muss die GUI zusätzliche Transaktionen durchführen.

Bei der Spring Web Flow Integration wurde ein Mechanismus verwendet, um die Zwischenwerte und Informationen zum Dialogablauf in der Datenbank abzulegen.
Das Zwischenspeichern erfolgt grundsätzlich in einer separaten Transaktion.
Somit beeinflussen sich die fachliche Transaktion und die technischen Transaktionen nicht.

Mit den technischen Transaktionen ist es jetzt möglich, „Sitzungen“ abzubilden.
Eine Sitzung ist letztendlich die Summe aller Zwischendaten, die der Nutzer eingegeben hat oder die das System selbst erzeugt hat, wie z. B. interne Zustände, Nutzerinformationen, etc.
Innerhalb einer Sitzung werden mehrere fachliche Transaktionen durchgeführt.

Das technische Mittel zur Repräsentation einer Sitzung ist zunächst einmal die Session des Servers.
Diese Session ist transient.
Da der Serverprozess zustandslos ist, muss sie in der Datenbank persistiert werden.
Dazu gibt es zwei Alternativen:

* Serialisierung der Session nach Beendigung des Request und Wiederherstellung bei neuerlichem Aufruf
* Speichern des Spring Web Flow State an den durch Spring Web Flow vorgesehenen Hooks

Die Variante der Session Serialisierung ist zwar einfacher, beinhaltet aber auch eine wesentliche Gefahr.
Die Session des Servers wird zum Speichern von verschiedensten Daten genutzt, der Zugriff auf sie ist frei möglich.
Dies führt in der Praxis dazu, dass unkontrolliert große Datenmengen in der Session abgelegt werden.
Diese großen Datenmengen lassen sich dann nicht mehr effizient persistieren.
Daher wurde diese Option in <<IsyFactReferenzarchitektur>> ausgeschlossen.
Die Details dazu, wie in Spring Web Flow die zu speichernden Daten einer Session ermittelt werden, finden sich
in Kapitel <<session-behandlung>>.

[[jquery]]
== JQuery

JQuery ist ein JavaScript-Framework, das auf einfache Weise JavaScript-Funktionen bereitstellt,
die insbesondere auf die grafische Gestaltung einer Oberfläche benötigt werden.
Die JavaScript-Datei, die diese Funktionen enthält wird im folgenden JQuery-Bibliothek genannt.

Die Homepage jquery.com bietet die Möglichkeit Module individuell zusammenzustellen, so dass nur die
benötigten Funktionen zur Verfügung stehen.
Für die IsyFact wurde eine Auswahl der nutzbaren Module zusammengestellt.

Erklärtes Ziel ist es, die Oberfläche durch den Einsatz von JavaScript eleganter nutzbar zu machen.
Besonderer Fokus liegt dabei auf den Sicherheitsaspekten, die eine Aktivierung von JavaScript mit sich bringt.
Die Oberfläche muss jedoch auch mit deaktiviertem JavaScript mit Komforteinschränkungen nutzbar sein.

JQuery ist modular aufgebaut. Folgende Module dürfen eingesetzt werden:

NOTE: Fertige jQuery-Pakete inkl. Stylesheet sollten in <<IsyFactJQuery>> abgelegt sein. Sie werden jedoch nicht als
Teil der IsyFact ausgeliefert.

* jquery-core (Kernfunktionalität zur DOM-Manipulation)
* jquery-effects (Ein- und Ausblendfunktionalität)
* jqueryui-datepicker (Kalender-Widget)
* jquery-validation-plugin (Datenvalidierung)

Die Module jquery-data und jquery-ajax werden explizit nicht gesetzt, da AJAX-Funktionalität im Hinblick auf die eingesetzte Seitenlogik mit Spring-Web Flow nicht angeboten werden soll.

[[bootstrap]]
== Bootstrap

Bootstrap ist ein Open-Source CSS Framework, welches im Web sehr weit verbreitet ist.
Es bietet z.B. Funktionalitäten für das Layouting, Scaffolding und kann dynamisch auf die vorgegebene
Fenstergröße reagieren (Responsive CSS).

Über eine ergänzende JavaScript Bibliothek (welche selbst wiederum JQuery nutzt), stellt das Framework
auch Komponenten wie Navigations-Menüs und Dropdowns zur Verfügung.

[[architektur]]
= Architektur

Im Folgenden soll eine grobe Übersicht über die Zusammenhänge der Web-GUI-Architektur und deren Einbettung
in die Referenzarchitektur der IsyFact gegeben sowie die grundlegende Architektur der GUI-Komponenten erläutert werden.

[[referenzarchitektur-einer-fachanwendung]]
== Referenzarchitektur einer Fachanwendung

Das Nutzungskonzept für das Web-GUI nimmt Bezug auf die in der Referenzarchitektur vorgegebenen Schichten
und Komponenten einer IsyFact-konformen Fachanwendung.

:desc-image-RAFachAnw: Referenzarchitektur einer Fachanwendung
[id="image-RAFachAnw",reftext="{figure-caption} {counter:figures}"]
.{desc-image-RAFachAnw}
image::IFRefArcITSysGUI.png[align="center"]

Die Schicht der Nutzung ist eine Erweiterung der klassischen 3-Schichten Architektur, in der die oberste
Schicht in GUI, Batch und Service differenziert wird.

Das vorliegende Dokument beschreibt die Ausgestaltung der Komponente „GUI“. Aufgabe der GUI ist es, die
Funktionalität der Anwendung für einen menschlichen Nutzer zur Verfügung zu stellen.
Dazu stellt sie die benötigten Dialoge und Masken bereit.

Die GUI ist untergliedert in ein GUI-Framework (verwendet wird JSF mit Spring Web Flow) und die Dialoglogik,
welche die für den Anwendungsfall notwendigen Anforderungen umsetzt (s. <<IsyFactReferenzarchitektur>>).

[[grundprinzipien-der-web-gui]]
== Grundprinzipien der Web-GUI

Die Architektur der GUI ist durch die Eigenschaften der eingesetzten Frameworks JSF und Spring Web Flow weitgehend vorgegeben.
Darin sind diese grundlegenden Prinzipien enthalten:

* Nutzung des MVC-Patterns
* Trennung des Dialogs in Dialogsteuerung und Präsentation
* Dialogsteuerung über das Spring Web Flow Framework
* Bildung von gekapselten GUI-Komponenten
* Präsentation über JSF und Facelets
* Verwaltung von Nutzer Sessions über Spring Web Flow
* Interaktive Oberflächenelemente mit JQuery und JQueryUI

[[integration-mit-dem-framework-spring-web-flow]]
== Integration mit dem Framework Spring Web Flow

<<image-IntvSpringSWF>> zeigt die Komponenten für die Web-GUI und die Integration mit dem Framework Spring Web Flow.

:desc-image-IntvSpringSWF: Integration von Spring bzw. Spring-Web-Flow
[id="image-IntvSpringSWF",reftext="{figure-caption} {counter:figures}"]
.{desc-image-IntvSpringSWF}
image::IntvSpringSWF.png[align="center"]

Durch den Programmierer einer GUI sind die gelb hervorgehobenen Teile bereitzustellen (die anderen Bestandteile
werden durch das Framework bereitgestellt).

* Konfiguration des Dialogablaufs als Flow in Form von XML-Dateien
* Model und Controller-Beans zur Datenhaltung und für GUI-Logik
* Visualisierung durch Facelets in XHTML-Dateien

[[gui-komponenten]]
== GUI-Komponenten

Zur Strukturierung von Masken und zugehöriger Funktionalität verwenden wir ein einheitliches Muster zum Aufbau
von GUI-Komponenten.
Neben der Anwendung des MVC-Pattern mittels der oben beschriebenen Web-Technologien (Spring Web Flow, JSF)
definiert es zusätzlich Regeln, die eine Kapselung -, einen einheitlichen Aufbau und eine einheitliche Interaktion
von GUI-Komponenten ermöglicht.

Die Fachkomponenten einer Anwendung ergeben sich aus der Systemspezifikation.
Diese werden auf der Ebene Persistenz, Anwendungskern und GUI implementiert (siehe <<image-RAFachAnw>>). Auf Ebene der
GUI sprechen wir von GUI-Komponenten (siehe <<image-KompDiazuGUI>>).

Die GUI-Komponenten umfassen für jeden Dialog eine Subkomponente.
Jeder Dialog aus der Systemspezifikation ist also ebenfalls eine eigene Komponente.

:desc-image-KompDiazuGUI: Komposition von Dialogen zu GUI-Komponenten
[id="image-KompDiazuGUI",reftext="{figure-caption} {counter:figures}"]
.{desc-image-KompDiazuGUI}
image::KompDiazuGUI.png[align="center",pdfwidth=80%,width=80%]

Die Dialog-Komponenten einer GUI-Komponente können einen gemeinsamen AWK-Wrapper und in ihren Modellen
gemeinsame Datenobjekte verwenden.
Trotzdem sind die Dialog-Komponenten zu kapseln, d.h. Controller- und Model Beans dürfen nicht gemeinsam
verwendet werden (siehe <<image-IntGUIKompGUISub>>).

:desc-image-IntGUIKompGUISub: Innensicht einer GUI-Komponente mit ihren GUI-Sub-Komponenten
[id="image-IntGUIKompGUISub",reftext="{figure-caption} {counter:figures}"]
.{desc-image-IntGUIKompGUISub}
image::IntGUIKompGUISub.png[align="center"]

Zentral ist also die Forderung, dass die Elemente jeder GUI-Komponente (Flow, Controller, View und Model)
in definierter Weise ausschließlich untereinander kommunizieren und Zugriffe auf Elemente anderer
Komponenten unterbleiben.
<<image-CommMVCinGUI>> zeigt die Abhängigkeits­beziehungen innerhalb einer GUI-(Sub-)Komponente.

:desc-image-CommMVCinGUI: Kommunikation von View, Controller und Model innerhalb einer GUI-Komponente
[id="image-CommMVCinGUI",reftext="{figure-caption} {counter:figures}"]
.{desc-image-CommMVCinGUI}
image::CommMVCinGUI.png[align="center"]

[[flow-als-zentraler-controller]]
=== Flow als zentraler Controller

Jede GUI-Komponente wird durch einen Flow beschrieben.
Dieser definiert das Zustandsmodell der Komponente und hat die Funktion des zentralen Controllers für diese Komponente.
Er erfüllt die folgenden Aufgaben:

* Erzeugung und Verwaltung eines (ggf. auch mehrerer) Model Beans
* Definition des Flow-Ablaufs in Form eines Zustandsautomaten mit Zuständen und Zustandsübergängen (Flow, Subflows, Decision-States, Action-States, Event-Handlers)
* Anbinden des Views
* Steuerung der Verarbeitung im Rahmen von Zustandsübergängen

Der Flow-Aufbau wird so gestaltet, dass im Flow alle Zustände, Zustandsübergänge sowie Aufrufe von Verarbeitungslogik zentral gebündelt werden und Ablauf und Verhalten des Flows für den Entwickler klar nachvollziehbar sind.

Der Flow wird als XML-Datei im Ordner der Komponente hinterlegt.

[[controller-bean]]
=== Controller-Bean

Das Controller-Bean ist ein vom Komponenten-Flow aufzurufendes *zustandsloses* Spring Bean,
welches Änderungen an den Daten des Models vornimmt oder diese aufbereitet bzw.
Services des Anwendungskern-Wrappers aufruft.
Das Model Bean wird dem Controller mit jedem Aufruf übergeben.

[IMPORTANT]
====
*Architekturkonvention*

Die Implementierung des Controllers ist zustandslos und stellt nur Methoden bereit.
====

Das Controller-Bean wird im Spring IoC-Container mit Singleton Scope erzeugt und konfiguriert.

Das Controller-Bean wird vom Flow per Expression-Language aufgerufen.
In bestimmten Fällen (siehe Abschnitt <<view544>>) wird ein Controller-Bean auch in einer Action (oder ActionListener) des
Komponenten-View aufgerufen.

[[model-bean]]
=== Model Bean

Das Model Bean ist ein Datenobjekt (einfaches POJO) und hält die Daten einer GUI-Komponente.
Es hat keine Abhängigkeiten zu View, Controller oder Anwendungskern und enthält im Regelfall keine Logik.
Das Model Bean wird durch den Flow erzeugt (durch Definition einer Web Flow-Variablen) und ist somit automatisch im View sichtbar.

:desc-listing-CreaModinFlow: Erzeugung einer Model-Instanz im Flow
[id="listing-CreaModinFlow",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-CreaModinFlow}
[source,xml]
----
<flow ...">
  <!-- Erzeuge das Model zur Benutzung durch diesen Flow. -->
  <var name="erstellenModel"
  class="de.msg.terminfindung.gui.terminfindung.erstellen.ErstellenModel" />
----

Der View liest die Daten zur Präsentation der Webseite aus dem Model Bean.
Dies können Informationen zur Ansicht aber auch änderbare Formularinhalte sein.
Werden Formularinhalte in Form eines Post-Requests auf den Server gesendet, so sorgt JSF eigenständig dafür, dass die Formularinhalte in das Model Bean rückübertragen werden.

Da das Model Bean durch den Flow erzeugt wird und Flow Scope besitzt, wird es automatisch mit in die Session-Persistierung einbezogen.
Dazu muss das Model das Interface Serializable implementieren.
Die Daten des Models werden bei den Dialogschritten eines Flow zwischen Client (Browser) und Server transparent für den Entwickler abgeglichen.

Das Model Bean ist nicht mit den JPA-Datenobjekten verbunden.
Das Schreiben in das Model bewirkt also zunächst keine Änderung in der Datenbank.
Die Persistenz fachlicher Datenobjekte wird über das Controller-Bean ausgelöst, welches über Methodenaufrufe des Anwendungskern-Wrappers fachliche Daten persistiert.

Die Verwendung von Model Beans wird im Verlauf dieses Dokuments noch genauer beschrieben.

[[view544]]
=== View

Der Komponenten-View präsentiert die Daten der Anwendung in Form von generierten HTML-Seiten.
Dazu werden ein oder mehrere Facelets verwendet, die mittels JSF-HTML-Tags auf das Model Bean der Komponente
zugreifen, um die Daten in den View einzubinden.
Da das Model Bean seine Datenzugriffsmethoden nach dem Bean-Standard (`get`/`set`/`is`) anbietet, kann mittels
 Value-Expressions (z.B. `#{teilnehmenModel.terminfindung.tage}`) direkt auf Eigenschaften des Model Beans und
 enthaltener Objekte zugegriffen werden.
Ein View kann auch auf mehrere zum Flow gehörende Model Beans zugreifen.

Im View können Actions definiert sein (z.B. Submit durch einen Command-Button). Dabei werden nur Action-Tokens
(String, der die Aktion benennt) übergeben, die dann im Flow entgegengenommen werden und dann Methodenaufrufe auf dem Controller auslösen.

[IMPORTANT]
====
*Architekturkonvention*

Aus einer Aktion des Views sollte i.d.R. immer ein Zustandstoken zur Steuerung von Transitionen im Flow erzeugt werden.
Dies ist vor allem bei Maskenübergängen und fachlichen Aktionen zu verwenden. +
*Beispiel:* Suche in einem Formular, Öffnen der Detailansicht.

Aktionen, welche zur Steuerung der Darstellung innerhalb einer Maske verwendet werden, müssen nicht zwingend eine Transition auslösen.
In diesen Fällen darf der Controller direkt aufgerufen werden. +
*Beispiel:* Selektion eines Elements und darauf basierende Anpassung der Maske.
====

Die Erstellung von Views wird im Verlauf dieses Dokuments noch genauer beschrieben.

[[jquery-1]]
=== JQuery

Die oben beschriebene JQuery-Bibliothek wird im Seitenrahmen eingebunden.
Sollen nun in einem View interaktive Elemente aktiviert werden, wird eine JavaScript-Datei mit dem Namen des Views benötigt und am Seitenende (Ende des Templates) eingebunden.

:desc-listing-BindViewspezJS: Einbindung View-spezifischer JS-Dateien
[id="listing-BindViewspezJS",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-BindViewspezJS}
[source,xml]
----
<script type=“text/javascript“
src="#{facesContext.externalContext.requestContextPath}/js/vorgangSuchen.js">
</script>
----

Diese Datei enthält die benötigten JavaScript-Befehle zum Erzeugen von UI-Elementen oder zum Binden von Events an bestehende Fragmente.
Von inline-JavaScript ist in jedem Fall abzusehen.

Beim Einbinden sind niemals relative Pfade zu verwenden, um die Same-Origin-Policy zu forcieren.
Zusätzlich sorgt, das script-Tag dafür, dass im Fall von deaktiviertem JavaScript kein Fehler auftritt und die
 XHTML-Konformität erhalten bleibt.

Folgende Abbildung zeigt ein Beispiel für eine Java-Script-Datei „vorgangSuchen.js“, welche ein GUI-Element mit
der ID „Geburtsdatum“ fokussiert:

:desc-listing-BspJSDat: Beispiel für eine JavaScript-Datei
[id="listing-BspJSDat",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-BspJSDat}
[source,javascript]
----
(function(){

  $('#Geburtsdatum').focus();

})()
----

[[zugriff-auf-anwendungskern]]
=== Zugriff auf Anwendungskern

In einer GUI-Komponente werden grundsätzlich keine Klassen des AWK verwendet.
Stattdessen wird vom Controller-Bean der Komponente (und nur von diesem) auf den zur GUI-Komponente gehörenden Anwendungskern-Wrapper zugegriffen, der den Anwendungskern aufruft.
In den Models der GUI-Komponenten werden eigene Datentypen und nicht die des Anwendungskerns verwendet.
Die Aufgabe des AWK-Wrappers ist die Daten vom Anwendungskern in die der GUI zu mappen.

Die Transaktionssteuerung findet im AWK-Wrapper per Annotationen an der Wrapperklasse statt.

:desc-listing-DeklTransverhaltAWKWrap: Deklaration des Transaktionsverhaltens am AWK-Wrapper
[id="listing-DeklTransverhaltAWKWrap",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-DeklTransverhaltAWKWrap}
[source,java]
----
@Transactional(rollbackFor = Throwable.class, propagation=Propagation.REQUIRED)
public class AwkWrapperImpl implements AwkWrapper {
----

Damit die Persistierung funktioniert, müssen die AWK-Wrapper-Beans im selben Spring-Applikationskontext wie der
Anwendungskern definiert werden, damit der Transaktionskontext aus der Hibernate-Konfiguration nutzbar ist.

[[schnittstellen-zwischen-komponenten]]
=== Schnittstellen zwischen Komponenten

Ein Grundprinzip der Architektur der GUI-Komponenten ist die Kapselung aller Komponenten.
Ein View oder Controller einer GUI-Komponente darf daher nicht auf das Model (oder das Controller-Bean) einer anderen GUI-Komponente zugreifen.
Der Austausch von Informationen erfolgt stattdessen über Input/Output-Elemente im Flow, die aus dem Model einer GUI-Komponente gelesen oder geschrieben werden.

Ist ein Subflow B mit Daten aus dem aufrufenden Flow A zu versorgen, so bekommt dieser nicht das Model Bean A, sondern eine Kopie eines einzelnen Objekts (kann auch eine Datenstruktur, aber niemals das gesamte Model A sein) aus A übergeben.
Es ist wichtig, dass eine Kopie übergeben wird, damit Flow B nicht Teile des Model Beans A absichtlich oder versehentlich ändert.

Besteht Bedarf, dass ein Subflow B an den aufrufenden Flow A Daten zurückgibt, so erfolgt dies über ein Output-Element.
Hier gilt analog, dass nicht das gesamte Model Bean B, sondern lediglich Einzelwerte (Kopie) übergeben werden.

Das folgende Beispiel zeigt wie ein Flow an einen Subflow Parameter übergibt und von diesem einen Ausgabewert empfängt.

:desc-listing-InfoExFaufF1: Informationsaustausch zwischen Flows – aufrufender Flow
[id="listing-InfoExFaufF1",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-InfoExFaufF1}
[source,xml]
----
<subflow-state id="loeschenViewState" subflow="loeschenFlow">
  <input name="terminfindung"
         value="verwaltenController.kopiereTerminfindungModel()"/>
  <output name="loeschenTerminfindung"/>
  <transition on="finished" to="verwaltenViewState">
    <evaluate expression="verwaltenModel.setTerminfindung(loeschenTerminfindung)"/>
  </transition>
</subflow-state>
----

Innerhalb des Subflows werden übergebene Parameter entgegengenommen und verarbeitet.
Im Endzustand wird ein Rückgabewert zurückgegeben.

:desc-listing-InfoExFaufF2: Informationsaustausch zwischen Flows – aufgerufener Flow
[id="listing-InfoExFaufF2",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-InfoExFaufF2}
[source,xml]
----
<input name="terminfindung" type="de.msg.terminfindung.gui.terminfindung.model.TerminfindungModel"/>
<on-start>
  <evaluate expression="loeschenModel.setTerminfindung(terminfindung)"/>
</on-start>
<view-state id="loeschenViewState">
  <on-entry>
    <evaluate expression="loeschenController.setzeAuswahlZurueck(loeschenModel)"/>
  </on-entry>
  <transition on="cancel" to="finished"/>
  <transition on="delete" to="loeschenViewState">
    <evaluate expression="loeschenController.loescheZeitraeume(loeschenModel)"/>
  </transition>
</view-state>

<end-state id="finished">
  <output name="loeschenTerminfindung"
          value="loeschenModel.getTerminfindung()"/>
</end-state>
----

Zur Datenübergabe können auch mehrere Input und mehrere Output-Elemente verwendet werden.

Für die Steuerung des Vorgabelayouts (z.B. Menüleiste, Linksnavigation) sowie der Nutzung von vorgegebenen Funktionen (z.B. Validierung) werden auch querschnittliche Controller mit zugehörigen Models verwendet.
Die Instanziierung übernimmt dabei ein übergeordneter Parent-Flow.
So kann z.B. die Seitentoolbar ausgeblendet oder ein Quicklink hinzugefügt werden.

Der Aufruf dieser Controller zur Steuerung des Verhaltens ist erlaubt.
Auf die Controller kann per Spring zugegriffen werden.
Welche Controller im Detail für das Vorgabelayout verfügbar sind, wird in <<Styleguide>> aufgelistet.

[[packaging-und-namenskonventionen]]
=== Packaging und Namenskonventionen

Ein nicht zu vernachlässigender Aspekt zur Komponentenbildung ist die Paketierung, durch die zu einer
Komponente gehörende Elemente gruppiert abgelegt werden.
Alle Elemente werden in einem Paket mit einheitlichem Paketnamen abgelegt.

Für die Namenskonvention zu Java-Klassen und Paketen wird hier auf das Dokument <<JavaProgrammierkonventionen>> verwiesen.
Zusätzlich gelten die folgenden Konventionen:

* Jede GUI-Komponente hat einen Namen.
Die Namen richten sich nach den fachlichen Komponenten bzw. Dialogen.
* Das Paket, in dem die GUI-Komponente abgelegt wird, trägt den vollständig kleingeschriebenen Namen der
GUI-(Sub-)Komponente (z.B. `erstellen`). Jede GUI-Komponente nutzt zwei Ablageorte:
** `java/de/…/gui/terminfindung/erstellen/...` für Java-Klassen
** `WEB-INF/gui/terminfindung/erstellen/...` für Flows und Views
* Model Bean-Klassen tragen den Namen der GUI-Komponente und enden auf Model (z.B. `ErstellenModel`).
* Controller Bean-Klassen tragen den Namen der GUI-Komponente und enden auf Controller (z.B. `ErstellenController`).
* Flows tragen den Namen der GUI-Komponente und enden auf Flow.xml (z.B. `erstellenFlow.xml`).
* Der Main-View, der dem Flow-View-State zugeordnet ist endet auf `ViewState` (z.B. `erstellenViewState.xhtml`).
Besteht der Flow aus mehreren View-States, so wird eine Schritt-Nummer angehängt (z.B. `erstellenViewState1.xhtml`).
* Alle weiteren für den View verwendeten Facelets tragen den Namen der Komponente und eine Charakterisierung
des Facelets (z.B. `erstellenFormular.xhtml`). Auch hier ist eine Schrittnummer anzuhängen, wenn der Flow mehrere View-States enthält (z.B. erstellenFormular1.xhtml).
* Die bei einem View-State verwendete JavaScript-Datei trägt den Namen des View-States (z.B. `erstellenFormular1.js`).
Gibt es View-übergreifende Funktionalität kann diese in eine wiederverwendbare
JavaScript-Datei ausgelagert werden (z.B. `erstellenForumlar.js`).

Im folgenden Abschnitt ist die Benennung der Elemente auch noch einmal in Form der Projektdateistruktur
nachvollziehbar dargestellt.

[[projekt-verzeichnis-einer-fachanwendung-mit-gui]]
=== Projekt-Verzeichnis einer Fachanwendung mit GUI

Nachfolgend ist in <<image-VerzBspErstellen>> der Verzeichnisbaum der Beispiel-Implementierung (insbesondere die GUI-Komponente
`Erstellen`) dargestellt, in dem zu sehen ist, wie die Elemente der GUI im Dateisystem abgelegt werden.

:desc-image-VerzBspErstellen: Verzeichnisstruktur am Beispiel Erstellen
[id="image-VerzBspErstellen",reftext="{figure-caption} {counter:figures}"]
.{desc-image-VerzBspErstellen}
image::bspstructmit.png[align="center"]

////
Projekt Terminfindung
Java Quellcode
Java Quellcode für GUI
AwkWrapper für die CD-Verwaltung
GUI-Sub-Komponenten (Dialoge) der Terminfindung
_Erstellen_ mit Controller und Model Bean
Ressourcen (Spring / Texte)
Stylesheet
Grafiken
JavaScript
GUI-Komponenten der Anwendung
GUI-Komponente _Erstellen_
_Erstellen_ mit Flow und View
Web/Web Flow/JSF Konfiguration
////

[[umsetzen-der-web-gui-einer-isyfact-anwendung]]
= Umsetzen der Web-GUI einer IsyFact-Anwendung

[[benoetigte-bibliotheken]]
== Benötigte Bibliotheken

Für die Erstellung von Weboberflächen existieren Vorgaben in Form eines <<Styleguide,Styleguides>>.
Der Styleguide legt Anforderungen an die Gestaltung und Nutzbarkeit von Oberflächen fest.
Die zugehörige Bibliothek `isy-style` enthält die CSS-, JavaScript- und Bilddateien des Styleguides zur produktiven Nutzung aufbereitet.

Die CSS-Dateien für eine zum Styleguide konforme Anwendung werden bei Nutzung der Bibliothek `isy-style` automatisch geladen und eingebunden. Zur anwendungsspezifischen Anpassung der Stylesheets dienen folgende, innerhalb der Anwendung liegende, Dateien:

* `/css/custom-styles.css` - Spezielle CSS Klassen für die Anwendung,
* `/css/custom-print.css` - Spezielle CSS Klassen für die Druckansicht der Anwendung.

Die Bibliothek `isy-web` enthält notwendige Abhängigkeiten, Spring-Konfigurationen, JSF-Komponenten (Composite Components) sowie zugehörige JSF-Templates (.xhtml) und setzt die Vorgaben des Styleguides durch Verwendung der Bibliothek `isy-style` um.
Sie wird über eine Maven-Abhängigkeit eingebunden. Bei Verwendung des IsyFact-BOMs wird die Version automatisch ermittelt:

:desc-listing-jsfMavenIsy: Einbindung der Bibliothek isy-web in Maven
[id="listing-jsfMavenIsy",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-jsfMavenIsy}
[source, xml]
----
<dependency>
   <groupId>de.bund.bva.isyfact</groupId>
   <artifactId>isy-web</artifactId>
</dependency>
----

Eine explizite Abhängigkeit zur Bibliothek `isy-style` ist in der Regel nicht nötig, da sie implizit mit eingebunden wird.

[[erstellung-einer-gui-komponente]]
== Erstellung einer GUI-Komponente

Die folgenden Abschnitte erklären, wie eine GUI-Komponente nach dem MVC-Muster, mit der Erweiterung um Flows, mit der Bibliothek `isy-web` erstellt wird.


[[der-flow]]
=== Erstellung der Flows

Für eine GUI-Komponente wird zunächst die Definition des Flow als XML-Datei erstellt.
Spring Web Flow sucht und findet den Flow selbständig und nimmt ihn in die Flow-Registry auf.

Je nach Seitentyp muss entweder der `detailseiteParentFlow` oder der `applikationseiteParentFlow` als Parent-Flow angegeben werden.
Die Definition des Parent-Flows muss mit der Wahl der Parent-View (s. <<der-view>>) aller Views des Flows einhergehen, da Applikations- und Detailseiten unterschiedliche Anforderungen an die Darstellung besitzen.
Das Model wird als Variable definiert und damit im Flow erzeugt (hier: `auskunftModel`).
Im Tag `on-start` wird, falls nötig, der Controller aufgerufen, um das Model zu initialisieren.

:desc-listing-bspFlowDatei: Beispiel einer Flow Datei
[id="listing-bspFlowDatei",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-bspFlowDatei}
[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<flow
  xmlns="http://www.springframework.org/schema/webflow"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/webflow
	  http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
  parent="applikationseiteParentFlow"
  abstract="true">

  <!-- Absichern des Flows. -->
  <secured attributes="Auskunft_Nutzen" />

  <!-- Erzeugung der UI-Models. -->
  <var name="auskunftModel" class="de.packagepfad.AuskunftModel" />
  <var name="abcModel" class="de.packagepfad.MeldungWizardModel" />

  <!-- Initialisieren des auskunftModels. -->
  <on-start>
    <evaluate expression="auskunftController.setzeStartseite(auskunftModel)"/>
    <evaluate expression="auskunftController.initModel(auskunftModel)"/>
    <evaluate expression="basisModel.toolbarModel.setAnzeigen(true)"/>
  </on-start>

  <view-state id="auskunftViewState" model="auskunftModel">
    <on-render>
      <evaluate expression="auskunftController.initViewState(auskunftModel)" />
    </on-render>

    <!-- Die verschiedenen Suchen -->
    <transition on="sucheAbc" to="_abcsuche">
      <evaluate expression="auskunftController.fuehreAuskunftDurch(auskunftModel)" />
    </transition>
    <transition on="sucheAbc" to="_abcsuche">
      <evaluate expression="..." />
    </transition>
    ...

  </view-state>
</flow>
----

Charakteristisch sind hier die folgenden Elemente:

*Flow-Tag*: Deklariert alle verwendeten Taglibs und Namespaces sowie den Parent Flow.
Dieser enthält anwendungsübergreifend einheitliche Vorgaben zu global gültigen Regeln, Fehler-Handler und Layoutkonfigurationen.

*Flow Model*: Definition des Models unter Angabe der Model-Bean-Klasse als Flow-Variable.

*On-Start-Handler*: Das Model sollte immer über die standardisierte Initialisierungsmethode beim Starten des Flows initialisiert werden.
Weiterhin können weitere, spezifische Methoden aufgerufen werden, um z.B. Eingabeparameter in das Model einzuarbeiten.

*View States*: Definieren die Zustände des Flows.
Der Name des View-State verknüpft die Komponente auch mit dem gleichnamigen View (z.B. `auskunftViewState.xhtml`), der automatisch beim Rendern aufgerufen wird.
Falls die Komponente mehrere Views (z.B. aufeinanderfolgende Eingabemasken zu einem zu erfassenden Datentyp) verwaltet, enthält die Flow-Definition weitere View-States.
Für jeden View-State kann ein `on-entry`-Handler definiert werden.

*Transitionen*: Für jeden View-State werden die ausgehenden Transitionen im Sinne eines Zustandsautomaten definiert.
Für jede Transition wird ein Zielzustand festgelegt. Diese können sein:

* der eigene View-State (zur Aktualisierung des Views),
* ein untergeordneter Subflow (führt zur Anzeige einer anderen GUI-Komponente, nach Ausführung des Subflows
kehrt die Anwendung in den aktuellen Flow zurück),
* ein Action-State oder ein Decision-State, in denen der Flow entweder Aktionen (z.B. Aufrufe des
Anwendungskerns) oder Entscheidungen zum weiteren Flow-Ablauf trifft, oder
* keine Angabe eines Zielzustands: Dadurch verbleibt der Flow im aktuellen View-State.

IMPORTANT: Wenn der Zielzustand dem aktuellen View State entspricht, wird er aktualisiert.
Der vorherige Zustand kann _NICHT_ mehr über den Browser-Back-Button erreicht werden.
Für AJAX-Aufrufe, welche nur einen bestimmten Teil der Seite aktualisieren sollen, darf kein Zielzustand
angegeben werden.

Für jede Transition kann hinterlegt werden, ob die Browser-Historie (für Back Button Handling) zurückgesetzt werden soll.
Kommt man also nach Anzeigen einer Trefferliste über das Löschen eines Eintrags wieder zur Trefferliste, so
sollte die Möglichkeit der Bereinigung der Historie genutzt werden.

*Aufruf von Subflows*: Beim Aufruf von Subflows müssen meist Parameter übergeben werden.
Dazu wird ein Input-Tag verwendet, welches ein Schlüssel/Wertpaar an den Subflow übergibt.
Im Subflow wird der Parameter über ein Input-Tag entgegengenommen und steht dann als Flow-Variable zur Verfügung und sollte im `on-start`-Handler per Controller in das Model übernommen werden.

[IMPORTANT]
====
Um die Kapselung der GUI-Komponenten zu bewahren, ist es wichtig, dass GUI-Komponenten ihre Parameter immer über ein Input-Tag erhalten und nicht frei auf fremde Models und Controller zugreifen.

Bei der Übergabe eines Parameters (z.B. Liste) ist immer eine Kopie der Datenstruktur zu
übergeben, damit Änderungen an der Datenstruktur durch einen Subflow sich nicht auf den aufrufenden
Flow auswirken.
In diesem Sinne ist auch verboten, ein ganzes Model-Bean zu übergeben.
Müssen mehrere Informationen übergeben werden, so können natürlich auch mehrere Input-Parameter
verwendet werden.
====

Auch die Rückgabe von Out-Parametern ist über ein Output-Tag möglich.
Es gelten die gleichen Richtlinien wie bei Input-Parametern.

*Aufruf von Spring-Beans*: An nahezu allen Stellen der Flow-Definition ist der Aufruf von Spring-Beans per `evaluate`-Tag möglich.
Genutzt wird die Möglichkeit ausschließlich zum Aufruf des zustandslosen Controller-Beans – meist unter Bereitstellung des Model-Beans.
Das Ergebnis kann in einer neuen Flow-Variablen hinterlegt werden. Üblicherweise aktualisieren die Aufrufe des Controllers aber direkt das zentrale Flow Model.

CAUTION: Im `evaluate`-Tag wird die Java-Expression-Language verwendet, nicht die deutlich
leistungsfähigere Spring Expression Language!

Flow-Definitionen bietet weitaus mehr Möglichkeiten, die im Regelfall allerdings seltener benötigt und daher hier nicht erläutert werden.

[[der-controller]]
=== Erstellung der Controller

Jede GUI-Komponente verfügt über einen Controller.
Der Controller ist der „verlängerte Arm“ des Flow, denn im Flow darf keine GUI-Logik ausgeführt werden.
Jegliche zu programmierende GUI-Logik wird im Controller in zustandslosen Methoden bereitgestellt.
Typische Methoden im Controller sind:

* Methoden zur Initialisierung des Models,
* Methoden zum Aufruf des Anwendungskerns,
* Methoden zur Aufbereitung von Daten des Models vor dem Rendern.

Der Controller wird in der Spring Konfiguration als einfaches Spring-Bean definiert und ist somit im Flow
automatisch sichtbar und nutzbar. Jeder Controller muss von `AbstractGuiController` erben. Da der Controller zustandslos ist, benötigt jeder Aufruf das zugehörige Model. Der Controller kann auch eine eigene Fehlerbehandlung enthalten. In seltenen Fällen schreibt er selbst Meldungen in
den `FlowRequestContext`, die dann als Fehler- oder Hinweismeldung ausgegeben werden.

Eine Rückgabe von Zielzuständen zur Steuerung des Flow in Methoden des Controllers ist zu vermeiden.
Sinnvoll ist die Rückgabe eines Ergebnistokens (Erfolg oder Fehler), um dann im Flow den Zielzustand festzulegen und anzusteuern.
Solche Entscheidungen können im Flow auch per Action- oder Decision-State umgesetzt werden, wobei im Controller eine Methode `is…` mit Rückgabewert `boolean` verwendet wird.

Die häufig gesehene Umsetzung von einfachen `geheZu`-Methoden des Controllers, die lediglich einen Rückgabewert aus einer Konstanten zurückliefern, erbringt keinen Mehrwert.
Der Wert sollte in diesem Fall direkt in der Flow-Definition festgelegt werden.

[[das-model]]
=== Erstellung der Models

Das Model enthält alle temporären Daten, die ein Flow zur erfolgreichen Durchführung benötigt.
Es wird, wie im <<der-flow,Abschnitt über Flows>> beschrieben, immer durch einen Flow instanziiert und verwaltet.
Ein Model für eine Maske muss von `AbstractMaskenModel` erben.

[[befuellung-eines-models]]
==== Befüllung eines Models

Wie im <<der-controller,Abschnitt über Controller>> beschrieben, wird das Model durch den Controller bei Bedarf initialisiert und mit Daten aus dem Anwendungskern befüllt.
Auch die Aufbereitung von Daten des Models kann durch den Controller erfolgen (alternativ über View-Konverter).
Das Konvertieren von Model-Inhalten durch Logik im Model-Bean soll möglichst vermieden werden.
Insbesondere ist Logik zu vermeiden, bei der Fehler auftreten können.
Ein Model soll vor dem Rendern möglichst alle anzuzeigenden Daten passgenau für das Rendering vorhalten.

[[abgleichen-eines-models]]
==== Abgleichen eines Models

Der Abgleich des Models mit dem View (nach Submit einer Maske) erfolgt automatisch durch JSF.
Alle Seiteninhalte, die beim Rendern aus einem Model gelesen wurden, werden nach dem Submit wieder in das
Model rückübertragen und stehen dann zur weiteren Verarbeitung für den Controller oder erneutes Rendering zur
Verfügung.

[[speichern-der-daten-eines-models]]
==== Speichern der Daten eines Models

Das Model-Bean wird vom Flow im Flow Scope gehalten.
Daher wird die Datenstruktur zwischen den einzelnen Dialogschritten in der Session persistiert (für Details zur Conversation-Persistierung siehe <<spring-web-flow>>).

Für die Ablage im Flow Scope werden die Daten in serialisierter Form abgelegt.
Daher muss das Model-Bean das Interface Serializable implementieren.

Größere Datenmengen beeinträchtigen die Performance der Anwendung zur Laufzeit.
Umso mehr Daten im Model enthalten sind, desto aufwändiger ist die Session-Persistierung.
Daher ist die Menge an gehaltenen Daten auf das Notwendige zu beschränken.
Diejenigen Teile des Models, die nur temporär während der Datenaufbereitung befüllt werden, sollten dringend als `transient` markiert werden, um sie nicht in der Session zu speichern.

TIP: Die Session-Persistierung erfolgt neben den Dialogschritten zusätzlich auch beim Redirect im Rahmen
der Anwendung des Post Redirect Get-Pattern (siehe <<back-button-handling>>).

Die nach einem Submit im Model-Bean gespeicherten (und vom Anwender ggf. veränderten) fachlichen Daten werden nach Validierung in die fachlichen Tabellen der Datenbank übernommen.
Dies erfolgt immer durch einen Controller, der die Daten aus dem Model an den Anwendungskern-Wrapper übergibt.

[[der-view]]
=== Erstellung der Views

[[definition-des-view-state]]
==== Definition des View-State

Jeder View-State in der Flow-Definition der GUI-Komponente ist mit einer eigenen Maske, dem View verknüpft.
Spring Web Flow steuert das Rendering des Views.

Der View einer GUI Komponente ist nach dem Umsetzungsmuster der IsyFact wie folgt aufgebaut: Eine Facelet-Datei dient dazu, die im Seitentemplate (siehe <<Einleitung>>) inkludierte Definition der Seitenbereiche des Inhaltsbereiches zu definieren.
Das Tag `<ui:composition>` referenziert hierbei das Seitentemplate, in welchem die über `<ui:define>`
definierten Teile eingebunden werden.
Die verschiedenen Teile des Seitentemplates finden sich in <<jsf-seitenelemente>>.

Je nach Seitentyp muss entweder

* `/WEB-INF/gui/common/layout/applikationDetailseite.xhtml` oder
* `/WEB-INF/gui/common/layout/applikation.xhtml`

als Template angegeben werden.

Die Templates bieten folgende Schnittstellen über den `ui:define` / `ui:insert` Mechanismus von JSF an:

* *inhaltsbereich*: Der eigentliche Inhaltsbereich der Seite.

* *headIncludes*: Zum Einbinden von weiteren Ressourcen in den HTML Header.

* *script*: Zum Einbinden von seitenspezifischen JavaScript.

* *modalDialogPlaceholder*: Zum Einbinden von modalen Dialogen.

* *printMetaInformation*: Die Stelle um Meta-Informationen für Druckausgaben zu hinterlegen.

* *form*: Zusätzliche Form-Elemente können hier eingebunden werden.
Normalerweise stellt das Layout eine Form bereit.
Für spezifische Anpassungen (z.B. AJAX-Listpicker) müssen jedoch eigene Forms definiert werden.

:desc-listing-jsfViewState: Beispiel für eine JSF ViewState Seite
[id="listing-jsfViewState",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-jsfViewState}
[source,xml]
----
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
   xmlns:ui="http://java.sun.com/jsf/facelets" 
   xmlns:h="http://java.sun.com/jsf/html" 
   xmlns:isy="http://java.sun.com/jsf/composite/isyfact" 
   template="/WEB-INF/gui/common/layout/applikation.xhtml">

   	<!-- UI-Parameter setzen. -->
   	<ui:param name="flowModel" value="${auskunftDurchfuehrenModel}" />
   	<ui:param name="guiController"
   	    value="${auskunftDurchfuehrenController}" />
   	...

   <!-- Form für AJAX-Seiteninhalt definieren -->
   <ui:define name="form">
     <h:form id="listpickerAjaxForm">
        <isy:formListpickerAjaxContent ... />
     </h:form>
    </ui:define>

   <!-- Der Inhaltsbereich (Hauptanwendungsbereich s.a. Styleguide) -->
   <ui:define name="inhaltsbereich">
      ...
      	<ui:include src="./DruckButtonZeile.xhtml" />
      ...
   </ui:define>
</ui:composition>
----

Die Seitenbereiche werden im `ViewState`-Facelet wiederum durch Inklusion auf kleinere Facelets umgesetzt.
Das heißt jeder Seitenbereich (Formular, Buttonzeile) wird per Konvention in einer separaten Datei gepflegt.
Innerhalb dieser Facelets wird im Normalfall nichts mehr inkludiert.

:desc-listing-DruckButtonZeile: Beispiel: Inkludiertes Facelet DruckButtonZeile.xhtml
[id="listing-DruckButtonZeile",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-DruckButtonZeile}
[source,xml]
----
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:isy="http://java.sun.com/jsf/composite/isyfact">

	<!-- Download des PDF geht nur bei ajax='false' -->
	<isy:buttonIcon id="druck_icon"
	   name="#{msg.MEL_Drucken}"
	   icon="print"
	   tooltip="#{msg.MEL_Tooltip_Drucken}"
	   size="large"
	   action="drucken"
	   reverseIconPosition="true"
	   ajax="false">
	</isy:buttonIcon>

</ui:composition>
----


[[rendern-einer-maske-mit-den-daten-eines-models]]
==== Rendern einer Maske mit den Daten eines Models

Der Zugriff auf die Daten des Models erfolgt in den Facelets über die Common Expression Language (EL) <<CommonEL>>.
Das Model ist im View sichtbar, da es im Flow als Flow-Variable deklariert wurde.
Das Model ist zum Zeitpunkt des Renderns bereits mit Daten befüllt, da im `on-entry`-Handler des Flows der
Controller die Befüllung des Models vorgenommen hat.

:desc-listing-DatZuFacelet: Datenzugriff im Facelet
[id="listing-DatZuFacelet",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-DatZuFacelet}
[source,xml]
----
<isy:formInput reference="name"
   value="#{auskunftDurchfuehrenModel.veranstaltungstitel}"
   label="Titel der Veranstaltung"
   required="true"/>
----

Es ist wichtig zu verstehen, dass durch das Rendern der Daten aus dem Model eine Bindung der Model-Property
mit dem GUI-Element (im Beispiel ein Form-Input-Feld) hergestellt wird, welches nach Submit des Webformulars
automatisch durch Spring Web Flow in das Model zurücksynchronisiert wird.
Damit das funktioniert ist eine eindeutige HTML-ID zu vergeben.
Die HTML Elemente erhalten entsprechend ihres Inhaltes den Bezeichner des zugehörigen Attributes.
Würde keine ID vergeben, so würde JSF selbständig eine dynamische ID vergeben.
Das erschwert jedoch den automatischen Test der Oberfläche.

:desc-listing-HTMLIDFace: HTML ID Vergabe
[id="listing-HTMLIDFace",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-HTMLIDFace}
[source,xml]
----
<h:selectOneMenu id="vonZeit"
   value="#{tag.vonZeitraum}"
   converter="calCon">
   value="#{erstellenModel.alleZeitraeume}"
   var="von" itemValue="#{von}" itemLabel="#{von}"
/>
----

Werden versehentlich IDs mehrfach verwendet, so sind Fehler bei der Datenübernahme wahrscheinlich.

[[ausloesen-von-aktivitaeten-in-facelets]]
==== Auslösen von Aktivitäten in Facelets

Die Auslösung von Aktion erfolgt über die Nutzung des `action`-Attributes der verwendeten GUI-Komponenten.
Hier wird ein Token verwendet, welches auch im Flow bekannt ist und die Transition so steuert, dass der Controller die Daten über den Anwendungskern persistiert.

:desc-listing-BSPActions: Beispiele für Actions
[id="listing-BSPActions",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-BSPActions}
[source,xml]
----
<isy:button action="back" value="Zurück"/>
<isy:button action="continue" value="Weiter"/>
----

[[datenkonvertierung-fuer-darstellung-und-eingabe]]
==== Datenkonvertierung für Darstellung und Eingabe

Für die formatierte Darstellung von Daten können JSF-Konverter zur Konvertierung aus der Ansicht ins
typisierte Datenmodell, wie auch zur Umwandlung aus dem Datenmodell in die Ansicht verwendet werden.
Hier bieten sich JSF-Konverter an, die jedoch nur mit Einschränkungen verwendet werden können, da diese
 bei der Konvertierung „freier Eingaben“ nicht mit Fehleingaben umgehen können.

:desc-listing-ConvDatewihConv: Umwandlung eines Datums mittels Konverter
[id="listing-ConvDatewihConv",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-ConvDatewihConv}
[source,xml]
----
<h:inputText id="datum" value="#{erstellenModel.newDate}">
       <f:convertDateTime type="date" />
</h:inputText>
----

Wenn die Validierung in einem JSF-Konverter stattfindet, werden die Daten in einem Fehlerfall nicht ins Modell geschrieben.
Dies führt dazu, dass das Formular zurückgesetzt wird, weil die Seite wegen des PRG-Patterns mit einem GET-Request mit dem alten Modell neu geladen wird.
Die ungültigen Eingaben gehen also zusammen mit allen anderen Änderungen im Modell verloren.
Standard-JSF-Konverter sind also faktisch nicht nutzbar.

Ein geeigneter Konverter muss auch ungültige Daten ins Modell schreiben können.
Wenn dies aufgrund der Nutzung spezieller Datentypen (wie z.B. `Date`) nicht möglich ist, muss im View-Model
 der Datentyp `String` verwendet werden.
Die Konvertierung findet in diesem Fall nicht durch einen Konverter statt, sondern erst nach oder während
der Validierung.

Oft ist es notwendig, im Model Schlüssel eines Schlüsselverzeichnisses zu verwenden.
Dieser sollte in der Regel in der Maske nicht als Schlüssel, sondern in einer verständlichen Form dargestellt werden.
Hier bietet sich der Einsatz eines eigenen Konverters an, der mittels Schlüssel-Wert-Mapping die
Umwandlung je nach Verarbeitungsrichtung leistet.
Analog gilt dies auch für Booleans und Aufzählungstypen.

:desc-listing-ConvEnumwithConv: Umwandlung eines Aufzählungstyps mittels Konverter
[id="listing-ConvEnumwithConv",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-ConvEnumwithConv}
[source,xml]
----
<h:outputText value="#{cdAblageDatenBackBean.interpretMaennlich}">
     <f:converter converterId="geschlechtsTypConverter"/>
</h:outputText>
----

Im Hinblick auf aktiviertes JavaScript darf bei `outputText` niemals das Attribut `escape` auf `false`
gesetzt werden.

[[interaktive-elemente-mit-jquery]]
=== Interaktive Elemente mit JQuery

JQuery ist ein mächtiges Framework zur DOM-Manipulation.
Entsprechend vorsichtig und gezielt sollte der Einsatz gewählt werden.
In der Regel bieten die <<jsf-bedienelemente>> der IsyFact Zugriff auf Visualisierungsformen mittels JavaScript (z.B. Kalenderwidget, Tags, Panels). Für bestimme Zusatzanforderungen (z.B. bedingtes Deaktivieren eines Felds, weitere GUI-Verschönerungen) kann es jedoch notwendig sein zusätzliches JavaScript einzubinden.

Die viewspezifische Funktionalität wird in einer eigenen JavaScript-Datei umgesetzt.

[.underline]#Dabei sind grundsätzlich folgende Regeln zu beachten:#

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: eval() darf nicht verwendet werden.
:: *Begründung*
:: Die Verwendung von eval() stellt ein Sicherheitsrisiko dar. Es besteht die Gefahr, dass Werte aus Request-Parametern ohne ausreichende Prüfung als Code ausgeführt werden.
''''

:: *Lösung*
:: Anstatt Parameter an die eval(...)-Funktion zu übergeben, schreiben Sie eine eigene Parser-Funktion, in der sie sicherstellen können, dass kein Code-Injection Angriff erfolgreich ist.
''''

:: *Negativ-Beispiel*

:: Der Inhalt des Strings `requestValue` wird ohne ausreichende Prüfung ausgeführt.

           var requestValue = getParameterValueForParameter
             (“searchString“);
           eval(requestValue)

:: Dies ermöglicht es jeden beliebigen JavaScript Code per Injektion auf einem Client ausführen zu lassen.
:: Ein Angreifer könnte dann Code auf dem Server wie folgt einschleusen:

           www.mySite.de?searchString=alert(‚hallo‘)

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: setTimeout() darf nicht in der Variante
           aufgerufen werden, die den Code in einer
           Zeichenfolge enthält.
:: *Begründung*
:: Damit wird verhindert, dass ein "Greasemonkey-Skript" (clientseitig laufender Code) ausgeführt wird, mit dem sich der JS-Code manipulieren lässt.
''''

:: *Lösung*
:: Anstatt den Code in einer Zeichenfolge zu übergeben, muss ein function()-Parameter übergeben werden

   setTimeout(function() { ... }, 100)

:: Hierdurch wird kein clientseitig laufender Code ausgeführt.
''''


:: *Negativ-Beispiel*

:: Hier wird der Code unzulässigerweise als Zeichenfolge übergeben.

           setTimeout(“callSomeSpecialFunktion (searchString)“, 100);

:: Ein Angreifer könnte nun eine URL wie folgt aufrufen:

           www.mySite.de?searchString=5);alert(‚hallo‘

:: Der Inhalt der Variable searchString wird im searchString ersetzt, so dass folgender Code ausgeführt würde:

   setTimeout(“callSomeSpecialFunktion(5);alert(“hallo“), 100);

:: Der Angreifer hätte es also geschafft, die Ausführung der Funktion alert(“hallo“) auf dem Server zu veranlassen.

====


====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Sofern keine Wiederverwendung möglich ist, ist von der Definition benannter Funktionen abzusehen und anonyme Funktionen einzusetzen. Dies betrifft im speziellen das Event-Binding

:: *Begründung*
:: Definierte JavaScript-Funktionen sind in der Regel im globalen Variablen-Kontext gültig. Würde für jede Callback-Funktion eine eigene Funktion definiert, würde das den Speicher unnötig belasten. Weiterhin verschlechtert sich die Lesbarkeit.
:: Gerade bei Callbacks ist es nützlich, wenn direkt ersichtlich ist, was passiert, wenn der Callback aufgerufen wird.
''''

:: *Lösung*
:: Ein weiterer Vorteil bei der Verwendung von anonymen Funktionen ist, dass auf Variablen der umgebenen Funktion zugegriffen werden kann, was die Implementierung vereinfacht:

   var einWert=5;
   setTimeout( function {alert(4 + einWert);}, 100);

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Benannte Funktionen sollten in einem Namespace deklariert werden, die eine Zuordnung zu einem View erkennen lässt:

:: *Begründung*
:: Wie bereits beschrieben, gelten Funktionen häufig im globalen Kontext. Funktionsnamen können wie Variablen durch redundante Deklaration leicht versehentlich überschrieben werden. Dann gilt immer die letzte Definition. Die Verwendung des View-Names als „Namespace“ vermeidet, Funktionen aus einem anderen View versehentlich zu „überschreiben“.
''''

:: *Lösung*

   var ns_<view> = { foo : function() { … } }

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Jede JavaScript-Datei beginnt mit einer function()-Definition. Die Deklaration von wiederverwendbaren Funktion- bzw. Namespace-Definitionen muss außerhalb eines function-Blocks erfolgen.


:: *Begründung*
:: Mit diesem Konstrukt wird verhindert, dass (versehentlich) neue Funktions- und Variablen- Definitionen Elemente aus dem globalen Kontext überschreiben.
''''

:: *Lösung*
:: Jede JavaScript Datei beginnt mit

   (function(){

:: und endet mit

   })()

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Inline-JavaScript ist zu vermeiden.


:: *Begründung*
:: Es gibt Fälle, in denen JavaScript „inline“ technisch bedingt direkt in der XHTML-View-Definition implementiert werden muss. Hier besteht die Gefahr, dass der JS-Script-Code schlecht strukturiert und auf zu viele Dateien verteilt wird.
:: Zudem ist JavaScript-Code in XHTML-Dateien unerwartet und wird bei der Analyse der Anwendung schnell übersehen. Insgesamt wird hierdurch die Verständlichkeit und Wartbarkeit der Anwendung verschlechtert.

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Der DOM-Zugriff mit der $-Funktion sollte stets über die Id oder Klasse eines DOM-Knotens erfolgen und nicht über die Knotenhierarchie des DOMs.


:: *Begründung*
:: Die Gefahr beim Negativ-Beispiel ist die Fehleranfälligkeit auf Änderungen in der DOM-Struktur. Wird z.B. ein weiterer Knoten eingefügt, greift die Funktion ggf. nicht und die Anwendung arbeitet fehlerhaft.
''''

:: *Lösung*

   $(„#eineBildID“); // GUT

:: *Negativ-Beispiel*

   $(„div span a img“); // SCHLECHT
====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Event-Binding erfolgt im JavaScript-Code und nicht in den `on<Event>`-Attributen des HTML-Elementes.


:: *Begründung*
:: Das Event-Binding in den `on<Event>`-Attributen erzeugt ein Inline-JavaScript. Inline-JavaScripte sind stets zu vermeiden.

====

====
[horizontal]
*Regel: {nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}{nbsp}*:: Im JavaScript-Code dürfen Request oder URL-Parameter nur nach ausreichendem Encodieren und Escapen verwendet werden. Gleiches gilt für den Einsatz von Server-Parametern bzw. Model-Attributen.


:: *Begründung*
:: Sicherheitsrisiko: Es gilt, die Ausführung von Code (z.B. durch Request-Strings übergeben) auf dem Server zu verhindern.
''''

:: *Negativ-Beispiel*
:: Wird beispielsweise ein Suchstring wie folgt in die Seite eingebunden

   <title>${searchStringFromRequest}</title>

:: dann könnte ein Angreifer folgende URL aufrufen:

  www.mySite.de?searchString=<script>alert(‚halloWelt‘)</script>

:: Der übergebene JavaScript-Block würde dann auf dem Server ausgeführt. Das Escapen „zerstört“ die spitzen Klammern und Hochkommata, so dass kein Code ausgeführt wird.

====


[[clientseitige-validierung-von-eingaben]]
==== Clientseitige Validierung von Eingaben

Zur clientseitigen Validierung von Eingaben wird das jQuery Validation Plugin verwendet.
Die Markierung von Pflichtfeldern und die Definition von eigenen Regeln und Hinweistexten ist im http://blogs.fau.de/webworking/2011/05/13/tutorial-zur-eingabevalidierung-von-formularen-mit-hilfe-von-jquery/[folgenden Blogeintrag] beschrieben.
Der Aufruf erfolgt dabei innerhalb der View-spezifischen JavaScript-Datei über die ID des Formulars: `$("#formular").validate();`

Da JavaScript deaktivierbar und manipulierbar ist, müssen grundsätzlich alle Validierungen auch serverseitig erfolgen.

[[serverseitige-validierung-von-eingaben]]
==== Serverseitige Validierung von Eingaben

Die Validierung und Prüfung der in der GUI erfassten Daten soll entweder vollständig durch die GUI oder aber vollständig im Anwendungskern durchgeführt werden.
Die Validierung in der GUI ist dabei bevorzugt.
In diesem Falle wird der Validierungsmechanismus von Spring Web Flow verwendet.
(Abschnitt 5.10 - Validating a model in <<SWF>>).

Die JSF-Validatoren oder JSF-Konverter sollten für die Validierung aus den im Abschnitt <<datenkonvertierung-fuer-darstellung-und-eingabe>> genannten Gründen nicht verwendet werden.

Sind im Datenmodell Datentyp wie Datum, Zeit oder Zeitpunkt enthalten, und diese auch durch den Benutzer der GUI frei eingebbar, so ist es am einfachsten, im Model ein String-Feld zu verwenden und die Konvertierung und Validierung im selbst programmierten Spring Web Flow-Validator durchzuführen.

[[darstellung-von-fehlern]]
==== Darstellung von Fehlern

Das folgende JSF-Tag `message` kommt zum Einsatz, um einen Fehler für ein bestimmtes Feld anzuzeigen:

:desc-listing-BspFaceletError: Beispiel aus Facelet
[id="listing-BspFaceletError",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-BspFaceletError}
[source,html]
----
<h:message for="isbn" showDetail="false" errorClass="error"/>
----

Das obige JSF Tag markiert das Feld, das die JSF-ID „isbn“ hat, als fehlerhaft, wenn im JSF-Context eine
 Fehlernachricht für die JSF-ID „isbn“ geschrieben wurde.

Für die Darstellung aller Fehlermeldungen kommt das JSF Tag `messages` zum Einsatz.
Hierdurch werden alle Fehler, unabhängig von ihren JSF-IDs, in einer Liste dargestellt:

:desc-listing-DarstError: Darstellung von Fehlermeldungen
[id="listing-DarstError",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-DarstError}
[source,html]
----
<h:messages/>
----

Die Darstellung von Fehlern und Validierungsnachrichten wird auch im Styleguide <<Styleguide>> beschrieben.

[[verwendung-von-jsf-widgets]]
==== Verwendung von JSF Widgets

Für die Arbeit mit JSF werden einige Komponenten/Widgets bereits vorab zur Verfügung gestellt.
Die Widgets sind alle als JSF Composite Components realisiert.
Dadurch ist eine einfachere Wartung möglich, da die Komponenten vollständig in XHTML definiert sind und
ein Grundverständnis von JSF genügt, um Anpassungen vorzunehmen.
Spezielle Renderer oder Java-Klassen werden nicht benötigt.
Details hierzu sind in <<jsf-bedienelemente>> zu finden.

Für die Verwendung der Tags muss in den XHTMLs folgender Namespace eingebunden werden: `xmlns:isy="http://java.sun.com/jsf/composite/isyfact"`

[[einsatz-von-action-listenern]]
==== Einsatz von Action Listenern

Action Listener können dazu verwendet werden, um auf das Klicken eines Buttons oder Links innerhalb einer Seite zu reagieren.

Auf Grund einer Eigenart von JSF in Zusammenhang mit dem Partial-State-Saving muss unbedingt darauf geachtet werden, dass die Komponente (Button/Link), an die der Action Listener gebunden ist, nicht durch den Klick ausgeblendet wird.
Andernfalls führt dies zu Problemen mit dem Loadbalancing.
Hintergrund ist, dass JSF durch das Partial-State-Saving den Maskenzustand teilweise in der Serversession ablegt.
Werden die Anfragen an die Webanwendung durch den Loadbalancer an verschiedene Server verteilt, kann dies daher dazu führen, dass JSF eine Exception wirft, weil der Action Listener der ausgeblendeten Komponente nicht gefunden werden konnte.

[[parameter-mit-buttonlink-uebergeben]]
==== Parameter mit Button/Link übergeben

JSF bietet mehrere Möglichkeiten, einen Parameter in Abhängigkeit eines geklickten Buttons oder Links an
die Webanwendung zu übergeben.
Dies ist beispielsweise dann notwendig, wenn auf einer Maske mehrere Elemente angezeigt werden, zu denen
jeweils ein eigener Button zum Bearbeiten existiert.
In diesem Fall muss es möglich sein zu erkennen, welcher Button zu welchem Element geklickt worden ist.

Die hierfür in JSF 2.x vorgesehenen Lösung mit `f:param` erfordert den Einsatz von JavaScript und kann daher Probleme in der Abwärtskompatibilität hervorbringen (z.B. wenn kein JavaScript aktiviert ist).
Die Umsetzung sollte daher in der Regel mit einem Action Listener stattfinden (siehe <<listing-UseActionListVIEW>>):

:desc-listing-UseActionListVIEW: Verwendung eines Action Listeners (View)
[id="listing-UseActionListVIEW",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-UseActionListVIEW}
[source,html]
----
<h:commandLink id="bearbeite_SV_#{sachverhalt.id}"
   value="#{msg.MEL_Bearbeiten}"
   actionListener="#{listener.waehleSachverhalt}">
    <f:attribute name="sachverhaltId" value="#{sachverhalt.id}" />
    ...
</h:commandLink>
----

Dabei kann in der Methode `waehleSachverhalt` der Wert des Attributs aus der `RequestParameterMap` des `FacesContext` gelesen werden (siehe <<listing-EvalRequestAttr>>).
Beim Einsatz des Action Listeners muss darauf geachtet werden, dass die Komponente (Button/Link), an die der Action Listener gebunden ist, nicht durch den Klick ausgeblendet wird (vgl. Abschnitt <<einsatz-von-action-listenern>>).

:desc-listing-EvalRequestAttr: Auswertung von Request Attributen
[id="listing-EvalRequestAttr",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-EvalRequestAttr}
[source,html]
----
FacesContext.getCurrentInstance().getExternalContext() .getRequestParameterMap().get("sachverhaltId");
----

Als Alternative zum Einsatz eines Action Listeners kann die ID des Buttons/Links parametrisiert und im
Controller ausgewertet werden.
Die Parametrisierung der ID wird ebenfalls in <<listing-UseActionListVIEW>> dargestellt.
Die Auswertung ist in diesem Fall aufwendiger, da alle Attribute der `RequestParameterMap` durchlaufen werden müssen, bis ein Parameter gefunden wurde, dessen ID mit „bearbeite_SV_“ beginnt.
Vorteil der Lösung ist jedoch, dass Probleme mit dem Einsatz von Action Listenern damit umgangen werden.

[[jsf-seitenelemente]]
== JSF Seitenelemente

TIP: Die IsyFact enthält die Demo-Anwendung `isy-webgui`.
Die Anwendung zeigt die Features der Bibliotheken `isy-web` sowie `isy-style` beispielhaft.
Insbesondere demonstriert sie Aussehen und Verhalten der nachfolgend beschriebenen JSF-Seitenelemente.

[[hauptfenster]]
=== Hauptfenster

Das im Styleguide beschriebene Anwendungslayout besteht im allgemeinen aus einem Hauptfenster mit einem Header und einem Inhaltsbereich, dessen Inhalt je nach Seitentyp und Applikation variieren kann.

:desc-image-aufbauapplikationsseite: Aufbau einer Applikationsseite
[id="image-aufbauapplikationsseite",reftext="{figure-caption} {counter:figures}"]
.{desc-image-aufbauapplikationsseite}
image::image57.png[align="center", width="629",height="526"]

*Aufbau*

* Header Bereich
* Linksnavigation (optional)
* Inhaltsbereich


[[header-bereich]]
==== Header Bereich

Der Header Bereich enthält allgemeine Informationen der Applikation.

:desc-image-headersolo: Header
[id="image-headersolo",reftext="{figure-caption} {counter:figures}"]
.{desc-image-headersolo}
image::image36.png[align="center", width="629",height="104"]

:desc-image-aufbaudesheaderbereichs: Aufbau des Header-Bereiches
[id="image-aufbaudesheaderbereichs",reftext="{figure-caption} {counter:figures}"]
.{desc-image-aufbaudesheaderbereichs}
image::image37.png[align="center", width="629",height="149"]


*Aufbau*

* *A* Logo des Portalanbieters
* *B* Farbmarkierung des Applikationsportals
* *C* Logo des Applikationsportals
* *D* Login-Information
* *E + F* Hauptnavigation und Subnavigation als Flyout (siehe Kapitel <<horizontale-navigation>>)


[[headerbereich-bestandteile]]
===== Headerbereich Bestandteile

*_Navigationsleiste und Nutzerbereich_*

Derzeit wird die Navigationsleiste im Header Bereich noch statisch geladen.
Jede Anwendung muss daher die Ressource +
   `/WEB-INF/gui/common/seitenelemente/navigation.xhtml` +
mit einer spezifischen Anpassung überschreiben.


Der Nutzerbereich wird nicht von der `isy-web` zur Verfügung gestellt, da sich z.B. das Verhalten des Logout Buttons in verschiedenen Betriebsumgebungen unterscheiden kann (unterschiedliche HTTP Parameter, etc.). Konkrete Anwendungen müssen über die Konfigurationseinstellung `gui.header.nutzerbereich.xhtml.src` das XHTML angeben, welches den Nutzerbereich definiert.
Die Angabe der Konfiguration ist verpflichtend.

*_Titel_*

Den Titel gibt es nur auf Applikations-Detailseiten (s. Implementierungshinweise dort).


*_Maskentexte_*

Maskentexte, die nur innerhalb eines bestimmten Flows verwendet werden, können in der Konfigurationsdatei <Flow-Name>.properties im Ordner `resources/nachrichten/maskentexte` definiert werden.
Wenn die jeweilige Konfigurationsdatei vorhanden ist, werden die Maskentexte automatisch geladen und in die Variable `msg_currentflow` abgespeichert.
Die Maskentexte des jeweiligen Flows können dann beispielsweise wie folgt ausgelesen werden:

:desc-listing-maskentexteKonfigurierbar: Maskentexte über Konfiguratiosdatei
[id="listing-maskentexteKonfigurierbar",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-maskentexteKonfigurierbar}
[source, xml]
----
<h:outputText value="#{msg_currentflow.MAS_Ueberschrift}" />
----

Auf übergreifende Maskentexte aus der Konfigurationsdatei 
`resources/nachrichten/maskentexte.properties` 
kann über die Variable `msg` zugegriffen werden.


[logos-texte-headerbereich]
===== Logos und Texte im Headerbereich
Es besteht die Möglichkeit, für jeden Flow die folgenden Teile des Seitenrahmens anzupassen:

- Linkes Logo im Header (`gui.header.logo.links.pfad`)
- Rechtes Logo im Header (`gui.header.logo.rechts.pfad`)
- Text unterhalb des rechten Logos im Header (`gui.header.text.logo.rechts`)


Um hiervon Gebrauch zu machen, muss die entsprechende Konfigurationsdatei über die Bean-Definition eingebunden werden:

:desc-listing-anpassung-rahmen-config: Konfigurationsdatei zur Anpassung des Seitenrahmens einbinden
[id="listing-anpassung-rahmen-config",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-anpassung-rahmen-config}
[source,xml]
----
<beans>
    ...
    <bean id="konfiguration" ...>
        <constructor-arg>
            <list>
                ...
                <value>/resources/gui-anwendungsgruppen.properties</value>
                ...
            </list>
        </constructor-arg>
    </bean>
    ...
</beans>
----

Anwendung können globale Standardwerte definieren. Definieren sie diese nicht, verwendet der Seitenrahmen Standardwerte aus `isy-web`.

:desc-table-SeitenrahmenStandardwerte: Globale Standardwerte für den Seitenrahmen
[id="table-SeitenrahmenStandardwerte",reftext="{table-caption} {counter:tables}"]
.{desc-table-SeitenrahmenStandardwerte}
[cols="5,4",options="header"]
|====
|Parameter                      |Standardwert
|`gui.header.logo.links.pfad`   |kein Logo
|`gui.header.logo.rechts.pfad`  |kein Logo
|`gui.header.text.logo.rechts`  |kein Text
|====

Die gleichen Werte können Anwendungen zusätzlich auf Ebene sogenannter _Anwendungsgruppen_ setzen, um den Seitenrahmen noch weiter an ihre Anforderungen anzupassen.
Anwendungsgruppen fassen in der Regel mehrere Flows zusammen und spiegeln sich nicht selten direkt in der Hauptnavigation wieder.
Setzt die Anwendungen einzelne Werte für bestimmte Anwendungsgruppen nicht, werden die globalen Standardwerte (s. vorige <<table-SeitenrahmenStandardwerte>>) herangezogen.

:desc-table-SeitenrahmenStandardwerteGruppen: Standardwerte für den Seitenrahmen bezogen auf Anwendungsgruppen
[id="table-SeitenrahmenStandardwerteGruppen",reftext="{table-caption} {counter:tables}"]
.{desc-table-SeitenrahmenStandardwerteGruppen}
[cols="5,4",options="header"]
|====
|Parameter                                         |Standardwert
|`gui.header.logo.links.pfad.<anwendungsgruppe>`   |`gui.header.logo.links`
|`gui.header.logo.rechts.pfad.<anwendungsgruppe>`  |`gui.header.logo.rechts`
|`gui.header.text.logo.rechts.<anwendungsgruppe>`  |`gui.header.text.logo.rechts`
|====

Das folgende Beispiel zeigt eine vollständige Konfiguration.

:desc-listing-AnpassungSeitenrahmen: Konfiguration zur Anpassung des Seitenrahmens
[id="listing-AnpassungSeitenrahmen",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-AnpassungSeitenrahmen}
[source]
----
# Globale Standardwerte
gui.header.logo.links.pfad = /javax.faces.resource/img/isyfactschriftzug.jpeg
gui.header.logo.rechts.pfad = /javax.faces.resource/img/isyfactlogo.jpeg
gui.header.text.logo.rechts = IsyFact

# Defintion der Anwendungsgruppen
gui.anwendungsgruppen.ids = gruppeEins,gruppeZwei,gruppeDrei

# Zuordnung von Flows zu Anwendungsgruppen
gui.anwendungsgruppen.urls.gruppeEins = startseiteFlow,nachrichtenFlow
gui.anwendungsgruppen.urls.gruppeZwei = formulareFlow,beispiellinkFlow
gui.anwendungsgruppen.urls.gruppeDrei = validierungFlow,wizardDialogFlow

# Logos / Texte der Anwendungsgruppen
gui.header.logo.links.pfad.gruppeZwei = /javax.faces.resource/img/andererschriftzug.jpeg
gui.header.logo.rechts.pfad.gruppeZwei = /javax.faces.resource/img/andereslogo.jpeg
gui.header.text.logo.rechts.gruppeZwei = Zweite Gruppe
----

==== Applikationsseiten

Applikationsseiten werden über den Controller `ApplikationseiteController` und das Model `ApplikationseiteModel` realisiert.

Wenn eine Applikationsseite erstellt werden soll, dann muss der Flow der Applikationsseite vom Flow `applikationseiteParentFlow` erben.
Es muss weiterhin ein Controller erstellt werden, der vom `AbstractGuiController` erbt und ein Model, das vom `AbstractMaskenModel` erbt. Die XHTML-Seiten der ViewStates müssen alle vom -Masken-Template `/WEB-INF/gui/common/layout/applikation.xhtml` erben (s.a. <<listing-jsfViewState>>).

Der `ApplikationseiteController` stellt sicher, dass alle layoutspezifischen Funktionen (z.B. der Linksnavigation) einer Applikationsseite initialisiert und zur Verfügung gestellt werden.
Abweichungen vom Standardvorgehen (z.B. Linksnavigation ausblenden) können durch Zugriff auf den Controller und Model in spezifischeren Controllern beim Initialisieren durchgeführt werden.

Neben dem `ApplikationseiteController` existiert auch der `BasisController`.
Dieser bietet Zugriff auf seitentypunabhängige Layoutfunktionen (z.B. modalen Dialog anzeigen).

Siehe weiterhin die Hinweise in den Seiten Header Bereich, Linksnavigation und Quicklinks.

==== Applikation Detailseite

Applikationsdetailseiten werden über den Controller `DetailseiteController` und das Model `DetailseiteModel` realisiert.

Wenn eine Applikationsdetailseite erstellt werden soll, dann muss der Flow der Applikationsdetailseite vom Flow `detailseiteParentFlow` erben.
Es muss weiterhin ein Controller erstellt werden, der vom `AbstractGuiController` erbt und ein Model, das vom `AbstractMaskenModel` erbt.
Die XHTML-Seiten der ViewStates müssen alle vom JSF-Masken-Template `/WEB-INF/gui/common/layout/applikationDetailseite.xhtml` erben.

Der DetailseiteController stellt sicher, dass alle layoutspezifischen Funktionen (z.B. der Seitentoolbar sowie Buttons in der Toolbar) einer Detailseite initialisiert und zur Verfügung gestellt werden.
Abweichungen vom Standardvorgehen (z.B. Seitentoolbar ausblenden, Druckbutton einblenden, Informationsbereich einblenden) können durch Zugriff auf den Controller und Model in spezifischeren Controllern beim Initialisieren durchgeführt werden.

Neben dem `DetailseiteController` existiert auch der `BasisController`.
Dieser bietet Zugriff auf seitentypunabhängige Layoutfunktionen (z.B. modalen Dialog anzeigen).

===== Seitentitel

Der TitlesListener (Listener für Spring-Webflow) ermöglicht es, dass konfigurierte Nachrichten anhand von Namenskonventionen automatisch als Title (Title-Tag), Headline (Titelzeile) oder Breadcrumb verwendet werden.
Der TitlesListener ist automatisch eingebunden und muss nicht explizit aktiviert werden.

Folgende Angaben sind zulässig:

`MAS_\{FlowName}_Title` +
`MAS_\{FlowName}_\{ViewState}_Title` +
`MAS_\{FlowName}_Headline` +
`MAS_\{FlowName}_\{ViewState}_Headline` +
`MAS_\{FlowName}_Breadcrumb` +
`MAS_\{FlowName}_\{ViewState}_Breadcrumb`

Die Angaben müssen sich in den Anwendungsressourcen (analog zu anderen Nachrichten) befinden und über eine MessageSource-Bean (`messageSource`) der isy-web zur Verfügung gestellt werden.

Wenn vorhanden, werden stets die Angaben mit ViewState verwendet, ansonsten die Angaben ohne ViewState.
In der Flowdefinition können die zu verwendenden Texte überschrieben werden, indem die Attribute titleKey , breadcrumbKey und headlineKey gesetzt werden.
Wenn für den Title keine Angabe gefunden werden kann, dann wird der Wert von `MAS_Global_Title` verwendet.
Weiterhin kann mit `MAS_Global_Title_Prefix` ein globaler Präfix für den Title gesetzt werden.

Weiterhin kann über eine Angabe von `<ui:define name="titel"/>` in Seiten definiert werden, welche Inhalte rechts neben dem bereits definierten Title (Title-Tag) ausgegeben werden. Im Folgenden ein Beispiel:

:desc-listing-zusatzmaskentitel: Zusatz-Maskentitel im Headerbereich
[id="listing-zusatzmaskentitel",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-zusatzmaskentitel}
[source, xml]
----
<ui:define name="titel"> 
   <h:outputText value="zusätzlicher Text" /> 
</ui:define> Über die Angaben
<ui:define name="titelzeileInfoLinks"/>
  bzw. <ui:define name="titelzeileInfoRechts"/>
----

Es kann weiterhin definiert werden, welche Inhalte zusätzlich direkt rechts neben der Headline (Titelzeile) angezeigt werden bzw. ganz am rechten Rand der Headline angezeigt werden.
Im Folgenden ein Beispiel: 

:desc-listing-titelzeileninfo: Titelzeileninfo
[id="listing-titelzeileninfo",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-titelzeileninfo}
[source, xml]
----
<ui:define name="titelzeileInfoLinks"> 
   <h:outputText value="zusätzlicher Text" /> 
</ui:define>
<ui:define name="titelzeileInfoRechts"> 
   <h:outputText value="zusätzlicher Text" /> 
</ui:define>
----

=== Modaler Dialog

Modale Dialoge werden mit dem Tag `<isy:modalDialogContent>` definiert.
Der Dialog besitzt folgende Facets:

* Der Header-Bereich
* Der Body-Bereich
* Der Footer-Bereich

:desc-listing-jsfModalerDialog: Modaler Dialog
[id="listing-jsfModalerDialog",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-jsfModalerDialog}
[source, xml]
----
<ui:define name="modalDialog">
   <isy:modalDialogContent>
     <f:facet name="modalHeader">\{msg.MEL_Lichtbild_anzeigen_Titel}</f:facet>
     <f:facet name="modalBody">
     <div class="form-horizontal">
        ...
     </div>
     </f:facet>
     <f:facet name="modalFooter">
        <div class="form-horizontal readonly">
           ...
        </div>
      </f:facet>
   </isy:modalDialogContent>
 </ui:define>
----

Das Tag `<isy:modalDialogContent>` wird über den UI-Platzhalter modalDialog eingefügt.
Dieser Platzhalter sorgt dafür, dass je nach Verfügbarkeit von JavaScript, der Inhalt des modalen Fensters entweder als Inhalt oder als eigenständiger Dialog gerendert wird.
Die Funktionsweise des modalen Dialogs ist in das Basis-Layout eingebunden.
Um einen Dialog zu öffnen, muss dieser als eigener View-State (in Spring Webflow) definiert werden.
Beim Eintreten in den Flow wird das modale Fenster über einen Aufruf des BasisController geöffnet.
Beim Verlassen des View-States wird dieser wieder geschlossen.

:desc-listing-openCloseModaleDialoge: Öffnen und Schließen von modalen Dialogen
[id="listing-openCloseModaleDialoge",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-openCloseModaleDialoge}
[source, xml]
----
<view-state id="lichtbildAnzeigenViewState" model="maskenModel">
   <on-entry>
      <evaluate expression="basisController.showModalDialog()"/>
   </on-entry>

   ...

   <transition on="schliesseModalenDialog" to="gesamtauskunftAnzeigenViewState">
      <evaluate expression="basisController.hideModalDialog()"/>
   </transition>

</view-state>
----

Um im Hintergrund weiterhin das aktuelle Fenster anzuzeigen, genügt es den bisherigen View-State entsprechend zu vererben.

// TODO noch nicht implementiert prüfen
//=== Meldungsdialog
//
//Meldungsdialoge werden eingesetzt, wenn der Benutzer in seinem Arbeitsablauf unterbrochen werden muss.
//
//:desc-image-meldungsdialogobjloeschen: Meldungsdialog – Objekt löschen
//[id="image-meldungsdialogobjloeschen",reftext="{figure-caption} {counter:figures}"]
//.{desc-image-meldungsdialogobjloeschen}
//image::image82.png[align="center", width="329",height="163"]
//
//
//:desc-image-aufbaumeldungsdialog: Aufbau Meldungsdialog
//[id="image-aufbaumeldungsdialog",reftext="{figure-caption} {counter:figures}"]
//.{desc-image-aufbaumeldungsdialog}
//image::image83.png[align="center", width="325",height="162"]
//
//
//Für Meldungsdialoge gibt es derzeit keine Umsetzung.
//Bei Bedarf können diese über die normalen modalen Dialoge umgesetzt werden (Dialoge).

[[wizard]]
=== Wizard

Wizards, auch Assistenten genannt, bezeichnen eine geführte Abfolge von Interaktionsschritten.

:desc-image-dialogwizard1: Beispiel eines Wizards
[id="image-dialogwizard1",reftext="{figure-caption} {counter:figures}"]
.{desc-image-dialogwizard1}
image::image88.png[align="center"]

Wizards werden mit dem Tag `<isy:wizard>` definiert.

Folgende Parameter sind zulässig:

* `wizardDialogModel`: Das Model des Wizards
* `width`: Die Breite des modalen Dialogs (optionale Angabe)
* `globalConfig`: Eine spezifische globale Konfiguration, falls notwendig


Der Wizard besitzt folgende Facets:

* `wizardHeader`: Der Header-Bereich
* `wizardBody`: Der Body-Bereich
* `wizardFooterLeftButtons`: Ergänzungen zu den angezeigten Buttons auf der linken Seite
* `wizardFooterRightButtons`: Ergänzungen zu den angezeigten Buttons auf der rechten Seite

:desc-listing-wirardModaleDialoge: Modaler Wizard
[id="listing-wirardModaleDialoge",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-wirardModaleDialoge}
[source, xml]
----
<isy:wizard wizardDialogModel="#{wdm}">
   <f:facet name="wizardHeader">Testheader</f:facet>
   <f:facet name="wizardBody">
       <ui:param name="aktuelleWizardSeite" value="#{wdm.getActiveWizardDialogPage()}" />
       <!-- In Abhängigkeit der ID werden die entsprechenden Seiten angezeigt. -->
       <ui:fragment rendered="#{wdm.getActiveWizardDialogPageId().equals('1')}">
          <ui:include src="page1.xhtml" />
       </ui:fragment>
       <ui:fragment rendered="#{wdm.getActiveWizardDialogPageId().equals('2')}">
          <ui:include src="page2.xhtml" /> </ui:fragment>
       <ui:fragment rendered="#{wdm.getActiveWizardDialogPageId().equals('3')}">
          <ui:include src="page3.xhtml" />
       </ui:fragment>
       <ui:fragment rendered="#{wdm.getActiveWizardDialogPageId().equals('4')}">
          <ui:include src="page4.xhtml" />
       </ui:fragment>
   </f:facet>
</isy:wizard>
----
Eine einzelne Seite eines Wizards wird über ein Objekt des Typs `WizardDialogPage` definiert.
Eine `WizardDialogPage` hat u.A. folgende Attribute:

* `wizardDialogPageId`: Eine ID, welche die Wizardseite eindeutig innerhalb des Wizards identifiziert
* `title`: Title der Wizardseite
* `pageDone`: Seite wurde abgearbeitet
* `pageSuccessful`: Seite wurde erfolgreich oder nicht erfolgreich abgearbeitet
* `pageDisabled`: Seite wurde deaktiviert

Jeder Wizard besitzt die folgenden, vordefinierten Buttons:

* `previous`: zurück zur vorherigen Seite
* `next`: weiter zur nächsten Seite
* `complete`: Wizard abschließen
* `abort`: Wizard abbrechen

Für jeden dieser Buttons gibt es die folgenden Einstellungen:

* `activated`: ob der Button aktiviert ist (Standard: `false`)
* `visible`: ob der Button sichtbar ist (Standard: `true`)
* `ajaxActivated`: ob die Aktion per AJAX ausgeführt werden soll (Standard: `true`)
* `ajaxAction`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `ajaxRender`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `ajaxBlock`: ob die GUI während des AJAX-Aufrufs blockiert (Standard: `false`)

Weiterhin benötigt ein Wizard ein Model des Typs `WizardDialogModel`. Ein `WizardDialogModel` hat folgende Attribute und Methoden:

* `activeWizardDialogPageId`: ID der derzeit aktiven Seite
* `activeWizardDialogPage`: momentan aktive Seite
* `nextActiveWizardDialogPageId`: ID der nächsten Seite
* `wizardDialogPages`: Liste der einzelnen Seiten des Wizards (`WizardDialogPage`-Objekte)
* `boolean isPageDone(String id)`: ob die Seite mit der angegebenen ID bereits abgearbeitet wurde
* `boolean isPageDisabled(String id)`: ob die Seite mit der angegebenen ID deaktiviert ist
* `WizardDialogPage getWizardDialogPage(String wizardDialogPageId)`: Gibt die Seite zur angegebenen ID zurück.

Für die Verwendung eines Wizards muss ein Controller erstellt werden, der vom `WizardDialogController` erbt.
Folgende Methoden müssen dabei überschrieben werden:

* `boolean finish(WizardDialogModel model)` beendet die Verarbeitung des Wizards,
* `boolean cancel(WizardDialogModel model)` bricht die Verarbeitung ab.

Folgende Methoden können genutzt und optional überschrieben werden:

* `initializeDefaultPages(WizardDialogModel model)` initialisiert die Pages des Wizards mit dem Standardverhalten,
* `boolean next(WizardDialogModel model)` ruft die nächste Seite auf,
* `boolean previous(WizardDialogModel model)` ruft die vorherige Seite auf.

// TODO noch nicht implementiert prüfen
// ==== Schnellnavigation 
//
// *NOCH NICHT IMPLEMENTIERT*
//
// Optional kann sich zur schnellen Navigation zwischen mehreren Ergebnissen ein Control zentriert in der Seiten-Toolbar befinden.
// Es besteht aus Zurück- und Vor-Buttons, die durch die Anzeige der aktuellen Position und der Gesamtmenge getrennt sind.
// Die Gesamtmenge entspricht der Anzahl der Objekte in der dahinterliegenden Übersichtsliste.

[[dialoge-ohne-javascript]]
=== Dialoge ohne JavaScript

image::image77.png[]

Die modalen Dialoge werden automatisch in das Layout integriert, sofern kein JavaScript verfügbar ist.

:desc-image-keinjavascriptdialog: Kein JavaScript – Dialog
[id="image-keinjavascriptdialog",reftext="{figure-caption} {counter:figures}"]
.{desc-image-keinjavascriptdialog}
image::image78.png[align="center"]

// TODO noch nicht implementiert prüfen
// :desc-image-keinjavascriptmeldung: Kein JavaScript – Meldungsdialog
// [id="image-keinjavascriptmeldung",reftext="{figure-caption} {counter:figures}"]
// .{desc-image-keinjavascriptmeldung}
// image::image79.png[align="center", width="629",height="526"]

:desc-image-keinjavascriptwizard: Kein JavaScript – Wizard
[id="image-keinjavascriptwizard",reftext="{figure-caption} {counter:figures}"]
.{desc-image-keinjavascriptwizard}
image::image80.png[align="center"]

[[jsf-bedienelemente]]
== JSF Bedienelemente

Als Bedienelemente für die WebGui werden JSF Composite Components zur Verfügung gestellt.
Durch das Einbinden des JSF-Namespace `xmlns:isy="http://java.sun.com/jsf/composite/isyfact"` können die JSF-Komponenten der IsyFact-Web Bibliothek in die Anwendung eingebunden werden.

Die Bedienelemente stellen im Grundsatz folgendes sicher:

* *JavaScript-Kompatiblität*: Komponenten bieten eine Fallback-Lösung an, falls kein JavaScript aktiviert ist.
* *Druckfunktion*: Komponenten stellen eine Druckansicht zur Verfügung, falls die Druckansicht aktiviert wurde.
* *Validierung*: Die speziellen Formularkomponenten stellen Validierungsfunktionen zur Verfügung, sodass bei Validierungsfehlern automatisch Nachrichten und Tooltips (inkl. Abwärtskompatibilität, falls kein JavaScript aktiviert wurde) gerendert werden.

Abweichungen zu diesen Vorgaben können im Spezialfall möglich sein.

TIP: Die IsyFact enthält die Demo-Anwendung `isy-webgui`.
Die Anwendung zeigt die Features der Bibliotheken `isy-web` sowie `isy-style` beispielhaft.
Insbesondere demonstriert sie Aussehen und Verhalten der nachfolgend beschriebenen JSF-Bedienelemente.

=== Button

Ein einfacher Button wird über das Tag `<isy:button>` eingebunden.

Ein Button besitzt folgende notwendige Parameter:

* `action`: auszuführende Aktion
* `value`: Label des Buttons

Außerdem gibt es folgende optionale Parameter:

* `styleClass`: zu ergänzende Style-Klassen
* `disabled`: ob der Button deaktiviert ist (Standard: `false`)
* `ajax`: ob die Aktion per AJAX ausgeführt werden soll (Standard: `true`)
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `block`: ob die GUI während des AJAX-Aufrufs blockiert (Standard: `false`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `defaultAction`: ob der Button der Default-Button sein soll (Standard: `false`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Wenn JavaScript aktiviert ist, dann wird die AJAX-Action durchgeführt.
Andernfalls wird immer ein Full-Page-Reload durchgeführt.

==== Mehrere Buttons

Mehrere Buttons können in einer Zeile gruppiert werden, indem sie in das Tag `<isy:buttonRow>` eingeschlossen werden.

Folgende optionale Parameter sind für das Tag `<isy:buttonRow>` zulässig:

* `styleClass`: zu ergänzende Style-Klassen
* `alignRight`: ob die Button Row rechtsbündig ist (Standard: `false`, d.h. linksbündig)

==== Mehrere Aktionen

In bestimmten Fällen kann es notwendig sein mehrere Formulare an den Server zu senden, um bestimmte Aktionen auszuführen (z.B. das Formular für den Inhaltsbereich soll auch beim Klick auf Drucken in der Seitentoolbar übermittelt werden). Dies kann durch verwenden des Tags `<isy:buttonInjectPost>` erreicht werden.
Dadurch lässt sich eine andere Aktion vor der eigentlichen Aktion des Buttons innerhalb des Tags ausführen.

Folgende Parameter sind notwendig:

* `postButton`: ID des Buttons, der die zusätzliche POST-Aktion durchführen soll
* `continueAfterPost`: ob nach der POST-Aktion auch tatsächlich der eigentliche Button geklickt werden soll (z.B. um Fehlerfälle abzufangen).

[[toolbar-button]]
=== Toolbar Button

Ein Toolbar Button wird über das Tag `<isy:buttonToolbar>` eingebunden.

Ein Toolbar Button besitzt folgende notwendige Parameter:

* `action`: auszuführende Aktion

Außerdem gibt es folgende optionale Parameter:

* `value`: Label des Buttons (Standard: leer)
* `icon`: anzuzeigendes Icon aus der Icon-Bibliothek (Standard: `placeholder`)
* `showIcon`: ob das Icon angezeigt wird (Standard: `true`).
* `reverseIconPosition`: ob das Icon rechts vom Label angezeigt wird (Standard: `false`)
* `disabled`: ob der Button deaktiviert ist (Standard: `false`)
* `ajax`: ob die Aktion per AJAX ausgeführt werden soll (Standard: `true`)
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `block`: ob die GUI während des AJAX-Aufrufs blockiert (Standard: `false`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Wenn JavaScript aktiviert ist, dann wird die AJAX-Action durchgeführt.
Andernfalls wird immer ein Full-Page-Reload durchgeführt.

Folgende Action-Sources werden bereitgestellt:

* `buttonActionEvent`: Das Action Event für den Button.

// TODO noch nicht implementiert prüfen
//==== Menü Button
//
//Derzeit noch nicht realisiert.

[[toggle-button]]
==== Toggle Button

Ein Toggle Button wird über das Tag `<isy:buttonToggle>` eingebunden.

Ein Toggle Button besitzt folgende notwendige Parameter:

* `action`: auszuführende Aktion

Außerdem gibt es folgende optionale Parameter:

* `value`: Label des Buttons (Standard: leer)
* `icon`: anzuzeigendes Icon aus der Icon-Bibliothek (Standard: `placeholder`)
* `showIcon`: ob das Icon angezeigt wird (Standard: `true`).
* `reverseIconPosition`: ob das Icon rechts vom Label angezeigt wird (Standard: `false`)
* `disabled`: ob der Button deaktiviert ist (Standard: `false`)
* `active`: ob der Button ausgewählt ist (Standard: `false`)
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Folgende Action-Sources werden bereitgestellt:

* `toggleButton`: Das Action Event für den Button.

[[icon-button]]
==== Icon Button

Ein Button mit Icon wird über das Tag `<isy:buttonIcon>` eingebunden.

Ein Icon Button besitzt folgende notwendige Parameter:

* `action`: auszuführende Aktion

Außerdem gibt es folgende optionale Parameter:

* `value`: Label des Buttons (Standard: leer)
* `size`: Größe des Buttons (`small`/`large`) (Standard: `large`)
* `icon`: anzuzeigendes Icon aus der Icon-Bibliothek (Standard: `placeholder`)
* `showIcon`: ob das Icon angezeigt wird (Standard: `true`).
* `tooltip`: Tooltip, der über dem Icon angezeigt wird (Standard: leer)
* `disabled`: ob der Button deaktiviert ist (Standard: `false`)
* `btnClass`: zu ergänzende Style-Klassen
* `ajax`: ob die Aktion per AJAX ausgeführt werden soll (Standard: `true`)
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `block`: ob die GUI während des AJAX-Aufrufs blockiert (Standard: `false`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Folgende Action-Sources werden bereitgestellt:

* `buttonActionEvent`: Das Action Event für den Button.

Wenn JavaScript aktiviert ist, dann wird die AJAX-Action durchgeführt.
Andernfalls wird immer ein Full-Page-Reload durchgeführt.

[[hyperlink-ueberschrift]]
==== Hyperlink

Hyperlinks sind verlinkte Texte (oder auch Grafiken), die im Wesentlichen zur Navigation zwischen Seiten dienen.
Ebenso können Hyperlinks dazu eingesetzt werden, Funktionen aufzurufen.

Links können mit dem Standard-HTML Tag `<a/>` oder durch Nutzung des JSF Tags `<h:outputLink/>` erzeugt werden.

TIP: Auch die Nutzung des JSF Tags `<h:commandLink />` ist möglich.
Jedoch ist die Funktionalität nur bei aktiviertem JavaScript nutzbar.
Entsprechende Fallbackmaßnahmen müssen also getroffen werden.

Falls ein Hyperlink Aktionen im Webflow bzw. JSF ausführen soll, so kann das Tag `<isy:hyperlink>` verwendet werden.
Dieses Tag stellt sicher, dass falls JavaScript deaktiviert ist, ein Button mit Layout eines Links dargestellt wird.

Ein Hyperlink besitzt folgende optionale Parameter:

* `action`: auszuführende Aktion
* `value`: Label des Links
* `title`: Alternativtext des Links
* `baseStyleClass`: Standard-CSS-Klasse des Links (Standard: `cmdbtn-link`)
* `additionalStyleClass`: zu ergänzende Style-Klassen (Standard: leer)
* `openInNewTab`: ob der Link in einem neuen Tab geöffnet werden soll (Standard: `false`, funktioniert nur mit aktiviertem JavaScript)

Das Tag stellt folgende ActionSource bereit:

* `hyperlink`: Die ActionSource des Links.

[[label-ueberschrift]]
=== Label

Ein Label besteht in der Regel aus einem Text.
In manchen Fällen kann es auch eine Kombination aus einem Icon und einem Text sein (z.B. Buttons mit Icon und Text).
Es gibt auch Bedienelemente, deren Label ausschließlich aus einem Icon bestehen.

Für reine Labels existieren keine spezifischen JSF-Komponenten.
Das Standard-JSF Tag `<h:outputText/>` kann verwendet werden.
Für formularbasierte Masken werden automatisch Labels für Eingabefelder erzeugt, wie in <<eingabefelder-ueberschrift>> beschrieben.
Für das Ausgeben eines Textes (mit zugehörigem Label) in einem Formular kann das Tag `<isy:formLabel>` verwendet werden.

Es besitzt folgende optionale Parameter:

* `reference`: Referenz des Objekts für die Validierung
* `value`: Text des Ausgabebereichs
* `label`: Text des Labels
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Ausgabebereiches (Standard: `col-lg-6`)
* `textStyleClass`: CSS-Klasse des auszugebenden Textes
* `tooltip`: Tooltip des Ausgabebereichs
* `escapeLabel`: ob Sonderzeichen für das Label escaped werden sollen (Standard: `true`)
* `breakWords`: ob der Überlauf von Text in die nächste Zeile erlaubt ist (Standard: `true`)
* `converter`: ID des JSF-Converters, welche die Ausgabe in einen Text konvertiert (Standard: leer)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[eingabefelder-ueberschrift]]
=== Eingabefelder

Eingabefelder dienen der Eingabe von Text durch den Benutzer und sind in der Regel einzeilig.

Für einzelne Eingabefelder existieren derzeit noch keine einfachen Komponenten.
Um ein einfaches Eingabefeld einzufügen kann das JSF-Tag `<h:inputText/>` mit der CSS-Klasse `form-control` von Bootstrap verwendet werden.
Für formularbasierte Eingaben existiert das Tag `<isy:formInput/>`, welches ein Eingabefeld in einem Formularlayout mit Label kapselt.
Nähere Informationen hierzu finden sich in <<layout-von-Formularen>>.

Ein Eingabefeld besitzt folgende notwendige Parameter:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `type`: Typ des Eingabefelds, so dass diese Komponente z.B. auch für Passwort-Felder verwendet werden kann.
Mögliche Werte sind alle Werte für das Feld `type` des HTML-Tags `input` (Standard: `text`)
* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `readonly`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird
* `inputmask`: Eingabemaske
* `inputmaskInsertMode`: ob der Text bei der Eingabe überschrieben wird (Standard: `true`)
* `maxlength`: maximale Länge der Eingabe (Standard: 255)
* `width`: maximale Breite des Eingabefeldes (Standard: 100%)
* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `tooltip`: Tooltip, der über dem Eingabefeld angezeigt wird (Standard: leer)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)
* `charpicker`: ob eine Eingabe für Sonderzeichen angezeigt wird (Standard: `false`)

Eingabefelder besitzen folgende Facets:

* `contentRight`: Inhalt, der rechts vom Eingabefeld angezeigt wird

[[aktionseingabefeld]]
==== Aktionseingabefeld

Für Aktionseingabefelder existieren die Tags `<isy:actionInput>` bzw. `<isy:formActionInput>`. 

:desc-image-aktionseingabefeld: Aktionseingabefeld
[id="image-aktionseingabefeld",reftext="{figure-caption} {counter:figures}"]
.{desc-image-aktionseingabefeld}
image::image155.png[align="center"]

Ein Aktionseingabefeld besitzt folgende notwendige Parameter:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld
* `action`: auszulösende Aktion
* `icon`: anzuzeigendes Icon aus der Icon-Bibliothek

Außerdem gibt es folgende optionale Parameter:

* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird
* `maxlength`: maximale Länge der Eingabe (Standard: 20)
* `iconColor`: Farbe des Icons (Standard: `#45484D`)
* `tooltip`: Tooltip, der über dem Eingabefeld angezeigt wird (Standard: `...`)
* `mode`: Eins aus `normal` für Eingabefeld und Icon aktiv, `button-only` für nur Icon aktiv und `input-only` für nur Eingabefeld aktiv (Standard: `normal`)
* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)

Folgende Parameter sind zusätzlich zu den eben genannten für `<isy:formActionInput>` zulässig:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[eingabefelder-fuer-geldbetraege]]
==== Eingabefeld für Geldbeträge

Für die Eingabe von Geldbeträgen existiert das Tag `<isy:formCurrencyInput>`.
Dieses Bedienelement verhält sich bis auf wenige Ausnahmen wie `<isy:formInput>`.
Das Eingabefeld für Geldbeträge:

* besitzt kein Attribut `inputmask`, da sich diese nicht mit der JavaScript-Funktion verträgt, welche die Daten formatiert.
* lässt nur die Eingabe von Zahlen und Kommata zu; alle anderen Zeichen werden direkt nach Eingabe sofort wieder gelöscht.
* besitzt das Attribut `onchange` - dort kann eine JavaScript-Funktion übergeben werden, die aufgerufen wird, sobald der Cursor das Feld verlässt.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `readonly`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird
* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)
* `maxlength`: maximale Länge der Eingabe (Standard: 255)
* `width`: maximale Breite des Eingabefeldes (Standard: 100%)
* `tooltip`: Tooltip, der über dem Eingabefeld angezeigt wird (Standard: leer)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)
* `onchange`: JavaScript-Funktion, die bei Verlassen des Feldes aufgerufen wird
* `onkeyup`: JavaScript-Funktion, die direkt nach einer Eingabe aufgerufen wird
* `decimalplaces`: Anzahl der Nachkommastellen (Standard: 2)
* `alignright`: ob der Text innerhalb des Eingabefeldes rechts ausgerichtet sein soll (Standard: `false`)

[[upload]]
==== Upload

Für den Upload von Dateien existiert das Tag `<isy:formUpload>`.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `accept`: Einschränkung der angenommenen Dateien gemäß ihres MIME-Types
* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird
* `tooltip`: Tooltip, der über dem Eingabefeld angezeigt wird (Standard: leer)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[text-box]]
==== Textbox

Eine Textbox kann über das HTML-Tag `<textarea>` mit der CSS-Klasse `form-control` von Bootstrap eingebunden werden.

Text Boxen sehen optisch aus wie Eingabefelder, es können jedoch mehrzeilige Daten eingegeben werden.

:desc-image-bildtextbox: Textbox
[id="image-bildtextbox",reftext="{figure-caption} {counter:figures}"]
.{desc-image-bildtextbox}
image::image163.png[align="center", pdfwidth=60%]

Für Formulare kann das Tag `<isy:formTextarea>` verwendet werden.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)
* `readonly`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `textareaStyleClass`: CSS-Klasse der Textbox (Standard: leer)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird
* `tooltip`: Tooltip, der über dem Eingabefeld angezeigt wird (Standard: leer)
* `rows`: Anzahl an Zeilen (Standard: 5)
* `cols`: Anzahl an Spalten
* `maxlength`: maximale Länge der Eingabe (Standard: 4000)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

==== Date Picker

Mit dem Date Picker können Anwender über einen Kalender gezielt einen Tag auswählen.
Der Kalender öffnet sich nach einem Klick auf das Icon neben dem Eingabefeld.

Der Date Picker wird über das Tag `<isy:formDate>` eingebunden.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `inputFieldClass`: CSS-Klasse des Eingabefeldes (Standard: leer)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird (Standard: `TT.MM.JJJJ`)
* `readonly`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`)
* `language`: angezeigte Sprache (Standard: `de`)
* `dateformat`: Datumsformat (Standard: `dd.mm.yyyy`)
* `inputmask`: Eingabemaske
* `inputmaskInsertMode`: ob der Text bei der Eingabe überschrieben wird (Standard: `true`)
* `inputmaskClearOnBlur`: ob beim Verlassen des Feldes die Maskierungsplatzhalter ausgeblendet werden (Standard: `true`)
* `showPicker`: ob der Kalender angezeigt wird (Standard: `true`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Für den Datepicker wird ein http://bootstrap-datepicker.readthedocs.io[externes Plug-In] verwendet.
Das Bedienelement selbst bietet eine automatische Konfiguration des Plug-Ins sowie eine zum Rest der JSF-Bedienelemente einheitlich Schnittstelle.

// TODO noch nicht implementiert prüfen
//==== Time Picker
//
//Mit Hilfe des Time Pickers kann der Benutzer Uhrzeiten auswählen.
//
//Derzeit noch nicht umgesetzt.

[[dropdown-menue]]
=== Dropdown Menü

Mit einem Dropdown Menü kann der Benutzer per Mausklick oder Tastatur-Bedienung genau einen Wert aus einer Liste von Optionen auswählen.

:desc-image-bildddropdownmenue: Dropdown Menü
[id="image-bildddropdownmenue",reftext="{figure-caption} {counter:figures}"]
.{desc-image-bildddropdownmenue}
image::image166.png[align="center"]

Ein Dropdown Menü wird über das Tag `<isy:selectOneDropdown>` eingebunden.
Für Formulareingaben existiert das Tag `<isy:formSelectOneDropdown>`.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding in der Auswahl

Außerdem gibt es folgende optionale Parameter:

* `reference`: Wert der ID
* `invalid`: ob die Auswahl invalide ist (Standard: `false`)
* `disabled`: ob die Auswahl deaktiviert ist (Standard: `false`)
* `title`: Tooltip, der über der Auswahl angezeigt wird
* `dropdownStyleClass`: CSS-Klasse des Dropdown Menüs (Standard: leer)
* `readonly`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)
* `converter`: Konverter-Bean für die angezeigten Elemente
* `converterAttribute`: Attribut für den Konverter

Für das Bedienelement `<isy:formSelectOneDropdown />`gibt es zusätzlich die folgenden Parameter:

* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `dropdownStyleClass`: CSS-Klasse des Dropdown Menüs (Standard: `form-selectonedropdown`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)

Wenn JavaScript aktiviert ist, wird das Dropdown Menü über ein Bootstrap-Plugin dargestellt, ansonsten als natives Element.

=== Tabs

Tabs dienen der Strukturierung von Informationen und Reduktion der Anzahl gleichzeitig sichtbarer Inhaltsbereiche, wenn die Informationen schnell innerhalb des gleichen Fensters zugreifbar sein müssen.
Tabreiter verhalten sich entsprechend dem analogen Vorbild eines Karteireiters, der dazu dient, verschiedene Karteikarten voneinander zu trennen.
Tabs werden häufig dazu verwendet, um Eigenschaften eines Objekts in inhaltliche sinnvolle Gruppen aufzuteilen.

:desc-image-bildtabs: Tabs
[id="image-bildtabs",reftext="{figure-caption} {counter:figures}"]
.{desc-image-bildtabs}
image::image173.png[align="center"]

Tabs werden über die Tags `<isy:tabGroup>`, `<isy:tabHeader>` und `<isy:tabContent>` eingebunden.
Im Folgenden ein Beispiel:

:desc-listing-tabgroup: Beispiel für Tabs
[id="listing-tabgroup",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-tabgroup}
[source, xml]
----
<isy:tabGroup tabGroupId="testTab" globalTabContentRefs="A P S" globalTab="A" defaultTab="A"
  tabGroupModel="#{jsfSteuerelementeModel.tabGroupModel}">

  <f:facet name="tabHeader">
    <isy:tabHeader value="Auskunft" name="A" />
    <isy:tabHeader value="Personalien" name="P" />
    <isy:tabHeader value="Sachverhalte" name="S" />
  </f:facet>

  <isy:tabContent name="A">Dies ist die Auskunft.</isy:tabContent>
  <isy:tabContent name="P">Dies sind Personalien.</isy:tabContent>
  <isy:tabContent name="S">Dies sind die Sachverhalte.</isy:tabContent>

</isy:tabGroup>
----

Zunächst wird die Tabgruppe mit dem Tag `<isy:tabGroup>` allgemein definiert.

Folgende Parameter sind Pflichtparameter:

* `tabGroupModel`: Model für die Tabgruppe, das im Maskenmodel liegen sollte. Muss vom Typ `TabGroupModel` sein.

Außerdem gibt es weitere optionale Parameter:

* `defaultTab`: Name des Default-Tabs, der beim ersten Anzeigen des Elements aktiv ist.
* `globalTab`: Name des globalen Tabs
* `globalTabContentRefs`: Durch Leerzeichen separierte Liste an Namen der Tabs, welche beim Anzeigen des globalen Tabs auch angezeigt werden sollen. (Anmerk.: Der Parameter wird von der JSF-Komponente 'tabContent' ausgewertet.)
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)
* `scrollTabUpwards`: Bei Tabgruppen, die im unteren Maskenbereich dargestellt werden, wird oftmals der Inhalt der Tabs nicht vollständig angezeigt. Setzt man den Parameter `scrollTabUpwards` auf `true` (Standard: `false`), dann wird die gesamte Tabgruppe beim Anklicken eines Tabellenreiters nach oben verschoben, sodass für den Anwender der TabContent maximal sichtbar wird.

Wenn JavaScript aktiviert ist, dann nutzen die Tabs beim Umschalten AJAX-Aufrufe.
Andernfalls wird beim Wechsel der Tabs die gesamte Seite neu geladen.

==== Tab-Header

Einzelne Tab-Header werden mit dem Tag `<isy:tabHeader>` definiert.

Folgende Parameter sind Pflicht:

* `name`: Name des Tabs, für welchen dieser Header definiert ist
* `value`: Titel des Tabs zur Anzeige

Außerdem gibt es folgende optionale Parameter:

* `tooltip`: Tooltip, der über der Auswahl angezeigt wird
* `tabController`: spezifischer Tab-Controller (Standard: `tabController`)
* `skipAction`: ob die übergebene Action ausgelassen werden soll (Standard: `false`, d.h. die Action wird standardmäßig ausgeführt)
* `action`: Action, die beim Wechsel zwischen Tabs ausgeführt wird (Standard: `tabController.changeTab(TabGroupModel model, String name)`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

==== Tab-Inhalte

Inhalte von Tabs werden mit dem Tag `<isy:tabContent>` definiert.

Folgende Parameter sind Pflicht:

* `name`: Name des Tabs, zu welchem dieser Inhalt gehört

Außerdem gibt es folgende optionale Parameter:

* `tabController`: spezifischer Tab-Controller (Standard: `tabController`)
* `preload`: ob das Tab, falls JavaScript aktiv ist, vorgeladen werden soll (Standard: `false`, d.h. kein Vorladen)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[IMPORTANT]
====
Zwischen den beiden Attributen `preload` der Tab-Inhalte und `skipAction` der Tab-Header besteht eine wichtige Abhängigkeit.
Sie müssen immer den gleichen Wert aufweisen, ansonsten funktioniert der Tab nicht korrekt.

Das Attribut `preload` legt fest, ob der Inhalt des Tabs beim Laden der gesamten Seite vorgeladen werden soll.
Bei einem Wechsel zwischen vorgeladenen Tabs muss dann entsprechend kein Server-Aufruf stattfinden.
In diesem Fall darf aber die Action des Tab-Headers nicht ausgeführt werden, weil sonst doch ein Server-Aufruf stattfinden würde.
Dies würde sowohl unnötigen Netzwerkverkehr als auch unerwünschtes Verhalten bei der Tab-Auswahl hervorrufen.

Standardmäßig stehen beide Werte auf `false`.
Wenn das Vorladen gewünscht ist, müssen beide Werte explizit auf `true` gesetzt werden.
====

// TODO noch nicht implementiert prüfen
//[[taboverflow-menue]]
//==== Taboverflow Menü
//
//Das Taboverflow Menü dient zur Vermeidung mehrzeiliger Tabreiter-Elemente.
//Das Menü enthält alle Tabs, die nicht direkt auf dem Screen angezeigt werden können.
//
//
//*Hinweise zur Implementierung*
//
//Diese Konzept wurde noch nicht realisiert.

[[liste-ueberschrift]]
=== Listen

Listen werden benutzt, um eine überschaubare Anzahl an Daten oder Objekten eines Typus übersichtlich und vergleichbar darzustellen.

:desc-image-listemitlistenkopf: Liste mit Listenkopf
[id="image-listemitlistenkopf",reftext="{figure-caption} {counter:figures}"]
.{desc-image-listemitlistenkopf}
image::image178.png[align="center",pdfwidth=60%]

Für eine Liste mit Einfachauswahl gibt es die Tags `<isy:selectOneList>` bzw. `<isy:formSelectOneList>`. Für eine Liste mit Mehrfachauswahl stehen die Tags `<isy:selectManyList>` bzw. `<isy:formSelectManyList>` zur Verfügung.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding in der Auswahl

Außerdem gibt es folgende optionale Parameter:

* `disabled`: ob die Liste deaktiviert ist (Standard: `false`)
* `size`: Anzahl der Zeilen, die sichtbar sind
* `checkboxed`: ob neben dem Highlighting ebenfalls Checkboxen angezeigt werden (Standard: `false`)
* `selectlistStyleClass`: CSS-Klasse für die Liste
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Für die Elemente innerhalb von Formularen gibt es zusätzlich die folgenden Parameter:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)

==== List Picker (Objektauswahl)

Der List Picker kann den Benutzer bei der Auswahl bestimmter Objekte unterstützen, in dem weitere Zusatzinformationen die Identifikation von Werten vereinfachen.

Ein List Picker wird über das Tag `<isy:formListpicker>` eingebunden.

Folgende Parameter sind Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert für das Databinding im Eingabefeld

Außerdem gibt es folgende optionale Parameter:

* `required`: ob die Eingabe ein Pflichteingabe ist (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse des Labels (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse des Eingabebereiches (Standard: `col-lg-6`)
* `placeholder`: Platzhalter, welcher im Eingabefeld angezeigt wird (Standard: `TT.MM.JJJJ`)
* `inputmask`: Eingabemaske
* `inputmaskInsertMode`: ob der Text bei der Eingabe überschrieben wird (Standard: `true`)
* `minWidth`: Mindestbreite (Standard: 0)
* `maxHeight`: maximale Höhe (Standard: 200)
* `tooltip`: Tooltip, der über dem Button angezeigt wird
* `title`: Tooltip, der über dem Eingabefeld angezeigt wird
* `listpickerModel`: Model für den List Picker, abgleitet von `ListpickerModel`
* `listpickerController`: Controller für den List Picker, abgeleitet von `ListpickerController`
* `ajaxLoading`: ob Items dynamisch nachgeladen werden (Standard: `false`)
* `ajaxForm`: ID des Formulars, welches für das dynamische Nachladen von Items verwendet wird
* `header`: sortierte Liste der Spaltenüberschriften
* `inputComplement`: Nummer der Spalte, dessen Inhalt per JavaScript im Eingabefeld ergänzt werden soll (Standard: 0 = deaktiviert)
* `useAutocomplete`: ob Eingaben automatisch vervollständigt werden (Standard: `true`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Falls JavaScript nicht aktiviert ist, dann wird statt dem List Picker ein einfaches <<dropdown-menue>> angezeigt.

Beispiel für die Integration eines List-Pickers (ohne Ajax):

:desc-listing-listpickerOhneAjax: Listpicker ohne Ajax
[id="listing-listpickerOhneAjax",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-listpickerOhneAjax}
[source, xml]
----
<isy:formListpicker
  reference="anfrageIdentifikation.gruppe"
  inputmask="99"
  listpickerModel="#{identifikationModel.gruppeListpickerModel}"
  listpickerController="#{behoerdeHelper.gruppeListpickerController}"
  label="#{msg.MEL_Identifikation_Gruppe}"
  value="#{identifikationModel.anfrageIdentifikation.gruppe}"
  header="#{msg.MEL_Identifikation_Gruppe_Listpicker_Nummer},
          #{msg.MEL_Identifikation_Gruppe_Listpicker_Name} "/>
----

Das spezifische `ListpickerModel` enthält die Liste an Items, welche dargestellt werden sollen.
Die Filterung der Items geschieht automatisch über JavaScript.
Falls die Liste an Items zu groß wird, besteht die Möglichkeit die Auswahl über AJAX nachzuladen.
Dazu können die Attribute `ajaxLoading="true"` und `ajaxForm="gruppeListpickerAjaxForm"` ergänzt werden.
Zusätzlich muss im View State das entsprechende Form Element ergänzt werden:

:desc-listing-listpickerAjaxForm: ListpickerAjaxForm
[id="listing-listpickerAjaxForm",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-listpickerAjaxForm}
[source, xml]
----
<ui:define name="form">
   <h:form id="gruppeListpickerAjaxForm">
      <isy:formListpickerAjaxContent
      listpickerModel="#{identifikationModel.gruppeListpickerModel}" />
   </h:form>
</ui:define>
----
Über das `<ui:define>` lassen sich Form-Elemente im Basis-Layout integrieren.
Das Tag `<isy:formListpickerAjaxContent>` lädt die entsprechend ListpickerItems in das Formular.
Das Formular an sich ist nicht sichtbar.
Das JavaScript Plugin übernimmt das entsprechende Laden der Elemente in den Listpicker.
Die Filterung der Elemente kann im spezifischen `ListpickerController` definiert werden.

==== Behörden Picker

Für die Auswahl von Behörden existiert bereits ein fertiger Behörden Picker (`<isy:formBehoerdeListpicker>`), welcher den normalen Listpicker instanziiert.
Der Behördenlistpicker ist ein AJAX Listpicker, d.h. der Parameter `ajaxForm` muss gesetzt sein.
Als Dropdown zeigt er eine zweispaltige Tabelle mit Behördenkennzeichen und Namen der Behörde an, auf welcher gefiltert werden kann.

Der Behörden Picker besitzt keine zusätzlichen Parameter gegenüber `<isy:formListpicker>`, definiert jedoch einen eigenen Controller, von dem abgeleitet werden muss (`AbstractBehoerdeListpickerController`), und ein eigenes Model (`BehoerdeListpickerModel`).

[[tabelle-ueberschrift]]
=== Tabelle

Eine Tabelle dient der übersichtlichen Anzeige von größeren Datenmengen.
Die Tabelle besteht aus mehreren Informationsspalten, die zur Sortierung verwendet werden können.

:desc-image-einfuehrungeinertabelle: Tabelle
[id="image-einfuehrungeinertabelle",reftext="{figure-caption} {counter:figures}"]
.{desc-image-einfuehrungeinertabelle}
image::image180.png[align="center"]

:desc-image-interaktivezeilen: Tabelle – Zustände interaktiver Zeilen
[id="image-interaktivezeilen",reftext="{figure-caption} {counter:figures}"]
.{desc-image-interaktivezeilen}
image::image181.png[align="center"]

Die Umsetzung der Tabelle unterscheidet sich grundsätzlich zu Widgets wie der von JSF bereitgestellten `<h:dataTable>`. Die `<isy:dataTable>` ist näher am Layout einer eigentlichen Tabelle aufgebaut und dadurch flexibler nutzbar (z.B. dynamische Anzahl an Spalten). Dafür jedoch auch eine größere Konfiguration möglich.

Es existieren folgende Tags zur Konfiguration der `<isy:dataTable>`:

* `<isy:dataTable>`
* `<isy:dataTableHeader>`
* `<isy:dataTableRowAllSelection>`
* `<isy:dataTableRows>`
* `<isy:dataTableCell>`
* `<isy:dataTableDetailButton>`
* `<isy:dataTableRowSelection>`

Beispiel für die Definition einer `<isy:dataTable>`:

:desc-listing-dataTable: Beispiel für dataTable
[id="listing-dataTable",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-dataTable}
[source, xml]
----
<isy:dataTable dataTableModel="#{...}" dataTableController="#{...}" action="trefferlisteDoppelklick">

  <f:facet name="tableToolbar">
    <isy:buttonGroup>
       <isy:buttonToolbar .../>
    </isy:buttonGroup>
  </f:facet>

  <f:facet name="tableHeader">
    <isy:dataTableHeader name="Vorname" />
    <isy:dataTableHeader name="Nachname" />
    <isy:dataTableHeader name="Aktionen" />
  </f:facet>

  <isy:dataTableRows
      rowDefinition="/WEB-INF/gui/.../rowDefinition.xhtml"
      detailDefinition="/WEB-INF/gui/.../detailDefinition.xhtml" />

</isy:dataTable>
----
Die grundlegende Basis bildet das Tag `<isy:dataTable>`.

Folgende Parameter sind Pflicht:

* `dataTableModel`: Model für die Tabelle, das im Maskenmodel liegen muss. Muss vom Typ `DataTableModel` sein und eine Liste von Datensätzen (Items) zur Anzeige beinhalten.
* `dataTableController`: Der zugehörige, spezifische Controller. Der Controller stellt z.B. Funktionalität zur Suche bereit. Muss vom Typ `DataTableController` sein.

Außerdem gibt es folgende optionale Parameter:

* `selectable`: ob die Tabelle selektierbar ist oder nicht (Standard: `false`)
* `selectionMode`: ob Einfach- (`single`) oder Mehrfachauswahl (`multiple`) möglich ist ( Standard: `multiple`)
* `detailMode`: Modus für die Detailansicht (`single` oder `multiple`, Standard: `multiple`)
* `action`: Aktion, welche beim Doppelklick auf eine Zeile ausgeführt wird
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `highlightDoubleclick`: ob Zeilen bei einem Doppelklick hervorgehoben werden sollen (Standard: `false`)
* `showMore`: ob ein Button zum Anzeigen von mehr Spalten angezeigt werden soll (Standard: `false`)
* `styleClass`: zu ergänzende CSS-Klassen
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

==== Toolbar

Im JSF-Facet `tableToolbar` werden Listen von `<isy:buttonGroup>` Tags erwartet.
Die Listen können jeweils Elemente der Typen `<isy:buttonToolbar>` (siehe <<toolbar-button>>) und `<isy:buttonToggle>` (siehe <<toggle-button>>) enthalten.

Folgende optionale Parameter gibt es für die Toolbar:

* `alignLeft`: ob die Toolbar linksbündig ausgerichtet ist (Standard: `false`)
* `alignRight`: ob die Toolbar rechtsbündig ausgerichtet ist (Standard: `false`)

==== Header

Im JSF-Facet `tableHeader` wird eine Liste von `<isy:dataTableHeader>` Tags erwartet.
Ein Tag entspricht dabei einem Titel einer Spalte.

Folgende optionale Parameter gibt es für einen Header:

* `name`: Header-Name / Spaltenüberschrift
* `sortable`: ob die Spalte sortierbar ist (Standard: `false`)
* `hidden`: ob die Spalte ausgeblendet ist (Standard: `false`)
* `sortProperty`: Attribut der Datensätze (Items), nach dem sortiert wird
* `width`: Breite der Spalte
* `title`: Tooltip, der über der Spalte angezeigt wird (Standard: leer)
* `align`: horizontale Ausrichtung der Spaltenüberschrift

==== Zeilen

Die Zeilen der Tabelle werden mit dem Tag `<isy:dataTableRows>` definiert. 

Folgende Parameter sind zulässig:

* `rowDefinition`: Pfad zur XHTML-Seite für Zeilen
* `detailDefinition`: Pfad zur XHTML-Seite für die Detailansicht
* `preloadingSize`: Anzahl der Elemente, die für die Detailansicht vorgeladen werden (Standard: 0)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Beispiel einer Row-Definition:

:desc-listing-rowdefinition: Beispiel einer Row-Definition
[id="listing-rowdefinition",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-rowdefinition}
[source, xml]
----
<ui:composition>

  <isy:dataTableCell>#{dataTableItem.vorname}</isy:dataTableCell>
  <isy:dataTableCell>#{dataTableItem.nachname}</isy:dataTableCell>
  <isy:dataTableCell>
    <isy:dataTableDetailButton dataTableModel="#{...}" />
  </isy:dataTableCell>

</ui:composition>
----

Die Row-Definition wird für jeden Datensatz in der Tabelle eingebunden.
Der UI-Parameter `dataTableItem` weist immer auf den aktuellen Treffer (also eine Objekt des Typs `DataTableItem`).
Mit diesem Parameter können dann für jede Spalte die `<isy:dataTableCell>` Tags eingebunden werden.
Die Inhalte dieser Tags repräsentieren den Inhalt der jeweiligen Zellen.
Die Reihenfolge der Spalten werden durch die Definition des Tabellen-Headers festgelegt.

Das Tag `<isy:dataTableCell>` hat derzeit folgende Parameter:

* `hidden`: ob die Zelle ausgeblendet ist (Standard: `false`)
* `align`: Ausrichtung des Inhalts (Standard: `left`)

Die Einbindung der Row-Definition erfolgt mittels dem JSF Tag `<ui:repeat>`.
Als Statusvariable wird `dataTableItemRepeatStatus` verwendet.
Auch auf diese Variable kann innerhalb der Row-Definition zugegriffen werden.

Zur Vereinfachung des Aufrufs der Detailansicht wird das Tag `<isy:dataTableDetailButton>` angeboten.
Dieses Tag rendert einen Button und öffnet die Detailansicht eines Treffers.
Die Detailansicht eines Treffers befindet sich an der im Tag `<isy:dataTableRows>` angegebenen Stelle.

Beispiel einer Detail-Definition:

:desc-listing-detaildefinition: Beispiel einer Detail-Definition
[id="listing-detaildefinition",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-detaildefinition}
[source, xml]
----
<ui:composition>
  <td colspan="2">
    <div class="form-horizontal readonly">
      <div class="row row-df">
        <div class="col col-lg-6">
          <isy:formLabel reference="aktenzeichen"
             value="#{dataTableItem.aktenzeichen}"
             label="#{msg_currentflow.MEL_Trefferliste_Aktenzeichen}"/>
          <isy:formLabel reference="ordnungsnummer"
             value="#{dataTableItem.ordnungsnummer}"
             label="#{msg_currentflow.MEL_Trefferliste_Ordnungsnummer}"/>
          <isy:formLabel reference="speicherungsdatum"
             value="#{dataTableItem.speicherungsdatum}"
             label="#{msg_currentflow.MEL_Trefferliste_Speicherungsdatum}"/>
        </div>
      </div>
    </div>
  </td>
</ui:composition>
----

Die Detail-Definition enthält beliebigen Inhalt.
Im Beispiel ist dies ein Formular mit der Ausgabe von drei Labels in der linken Hälfte der Tabelle.
Analog zur Row-Definition kann auf den aktuellen Treffer über die UI-Parameter `dataTableItem` und `dataTableItemRepeatStatus` zugegriffen werden.

Die weiteren Abschnitte beschreiben weiterführende Aspekte wie Filterung, Sortierung und das Selektionsverhalten von Tabellen.

==== Filterung in einer Tabelle

Zur Filterung einer Tabelle stehen das Facet `<f:tableFilter>`, die Tags `<isy:dataTableFilter>` und `<isy:dataTableFilterCleaner>` sowie das dazugehörige `DataTableFilterModel` bereit.

Im Allgemeinen muss beim Tag `<isy:dataTableFilter>` nur die Eigenschaft angegeben werden, nach der man filtern will.
Damit wird ein normales Eingabefeld für die Filterung zur verfügung gestellt.
Es gibt auch die Möglichkeit die Filterung über ein Dropdown Menü zu ermöglichen.
Dafür müssen die mögliche Einträge im Tag verschachtelt angegeben werden.

TIP: Es ist besonders wichtig, dass die Anzahl der Spalten im Header, der Filter-Zeile und den Zeilen der Datensätze übereinstimmen.
Dieser Zusammenhang wird mittels JavaScript überprüft.
Spalten, die nicht gefiltert werden sollen (bzw. können), werden mittels des Tags `<isy:dataTableFilter>` ohne Attribute beschrieben.

:desc-listing-bspTableFilter: Beispiel für die Filterung einer Tabelle
[id="listing-bspTableFilter",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-bspTableFilter}
[source, xml]
----
<f:facet name="tableFilter">
  <!-- Platzhalter für eine Spalte, die z.B. Checkboxen enthält -->
  <isy:dataTableFilter />
  <isy:dataTableFilter property="anrede" dropdown="true">
    <f:selectItem itemValue="" itemLabel="Wählen Sie aus:" />
    <f:selectItems value="#{dropdownHelper.anredeListe}" />
  </isy:dataTableFilter>
  <isy:dataTableFilter property="vorname" />
  <isy:dataTableFilter property="nachname" />
  <isy:dataTableFilter property="geburtsdatum" />
  <isy:dataTableFilterClearer />
</f:facet>
----

*Kein JavaScript*

image::image131.png[]

Die Komfortfunktionen der Filter-Zeile können ohne JavaScript nicht zur Verfügung gestellt werden.
Die Filter-Zeile ist in diesem Fall nicht vorhanden und wird auch nicht angezeigt.

[[sortierung-tabelle]]
==== Sortierung in einer Tabelle

Tabellen bieten Möglichkeiten zur Sortierung an.
Dazu müssen die einzelnen Spalten-Header über das `<isy:dataTableHeader>` Tag entsprechend konfiguriert werden.

:desc-image-tabellesortierungimkopf: Tabelle – Sortierungs-Indikator in Tabellenkopf
[id="image-tabellesortierungimkopf",reftext="{figure-caption} {counter:figures}"]
.{desc-image-tabellesortierungimkopf}
image::image183.png[align="center"]

:desc-listing-dataTableHeader2: Beispiel für dataTableHeader
[id="listing-dataTableHeader2",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-dataTableHeader2}
[source, xml]
----
<isy:dataTableHeader name="#{...}" sortable="true" sortProperty="vorname" />
----

Durch Angabe von `sortable="true"` und dem Attribut `sortProperty` werden automatisch Buttons und Symbole zur Sortierung hinzugefügt.
Beim Initialisieren des Models muss der Operationsmodus (`SERVER` oder `CLIENT`) gesetzt werden: `model.setMode(DatatableOperationMode.SERVER)`. Im Modus `CLIENT` erfolgt die Sortierung automatisch per JavaScript. Im Modus `SERVER` wird die Methode `DataTableController.updateDisplayItems(...)` aufgerufen, welche die Tabelleneinträge filtert sowie sortiert und anschließend seitenweise anzeigt.

[[selektionsverhalten-tabelle]]
==== Selektionsverhalten in einer Tabelle
Um die Selektion von Zeilen zu ermöglichen, müssen folgende Konfigurationen durchgeführt werden:

*Tabellen-Definition:* In der Tabellen-Definition (`<isy:dataTable>`) muss das Attribut `selectable="true"` gesetzt sein. Der Selektierungsmodus (einzeln, mehrere) wird über das Attribut `selectionMode` gesteuert.

*Header-Definition:* In der Header-Definition muss ein `<isy:dataTableHeader>` Tag an erster Stelle mit folgender Definition aufgenommen werden:

:desc-listing-zeilenselektion1: Zeilenselektion Schritt 1
[id="listing-zeilenselektion1",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-zeilenselektion1}
[source, xml]
----
<isy:dataTableHeader>
  <isy:dataTableRowAllSelection />
</isy:dataTableHeader>
----

*Row-Definition:* In der Row-Definition muss ein `<isy:dataTableCell>` Tag an erster Stelle mit folgender Definition aufgenommen werden:

:desc-listing-zeilenselektion2: Zeilenselektion Schritt 2
[id="listing-zeilenselektion2",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-zeilenselektion2}
[source, xml]
----
<isy:dataTableCell>
  <isy:dataTableRowSelection />
</isy:dataTableCell>
----

:desc-image-tabellemehrfachselektion: Tabelle – Mehrfachselektion über STRG Taste & Maus
[id="image-tabellemehrfachselektion",reftext="{figure-caption} {counter:figures}"]
.{desc-image-tabellemehrfachselektion}
image::image185.png[align="center"]

:desc-image-tabellemehrfachselektioncheckbox: Tabelle – Mehrfachselektion über Checkboxen
[id="image-tabellemehrfachselektioncheckbox",reftext="{figure-caption} {counter:figures}"]
.{desc-image-tabellemehrfachselektioncheckbox}
image::image186.png[align="center"]

:desc-image-textlinkkennzeichen: Textlink zur Kennzeichnung eines Objektes
[id="image-textlinkkennzeichen",reftext="{figure-caption} {counter:figures}"]
.{desc-image-textlinkkennzeichen}
image::image187.png[align="center"]

[[grosse-datenmengen-tabelle]]
==== Große Datenmengen in einer Tabelle

Tabellen können sehr viele Daten enthalten und gegebenenfalls sehr lang werden.
Um dem Benutzer den Umgang mit solchen Tabellen zu vereinfachen, werden zunächst nicht alle Daten initial in der Tabelle angezeigt.
Über einen _Mehr anzeigen_ Button oder einen Paginator kann der Benutzer sich bei Bedarf mehr Daten anzeigen lassen.

:desc-image-tabelleohnepaginator: Tabelle mit _Mehr anzeigen_ Button
[id="image-tabelleohnepaginator",reftext="{figure-caption} {counter:figures}"]
.{desc-image-tabelleohnepaginator}
image::image189.png[align="center"]

// TODO Screenshot fehlt!
//:desc-image-tabellemitpaginator: Tabelle mit Paginator
//[id="image-tabellemitpaginator",reftext="{figure-caption} {counter:figures}"]
//.{desc-image-tabellemitpaginator}
//image::xxx.png[align="center"]

Die Implementierung einer Paginierung erfolgt über das Facet `<f:tablePagination>`, das Tag `<t:dataTablePaginator>` und das dazugehörige `DataTablePaginationModel`. Die Paginierung wird beim Initialisieren des `DataTableModel` im Controller konfiguriert:

:desc-listing-implPaginierung: Implementierung Paginierung
[id="listing-implPaginierung",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-implPaginierung}
[source, java]
----
public void initialisiereModel(DataTableModel model) {
   model.getPaginationModel().setPageSize(3);
   model.getPaginationModel().setMode(PaginationMode.SIMPLE);
   updateDisplayItems(model);
}
----

In der View setzt folgendes Facet die Paginierung um:

:desc-listing-implPaginierungView: Implementierung Paginierung in der View
[id="listing-implPaginierungView",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-implPaginierungView}
[source, xml]
----
<f:facet name="tablePagination">
  <isy:dataTablePaginator />
</f:facet>
----

[[check-box-ueberschrift]]
=== Checkbox

Eine Checkbox repräsentiert eine unabhängige, nicht-exklusive Auswahl.
Der Benutzer kann beliebige Optionen auswählen.

Eine einzelne Checkbox wird über das Tag `<isy:selectBooleanCheckbox>` eingebunden.

Folgende Parameter sind Pflicht:

* `value`: Wert der Checkbox für das Databinding im Model
* `label`: Label der Checkbox
* `required`: ob eine Eingabe Pflicht ist (Standard: `false`)

Außerdem gibt es folgende optionale Parameter:

* `disabled`: ob das Eingabefeld deaktiviert ist (Standard: `false`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)
* `onchange`: JavaScript-Funktion, die bei einer Änderung des Werts aufgerufen wird

Mehrere Checkboxen werden über das Tag `<isy:selectManyCheckbox>` eingebunden.

Folgende Parameter sind Pflicht:

* `value`: Wert der Checkboxen für das Databinding (Liste von SelectItems)

Außerdem gibt es folgende optionale Parameter:

* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)

// TODO noch nicht implementiert prüfen
//__Hinweis: __Der Tri-State ist noch nicht umgesetzt.

Für Formulare existiert das Tag `<isy:formCheckbox>`, das die folgenden, zusätzlichen Parameter anbietet:

* `reference`: Referenz des Objekts für die Validierung
* `label`: Text für das Label
* `labelRight`: ob sich das Label rechts neben der Checkbox befindet (Standard: `false`)
* `labelStyleClass`: CSS-Klasse für das Label (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse für den Eingabebereich (Standard: `col-lg-6`)
* `required`: ob die Eingabe Pflicht ist (Standard: `false`)
* `optional`: ob die Eingabe eine optionale Pflichtangabe ist (Standard: `false`)
* `disabled`: ob die Checkbox deaktiviert ist (Standard: `false`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[radio-button-ueberschrift]]
==== Radio Button

Radio Buttons dienen der eindeutigen Auswahl von sich ausschließenden Optionen.
Der Benutzer kann also nur eine der Optionen auswählen.

:desc-image-ieradiobutton: Radio Button – Darstellungsbeispiel IE 9
[id="image-ieradiobutton",reftext="{figure-caption} {counter:figures}"]
.{desc-image-ieradiobutton}
image::image193.png[align="center"pdfwidth=30%]

Ein Radio Button wird über das Tag `<isy:selectOneRadio>` (bzw. `<isy:selectOneRadioInline>`) und `<isy:formSelectOneRadio>` eingebunden.

Folgende Parameter sind für `<isy:selectOneRadio>` (bzw. `<isy:selectOneRadioInline>`) Pflicht:

* `value`: Wert der Auswahl für das Data-Binding
* `selectItems`: Liste der auszuwählenden Werte

Außerdem gibt es folgende optionale Parameter:

* `disabled`: ob die Darstellung nur lesend erfolgen soll (Standard: `false`, nur `<isy:selectOneRadio>`)
* `showPrintView`: spezifisches Flag zur Erkennung der Druckansicht (Standard: `basisModel.showPrintView`)

Für `<isy:formSelectOneRadio>` sind zusätzlich folgende Attribute zulässig:

* `reference`: Referenz des Objekts für die Validierung
* `inline`: ob die Radio Buttons inline angezeigt werden (Standard: `false`)
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse für das Label (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse für den Eingabebereich (Standard: `col-lg-6`)
* `inlineInputStyleClass`: CSS-Klasse für Inline-Radio Buttons
* `required`: ob die Eingabe Pflicht ist (Standard: `false`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[navigation]]
=== Navigation

[[horizontale-navigation]]
==== Horizontale Navigation

Die Navigationsleiste im Header Bereich lässt sich konfigurierbar gestalten.
Hierzu muss jede Anwendung zunächst eine Instanz von `NavigationMenuGenerierenAusKonfiguration` im Application-Context zur Verfügung stellen und korrekt konfigurieren.
Die Bean benötigt lediglich einen `AufrufkontextVerwalter` und eine `Konfiguration`, um korrekt zu funktionieren.

:desc-listing-bspBeanHauptnavigation: Beispiel für die Deklaration der Bean
[id="listing-bspBeanHauptnavigation",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-bspBeanHauptnavigation}
[source, xml]
----
<bean id="navigationMenuGenerierenStrategie" class="de.bund.bva.isyfact.common.web.jsf.components.navigationmenu.generieren.impl.NavigationMenuGenerierenAusKonfiguration">
	<property name="konfiguration" ref="konfiguration"/>
	<property name="aufrufKontextVerwalter" ref="aufrufKontextVerwalter"/>
</bean>
----

Ein einzelner Eintrag in der Navigation lässt sich nach folgendem Schema konfigurieren:

:desc-listing-beispielHorizontaleNavigation: Beispiel zur Konfiguration der horizontalen Navigation
[id="listing-beispielHorizontaleNavigation",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-beispielHorizontaleNavigation}
[source,properties]
----
gui.navbar.applikationsgruppe.1.wert = JSF-Vorlagen
gui.navbar.applikationsgruppe.1.link = /isy-webgui/app/index.html
gui.navbar.applikationsgruppe.1.farbe = #337299
gui.navbar.applikationsgruppe.1.reihenfolge = 1
gui.navbar.applikationsgruppe.1.rollen =

gui.navbar.applikationsgruppe.1.anwendung.1.wert  = JSF-Steuerelemente
gui.navbar.applikationsgruppe.1.anwendung.1.link = /isy-webgui/app/jsfSteuerelementeFlow
gui.navbar.applikationsgruppe.1.anwendung.1.reihenfolge  = 1
gui.navbar.applikationsgruppe.1.anwendung.1.rollen =

gui.navbar.applikationsgruppe.1.anwendung.2.wert  = 4-Augen Prinzip
gui.navbar.applikationsgruppe.1.anwendung.2.link = /isy-webgui/app/vieraugenFlow
gui.navbar.applikationsgruppe.1.anwendung.2.reihenfolge  = 2
gui.navbar.applikationsgruppe.1.anwendung.2.rollen =

gui.navbar.applikationsgruppe.1.anwendung.3.wert  = Nachrichten
gui.navbar.applikationsgruppe.1.anwendung.3.link = /isy-webgui/app/nachrichtenFlow
gui.navbar.applikationsgruppe.1.anwendung.3.reihenfolge  = 3
gui.navbar.applikationsgruppe.1.anwendung.3.rollen = Beispielrolle
----

Das Schlüsselwort `applikationsgruppe` und die darauf folgenden Parameter beziehen sich immer auf einen Eintrag in der Leiste selbst.
Das Schlüsselwort `anwendung` und die darauf folgenden Parameter beziehen sich wiederum immer auf einen Eintrag innerhalb des Flyout Menüs eines Eintrags innerhalb der Leiste.
Die Zahlen innerhalb der Konfigurationsparameter dienen der logischen Zuordnung.
Im obigen Beispiel sieht man schnell, dass es eine Applikationsgruppe gibt und dieser Gruppe drei Anwendungen zugeordnet sind.
Die Zahlen _müssen_ aus technischer Sicht keiner strikten Sequenz folgen (etwa `\*.anwendung.1.*`, `\*.anwendung.2.*` usw.), aber dies bietet sich aufgrund der Lesbarkeit an.

Für Einträge innerhalb der Leiste selbst (`applikationsgruppe`) existieren folgende Parameter:

* `wert`: Das Label zur Anzeige.
* `link`: Der Link, der aufgerufen wird, wenn der Anwender auf den Eintrag klickt.
* `farbe`: Die Farbe der Applikationsgruppe als Hexwert.
* `reihenfolge`: Ein numerischer Wert für die Reihenfolge der Anzeige der Applikationsgruppen innerhalb der horizontalen Navigation.
* `rollen`: Die benötigten Rollen zur Anzeige als komma-separierte Liste. Der Besitz mindestens einer Rolle ist ausreichend, um den Eintrag zu sehen.

Für Einträge innerhalb eines Flyout Menüs (`anwendung`) existieren folgende Parameter:

* `wert`: Das Label zur Anzeige.
* `link`: Der Link, der aufgerufen wird, wenn der Anwender auf den Eintrag klickt.
* `reihenfolge`: Ein numerischer Wert für die Reihenfolge der Anzeige der Anwendung innerhalb des Flyout Menüs.
* `rollen`: Die benötigten Rollen zur Anzeige als komma-separierte Liste. Der Besitz mindestens einer Rolle ist ausreichend, um den Eintrag zu sehen.

Grundsätzlich sind alle Werte optional.
Damit ist jedoch lediglich gemeint, dass die Anwendung keinen Fehler erzeugt, falls ein Wert für eine Applikationsgruppe bzw. Anwendung überhaupt nicht konfiguriert ist.
Nicht benötigte Parameter können daher einfach weggelassen werden.
Um einen sinnvollen Einsatz zu gewährleisten sollten immer mindestens `wert` und `link` konfiguriert sein.

Die Navigation würde im obigen Beispiel den Eintrag _JSF-Vorlagen_ enthalten.
Wenn die Maus sich über dem Eintrag befindet, würde das Flyout Menü aufklappen und die Einträge _JSF-Steuerelemente_, _4-Augen Prinzip_ und _Nachrichten_ würden sichtbar werden.
_Nachrichten_ ist für den jeweiligen Nutzer jedoch nur sichtbar, wenn er die Rolle _Beispielrolle_ besitzt.
Weitere Rollen lassen sich komma-separiert angeben.
Ein Anwender sieht den jeweiligen Eintrag, sobald er mindestens eine der benötigten Rollen besitzt.

:desc-image-navigationMitSubmenu: Navigation mit ausgeklapptem Flyout Menü
[id="image-navigationMitSubmenu",reftext="{figure-caption} {counter:figures}"]
.{desc-image-navigationMitSubmenu}
image::horizontale-navigation-submenu.png[align="center", pdfwidth="60%"]

Das folgende Beispiel zeigt, wie die Navigationsleiste um einen weiteren Eintrag samt Flyout Menü erweitert werden könnte:

:desc-listing-beispielHorizontaleNavigationErweitert: Erweiterung der Konfiguration der horizontalen Navigation
[id="listing-beispielHorizontaleNavigationErweitert",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-beispielHorizontaleNavigationErweitert}
[source,properties]
----
gui.navbar.applikationsgruppe.2.wert = Layouts
gui.navbar.applikationsgruppe.2.link = /isy-webgui/app/page-details.html
gui.navbar.applikationsgruppe.2.farbe = #F59D35
gui.navbar.applikationsgruppe.2.reihenfolge = 2

gui.navbar.applikationsgruppe.2.anwendung.1.wert  = Applikationsseite
gui.navbar.applikationsgruppe.2.anwendung.1.link = /isy-webgui/app/beispielApplikationsseiteFlow
gui.navbar.applikationsgruppe.2.anwendung.1.reihenfolge  = 1

gui.navbar.applikationsgruppe.2.anwendung.2.wert  = applikationsgruppe-Detailseite
gui.navbar.applikationsgruppe.2.anwendung.2.link = /isy-webgui/app/applikationDetailseiteFlow
gui.navbar.applikationsgruppe.2.anwendung.2.reihenfolge  = 2
----

[[linksnavigation]]
==== Linksnavigation

Die Linksnavigation ist ein optionales Element und kann zur weiteren Strukturierung einer Applikation dienen.
Sie kann über ein Icon ein- und ausgeblendet werden. 

Linksnavigationen werden durch den Controller `LinksnavigationController` und das Model `LinksnavigationModel` realisiert.
Der Controller ist bereits im `ApplikationseiteController` eingebunden und muss daher nicht explizit aktiviert werden.

Linksnavigationen werden in der Konfigurationsdatei `gui-linksnavigation.properties` konfiguriert.
Die Konfigurationsdatei liegt im Deployment.
Es handelt sich nicht um eine betriebliche Konfiguration.
Die Konfiguration muss in der Konfigurations-Bean `konfiguration` eingebunden werden.
Über die Variable `gui.linksnavigation.ids` wird zunächst eine Liste an IDs für die jeweiligen Linksnavigationen konfiguriert.
Für jede ID wird anschließend die Linksnavigation konfiguriert.

:desc-listing-beispielLinksnavigation: Beispiel zur Konfiguration der Linksnavigation
[id="listing-beispielLinksnavigation",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-beispielLinksnavigation}
[source,properties]
----
gui.linksnavigation.ids=linksnavigationbeispiel,jsfSteuerelemente

gui.linksnavigation.linksnavigationbeispiel.headline=Beispiellinkliste
gui.linksnavigation.linksnavigationbeispiel.1.text=Beispielseite A
gui.linksnavigation.linksnavigationbeispiel.1.link=beispiellinkaFlow
gui.linksnavigation.linksnavigationbeispiel.2.text=Beispielseite B
gui.linksnavigation.linksnavigationbeispiel.2.link=beispiellinkbFlow

gui.linksnavigation.jsfSteuerelemente.headline=Überschrift
gui.linksnavigation.jsfSteuerelemente.1.text=JSF-Steuerlemente
gui.linksnavigation.jsfSteuerelemente.1.link=jsfSteuerelementeFlow
----

Anhand des aktuell aktiven Flows wird automatisch die korrekte Linksnavigation dargestellt.
Der enthaltene Link zum aktiven Flow wird automatisch als ausgewählt dargestellt.
Wenn ein Subflow aktiv ist, dann wird immer der ursprünglich aufrufende Flow als der aktive Flow angesehen.
Wenn keine passende Linksnavigation gefunden wird, bleibt der Bereich auf der Seite leer.
Weiterhin kann auf einer Applikationsseite eine individuelle Linksnavigation manuell eingebunden werden.

[[quicklinks]]
==== Quicklinks

Muss der Benutzer häufig auf bestimmte Funktionen oder Objekte in einer Anwendung zugreifen, so kann es sinnvoll sein ihm Schnellzugriffe, sogenannte Quicklinks, auf diese Funktionen/Objekte zur Verfügung zu stellen.

:desc-image-quicklinksunterhalblinksnavigation: Quicklinks unterhalb der Linksnavigation
[id="image-quicklinksunterhalblinksnavigation",reftext="{figure-caption} {counter:figures}"]
.{desc-image-quicklinksunterhalblinksnavigation}
image::image202.png[align="center",pdfwidth=30%]

:desc-image-quicklinksaufdashboard: Quicklinks auf Dashboard
[id="image-quicklinksaufdashboard",reftext="{figure-caption} {counter:figures}"]
.{desc-image-quicklinksaufdashboard}
image::image203.png[align="center",pdfwidth=30%]

Quicklinks werden durch den Controller `QuicklinksController` und das Model `QuicklinksModel` realisiert.
Zur Nutzung müssen Controller und Model in den jeweiligen Controller bzw. das Model der Seite integriert werden.
Ein einzelner Quicklink (`QuicklinkselementModel`) besitzt folgende Attribute:

* `id`: ID des Quicklinks
* `anzuzeigenderText`: Text des Quicklinks
* `link`: Ziel des Quicklinks

Der `QuicklinksController` stellt in der Hauptsache folgende Methoden bereit:

* `fuegeQuicklinkHinzu(QuicklinkselementModel model)`: Hinzufügen eines neuen Quicklinks auf der aktuellen Seite,
* `entferneQuicklink(String id)`: Entfernen des Quicklinks von der Seite.

Quicklinks werden in der Session des Anwenders abgespeichert.

Die zuletzt hinzugefügten Quicklinks werden oben dargestellt. 
Wenn ein Quicklink hinzugefügt wird, der bereits vorhanden ist (Identifikation über seine ID), dann werden der Link und der anzuzeigende Text des Quicklinks aktualisiert und der Quicklink wird nach oben gesetzt.
Wenn die maximale Anzahl an Quicklinks erreicht wird (konfigurierbar über den Konfigurationsparameter `gui.quicklinks.max.anzahl`), dann wird der älteste Quicklink entfernt.

Weiterhin gibt es die Möglichkeit, Quicklinks in Gruppen zu organisieren (z.B. aktuelle Suchanfrage, letzte Suchanfragen).
Gruppen von Quicklinks können abhängig vom aktuellen Flow angezeigt werden.

Weiterhin ist es möglich, die Quicklinks statisch (analog zur Linksnavigation) zu konfigurieren.
Hierzu können in der Konfiguration folgende Einstellungen hinterlegt werden:

* `gui.quicklinks.gruppenIds`: kommaseparierte Liste der Gruppen
* `gui.quicklinks.<gruppeId>.text`: Text der Gruppe zur Anzeige
* `gui.quicklinks.<gruppeId>.contextflow`: kommaseparierte Liste an Flows, welche die Anzeige der Gruppe erlauben.

Ist keine Konfiguration bzgl. Flows gesetzt, so wird die Gruppe immer angezeigt.


// TODO noch nicht implementiert prüfen
//[[editaable-row]]
//==== Editable Row
//
//Editable Rows sind flexible Zeilen deren Inhalte separat bearbeitet werden können.
//
//Derzeit nicht umgesetzt.

[[breadcrumbs]]
==== Breadcrumbs auf der Detailseite

Auf der Detailseite einer Applikation kann in der Titelzeile ein Location-Breadcrumb eingeblendet werden.
Der Breadcrumb zeigt den Pfad zum aktuellen Element (<<image-breadcrumb>>).

:desc-image-breadcrumb: Breadcrumb in der Titelzeile der Detailseite der Applikation
[id="image-breadcrumb",reftext="{figure-caption} {counter:figures}"]
.{desc-image-breadcrumb}
image::breadcrumb.png[align="center", pdfwidth=40%]

Die angezeigten Daten werden nicht automatisch angezeigt, sondern müssen programmatisch gesetzt werden.
Hierzu wird die Model-Klasse `LocationBreadcrumbModel` entsprechend befüllt.
Ist das Breadcrumb-Model leer, wird der Breadcrumb nicht angezeigt.

Eine Instanz des Breadcrumb-Models wird über das `BasisModel` bereitgestellt.
Unterstützt wird die Anzeige von Hierarchieebene über die Methoden `pushHierarchiebene() / popHierarchiebene / clearHierarchiebenen()` und die Angabe eines Objektnamens per `setObjektname(String)`.
Mit dem in <<listing-breadcrumbmodel>> gezeigten Code wird der in <<image-breadcrumb>> gezeigte Breadcrumb realisiert.

:desc-listing-breadcrumbmodel: Verwendung des Breadcrumb-Models
[id="listing-breadcrumbmodel",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-breadcrumbmodel}
[source,java]
----
public void initialisiereBreadcrumbModel(LocationBreadcrumbModel model) {
    model.setObjektname("Testobjekt / ID-1234");
    model.pushHierarchiebene("Ebene 1");
    model.pushHierarchiebene("Ebene 2");
}
----


[[selektion-ueberschrift]]
=== Selektion

Dieser Abschnitt beschreibt Patterns zur Selektion von Daten.

[[suche-ueberschrift]]
==== Suche

Ein Beispiel zur Umsetzung eines Suchformulars findet sich im Abschnitt <<layout-von-Formularen>>.

// TODO noch nicht implementiert prüfen
//[[filter-ueberschift]]
//==== Filter
//
//Diese Funktion ist derzeit noch nicht umgesetzt.

==== Toggle Filter

Ein Toggle-Filter wird über das Tag `<isy:toggleFilter>` eingebunden.

Ein Toggle-Filter besitzt folgende notwendige Parameter:

* `action`: auszuführende Aktion

Außerdem gibt es folgende optionale Parameter:

* `value`: ausgewählter Filter
* `label`: Text für das Label
* `styleClass`: zu ergänzende Style-Klassen
* `execute`: welche Felder bei einem AJAX-Aufruf ausgewertet werden (Standard: `@form`)
* `render`: welcher Seitenbereich nach dem AJAX-Aufruf aktualisiert wird (Standard: `@form`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

[[browse-und-collect]]
==== Browse & Collect

Mit Browse & Collect kann der Benutzer eine Liste von Objekten erstellen.
Hierbei werden Objekte von einer Quellliste in eine Zielliste übertragen.

Browse and Collect kann über das Tag `<isy:browseAndCollect>` (bzw. `<isy:formBrowseAndCollect>`) eingebunden werden.

Folgende Parameter sind für `<isy:browseAndCollect>` Pflicht:

* `reference`: Referenz des Objekts
* `value`: Wert der Auswahl für das Databinding

Außerdem gibt es folgende optionale Parameter:

* `disabled`: ob die Liste deaktiviert ist (Standard: `false`)
* `browsecollectStyleClass`: CSS-Klasse für die Komponente
* `size`: Anzahl der Zeilen, die sichtbar sind
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

Folgende Parameter sind zusätzlich für `<isy:formBrowseAndCollect>` zulässig:

* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse für das Label (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse für den Eingabebereich (Standard: `col-lg-6`)
* `validationModel`: spezifisches Validation-Model (Standard: `validationModel`)

[[master-detail]]
==== Master-Detail

Bei dem Master-Detail Konzept werden Informationen eines Master-Objekts und dessen Details auf einer Seite dargestellt.
Zum Beispiel kann eine Liste von Objekten in einer Tabelle (Master) dargestellt werden.
Die dazugehörigen Informationen (Detail) werden je nach Layout in einem Bereich darunter oder daneben angezeigt.

Die Master-Detail Ansicht kann durch die Nutzung von einfachen Elementen (Tabelle, Buttons, bedingtes Rendern (`ui:fragment`)) umgesetzt werden.

[[gruppierung]]
=== Gruppierung

Dieser Abschnitt beschreibt Patterns zur Gruppierung von Daten.

==== Panel

Für die Gruppierung von Daten steht das Tag `<isy:panel>` bereit. Damit können entsprechende Bereiche zur Gruppierung erstellt werden. Ein Expander kann durch die Angabe von `collapse="true"` und der Angaben eines entsprechenden Models in der Komponente `<isy:panel>` erzeugt werden. Über das Model lässt sich auch der initiale Zustand steuern.

Das Tag bietet folgende Attribute:

* `collapse`: ob das Panel eingeklappt werden kann (falls ja, so muss auch ein `panelModel` angegeben werden)
* `panelModel`: Model des Panels, das von `PanelModel` abgeleitet wird, und Teil des Seitenmodels sein sollte
* `globalConfig`: Eine spezifische globale Konfiguration, falls notwendig.

Das Tag bietet folgende Facets:

* `panelHeader`: Header des Panels
* `panelButtons`: Buttons am Header des Panels
* `panelBody`: Inhalt des Panels (kann auch direkt über Kindelemente angegeben werden)

Zur Gruppierung von mehreren Panels sollte das Tag `<isy:panelGroup>` verwendet werden.
In diesem können die anderen Panels geschachtelt werden. Das Tag besitzt folgende Parameter:

* `headerPanel`: ob die Gruppe als Container für den Header des Inhaltsbereichs dient; falls ja werden entsprechende CSS-Klassen für das Layouting eingebunden (Standard: `false`)

==== Seitentoolbar

Die Seitentoolbar ist Teil des `BasisModel`.
Auf das `SeitentoolbarModel` kann daher über den `BasisController` zugegriffen werden.
Der `ApplikationseiteController` und der `DetailseiteController` konfigurieren dieses Model entsprechend den Vorgaben automatisch.

Über die Template-Engine (`ui:insert` / `ui:define`) werden weiterhin folgende Bereiche zur Verfügung gestellt.
Konkrete Seiten können dadurch Einfluss auf das Aussehen der Seitentoolbar nehmen:

* `seitentoolbarLinksButtons`: fügt Anpassungen auf der linken Seite ein,
* `seitentoolbarMitteButtons`: fügt Anpassungen in der Mitte (zentriert) ein,
* `seitentoolbarRechtsButtons`: fügt Anpassungen auf der rechten Seite ein.

// TODO noch nicht implementiert prüfen
//==== Tabellen Toolbar
//
//Derzeit noch nicht umgesetzt.

[[layout-von-Formularen]]
=== Layout von Formularen

Die Umsetzung von Formularen erfolgt mit den gängigen CSS-Klassen von Bootstrap.
Um ein einfaches Suchformular umzusetzen genügt z.B. folgender Code:

:desc-listing-bspFormularumsetzung: Beispiel für Formularumsetzung
[id="listing-bspFormularumsetzung",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-bspFormularumsetzung}
[source, xml]
----
<div class="form-horizontal">
  <div class="row row-df">
    <div class="col-lg-6">
      <isy:formInput reference="vorname" ... />
      <isy:formInput reference="nachname" .... />
    </div>
    <div class="col-lg-6">
      <isy:formInput reference="geburtsort" ... />
      <isy:formSelectOneDropdown reference="geschlecht" ... />
      <isy:formListpicker reference="staatsangehoerigkeit" ... />
    </div>
  </div>
</div>

...

<isy:buttonRow alignRight="true">
  <isy:button id="suchen" action="suchen" value="#{...}" />
  <isy:button id="suchfelderLeeren" action="suchfelderLeeren" value="#{...}" />
</isy:buttonRow>
----

Durch ein `<div>`-Tag mit der CSS-Klasse `form-horizontal` wird der Bereich für das Formular definiert.
In darin geschachtelten `<div>`-Tags mit der CSS-Klasse `row` ist das aus 12 Spalten bestehende Layout von Bootstrap aktiv.
Innerhalb dieser Tags können die Formularkomponenten problemlos verwendet werden.
// (`row-df` ist dabei eine Spezialanpassung zur Nutzung von Bootstrap unter IE8 ohne JavaScript).

==== Formularkomponenten

Neben den normalen Bedienelementen existieren auch Formularkomponenten (erkennbar an dem Präfix `<isy:form...>`).
Diese Komponenten integrieren sich direkt in ein Formular.
Sie bringen ein Label sowie eine integrierte Validierung mit sich.
Die einzelnen Formularkomponenten sind zusammen mit ihren jeweiligen Bedienelementen beschrieben.

In den Formularen kann durch die Verwendung von `<isy:formDefaultButton>` ein Standard-Button zum Abschicken des Formulars definiert werden.
Ein Druck auf kbd:[Enter] führt die Aktion aus.
Diese Funktionalität ist nur bei aktiviertem JavaScript verfügbar. 

Das Tag `<isy:formCustom>` bietet schließlich die Möglichkeit, anwendungsspezifische Elemente in ein Formular zu integrieren.
Die Elemente innerhalb dieses Tags werden dann mit einem Label an der korrekten Stelle im Formular angezeigt.

Die Komponente unterstützt folgende Attribute:

* `reference`: Referenz des Objekts für die Validierung
* `label`: Text für das Label
* `labelStyleClass`: CSS-Klasse für das Label (Standard: `col-lg-6`)
* `inputStyleClass`: CSS-Klasse für den Eingabebereich (Standard: `col-lg-6`)
* `escapeLabel`: ob Sonderzeichen für das Label escaped werden sollen (Standard: `false`)
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)
* `breakWords`: ob der Überlauf von Text in die nächste Zeile erlaubt ist (Standard: `true`)

Die Komponente besitzt folgende Facets:

* `contentRight`: Inhalt, der rechts vom eingefügten Element angezeigt wird

// TODO noch nicht implementiert prüfen
//[[autosuggestion]]
//=== Autosuggestion
//
//Derzeit noch nicht umgesetzt.

[[platzhalter-ueberschrift]]
=== Platzhalter

Platzhalter können über das Attribut `placeholder` in den Bedienelementen angegeben werden.
Die Angabe von Platzhaltern ist derzeit noch nicht in allen Bedienelementen möglich.

[[tooltips-ueberschrift]]
=== Tooltips

Das Tag `<isy:tooltip>` bindet einen Tooltip ein.

Es besitzt folgende Parameter:

* `text`: Text, der bei Hover über das Element angezeigt werden soll
* `title`: optionale Überschrift, die fett über dem Text angezeigt wird
* `globalConfig`: spezifische, globale Konfiguration (Standard: `globalConfigurationModel`)

// TODO noch nicht implementiert prüfen
//[[fortschrifttsanzeige]]
//=== Fortschrittsanzeige
//
//Derzeit noch nicht umgesetzt.

[[anzeige-optionale-Pflichtfelder]]
=== Anzeige von Pflichtfeldern und optionalen Pflichtfeldern

Pflichtfelder können über die Angabe des Attributs `required` am entsprechenden Bedienelement gesetzt werden.

Optionale Pflichtfelder bedeuten, dass von mehreren, alternativen Eingaben mindestens eine benötigt wird, um das Formular verarbeiten zu können.

NOTE: Beispielsweise könnte in einem Formular die Eingabe entweder der Nummer des Personalausweises oder der Nummer des Führerscheins als Altersnachweis dienen.
Wenn der Altersnachweis Pflicht ist, sind die beiden Felder optionale Pflichtfelder.

[[nachrichten-ueberschrift]]
=== Anzeige von Nachrichten

Der `MessageController` erlaubt es, Nachrichten über dem Inhaltsbereich einer Seite auszugeben.
Er bietet folgende Methoden für Hinweise, Erfolgsmeldungen, Warnungen und Fehlermeldungen an:

*  `void writeInfoMessage(String information)`
*  `void writeSuccessMessage(String success)`
*  `void writeWarnMessage(String warning, String summary)`
*  `void writeErrorMessage(String error, String summary)`

Weiterhin können Anwendungen die aktuell vorhandenen Meldungen auslesen:

*  `List<FacesMessage> getCurrentInfoMessages()`
*  `List<FacesMessage> getCurrentSuccessMessages()`
*  `List<FacesMessage> getCurrentWarnMessages()`
*  `List<FacesMessage> getCurrentErrorMessages()`

Das Tag `<isy:messages>` zeigt Nachrichten im Basis-Layout automatisch und ohne weiteres zutun an.

[[validierung-ueberschrift]]
=== Validierung

Der `ValidierungController` erlaubt es, der aktuellen Seite über folgende Methode Nachrichten der Validierung hinzuzufügen:

* `void processValidationMessages(List<ValidationMessage> validationMessages)`

Eine einzelne Nachricht besteht dabei aus folgenden Attributen:

* `code`: Der (Fehler)Code der Nachricht (z.B. `ISYWG99999`)
* `reference`: Die Referenz auf den Fehler (z.B. `person.geburtsdatum`)
* `readableReference`: Die lesbare Darstellung der Referenz (z.B. "Geburtsdatum")
* `message`: Text der Nachricht (z.B. "Geburtsdatum liegt weniger als 18 Jahre zurück.")

Validierungsnachrichten werden nur für den aktuellen Aufruf (FlashScope) angezeigt.
Wenn JavaScript nicht aktiviert ist, werden alle Validierungsnachrichten in einer Liste angzeigt.
Auf den Tooltip wird verzichtet.
Für die Zuordnung von Validierungsnachrichten und Eingabefeld wird das Attribut `reference` verwendet, welches auch in der entsprechenden Formularkomponente angegeben werden muss.

// TODO Diese Klasse gibt es in der isy-web nicht!
//Für den Einsatz mit der `rf-validation` (Bean Validation) wird bereits ein `GuiValidator` mitgeliefert, welcher direkt ValidationMessages liefert.
//Diese können dann dem `ValidationController` übergeben werden.
//Als Referenz wird dabei automatisch der Property-Path der `ConstraintViolation` verwendet.

=== 4-Augen-Prinzip

Einige JSF-Bedienelemente unterstützen das 4-Augen-Prinzip. Hierbei müssen Eingaben erst von einer zweiten Person bestätigt werden, bevor sie in das Datenmodell übernommen wird.

// TODO Unterstützung des 4-Augen-Prinzips inkl. Einsatz und Codebeispielen beschreiben!
//Die Steuerung der Bedienelemente geschieht über die folgenden Attribute:
//
//* `fourEyesMode`:
//* `fourEyesLastValue`:

Zu den folgenden Bedienelementen existieren Varianten für das 4-Augen-Prinzip.
Die Konfiguration der Bedienelemente ist bis auf die hinzugefügten Attribute zur Unterstützung des 4-Augen-Prinzips gleich.

:desc-table-fourEyes: JSF-Bedienelemente für das 4-Augen-Prinzip
[id="table-fourEyes",reftext="{table-caption} {counter:tables}"]
.{desc-table-fourEyes}
[cols="4a,5a",options="header"]
|====
|Bedienelement                    | Variante für das 4-Augen-Prinzip
|`<isy:actionInput />`            | `<isy:actionInputWithFourEyes />`
|`<isy:formActionInput />`        | `<isy:formActionInputWithFourEyes />`
|`<isy:formCheckbox />`           | `<isy:formCheckboxWithFourEyes />`
|`<isy:formCurrencyInput />`      | `<isy:formCurrencyInputWithFourEyes />`
|`<isy:formDate />`               | `<isy:formDateWithFourEyes />`
|`<isy:formInput />`              | `<isy:formInputWithFourEyes />`
|`<isy:formNumericInput />`       | `<isy:formNumericInputWithFourEyes />`
|`<isy:formSelectOneDropdown />`  | `<isy:formSelectOneDropdownWithFourEyes />`
|`<isy:formTextarea />`           | `<isy:formTextareaWithFourEyes />`
|`<isy:selectBooleanCheckbox />`  | `<isy:selectBooleanCheckbox />`
|`<isy:selectOneDropdown />`      | `<isy:selectOneDropdownWithFourEyes />`
|====

[[Druckaufbereitung]]
== Druckaufbereitung

[[druck-von-masken]]
=== Druck von Masken

Für den Druck von Masken wird ein eigenes Stylesheet `print.css` verwendet.
In diesem Stylesheet kann die Anzeige für den Druck optimiert aufbereitet werden.
Zum Beispiel sollten nicht benötigte Elemente ausgeblendet und Farben für den Druck optimiert werden.

Für die Druckvorschau einer Seite sollten die benutzten Widgets so aufbereitet werden, dass alle Inhalte auf der Seite
angezeigt werden (z.B. bei Tabs alle Tabs anzeigen).

Im Styleguide <<Styleguide>> finden sich Beispiele für Druckansichten.

:desc-image-seitendruck1: Seitendruck über Druck-Funktion des Browsers
[id="image-seitendruck1",reftext="{figure-caption} {counter:figures}"]
.{desc-image-seitendruck1}
image::image96.png[align="center", scaledwidth="96%"]

Für jede Seite besteht die Möglichkeit eine generische Druckansicht anzuzeigen.
Diese Druckansicht kann in einem eigenene View-State definiert werden.
Durch Aufruf des `BasisController` s wird sie aktiviert oder deaktiviert.

Beispiel:

:desc-listing-druckAnsichtGenerisch: Generische Druckansicht anzeigen
[id="listing-druckAnsichtGenerisch",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-druckAnsichtGenerisch}
[source, xml]
----
<view-state id="auskunftAnzeigenDruckansichtViewState" model="auskunftAnzeigenModel">
    <on-entry>
       <evaluate expression="basisController.showPrintView()"/>
    </on-entry>
</view-state>
----

Über den Vererbungsmechanismus zwischen XHTML Seiten oder durch Angabe einer spezifischen View kann dadurch die komplette Seite in eine Druckansicht versetzt werden.
In der Druckansicht werden alle Elemente ohne JavaScript angezeigt und das Format entsprechend angepasst.
Mit der Druckfunktion des Browsers kann diese dann ausgedruckt werden.
Ruft man die Druckfunktion des Browsers direkt auf (ohne zuvor auf die Druckansicht geöffnet zu haben), so wird nur das angepasste CSS (`print.css`) verwendet.
Es erfolgen keine spezifischen Anpassungen von Elementen (z.B. alle Tabs anzeigen).

Das Tag `<isy:print-metainformation>` kann benutzt werden, um Metainformationen zum Druck anzuzeigen.
Der Inhalt dieses Tags wird nur ausgegeben, sofern die Druckansicht aktiviert ist.
Es enthält den Parameter `warning`, der einen Text enthält, welcher ausgegeben werden soll, falls ein Nutzer die Druckfunktion des Browsers nutzt, jedoch nicht die Druckansicht aktiviert hat.
Standardmäßig ist der Parameter leer.

[[drucken-bestimmter-inhaltesbereiche]]
=== Druck bestimmter Inhaltsbereiche

Neben der allgemeinen Druck-Funktion des Browsers kann der Benutzer über explizite Drucken-Buttons bestimmte Bereiche ausdrucken.

Für eine spezifische Druckansicht von Komponenten kann über einen eigenen View-State die generische Druckansicht (siehe Drucklayout) verwendet werden.
Alternativ dazu können die Inhalte der Druckansicht auch selbst definiert und optimiert werden.
Zur Prüfung, ob die Druckansicht aktiviert wurde, dient das `BasisModel`.


[[behandlung-von-fehlern]]
== Fehlerbehandlung

In diesem Kapitel wird die Behandlung von Fehlern beschrieben.
Dabei sind folgende Arten von Fehlern zu unterscheiden:

* Validierungsfehler
* Exceptions innerhalb des Dialogablaufs (AWK)
* Exceptions innerhalb des Dialogablaufs (GUI)
* Exceptions außerhalb des Dialogablaufs
* Exceptions innerhalb des Clients

*Darstellung von Fehlern*

Die Darstellung von Fehlern wird von der Bibliothek `isy-web` über das JSF-Seitentemplate `basis.xhtml` vorgenommen.
Die Fehlermeldungen werden hierbei im Kopfbereich des Applikations-Inhaltsfensters angezeigt.

Für Fehler beim Zugriff auf den Anwendungskern kann zusätzlich eine Fehlerbehandlung im Controller eingeführt werden (try/catch).

[[umgang-mit-validierungsfehlern]]
=== Umgang mit Validierungsfehlern

Um Validierungsfehler innerhalb der Masken bei den fehlerhaften Feldern darzustellen, besitzt jede Formularkomponente das Attribut `reference` (siehe <<validierung-ueberschrift>>).
Dadurch können Validierungsfehler den entsprechenden Feldern zugeordnet werden.

In bestimmten Fällen kann es auch notwendig sein, zusätzliche Validierungsprüfungen in GUI-Komponenten bereitzustellen (z.B. wenn die GUI je nach Eingabe unterschiedliche Aufrufe des Anwendungskerns durchführt).
Diese sollten durch einen `evaluate` Aufruf innerhalb des Flows vor dem eigentlichen Zustandsübergang durchgeführt werden.
Die Nutzung des Validierungsmechanismus von Spring Webflow ist grundsätzlich möglich, bringt jedoch auch Nachteile mit sich, da der Aufruf der Validierung auf einer Namenskonvention von View States und Transitionen beruht und bei Umbenennungen sehr fehleranfällig ist.
Durch den Aufruf der Validierung mit `evaluate` wird die Validierung daher explizit und sichtbar definiert.

Bei der Übermittlung von Werten in JSF müssen die Vorgaben aus Kapitel <<datenkonvertierung-fuer-darstellung-und-eingabe>> beachtet werden:
Die Eingabe von ungültigen Werten (z.B. ungültiges Datum, Buchstaben in einem Zahlenfeld) muss grundsätzlich möglich sein.
Ggf. müssen entsprechende Datentypen und JSF-Converter erzeugt werden.
Die Validierung in der GUI, aber spätestens im Anwendungskern, muss die fehlerhafte Eingabe feststellen.
Die Validierung über JSF ist derzeit nicht vorgesehen.
// TODO Nachprüfen!
// (keine Unterstützung durch den Styleguide).

[[behandlung-von-exceptions-innerhalb-der-verarbeitung-im-awk]]
=== Behandlung von Exceptions innerhalb der Verarbeitung im AWK

Innerhalb der Verarbeitung von Dialogaktionen können Exceptions auftreten.
Sofern diese nicht ohnehin behandelt werden, müssen sie innerhalb der GUI-Komponenten behandelt werden.
Der jeweilige Controller muss dabei durch eine Exception-Fassade (try/catch) sicherstellen, dass auftretende Fehler nicht in die Dialogsteuerung weitergegeben werden.
So können checked und unchecked Exceptions abgefangen werden.
Der `MessageController` bietet hierzu Methoden (`writeException`, `writeAndLogException`) zum Loggen und Erzeugen von Fehlern/Warnungen im <<nachrichten-ueberschrift,Nachrichtenbereich>> an.
Das dort implementierte Exception Handling unterscheidet fachliche und technische Exceptions.
Während fachliche Fehler mit einer möglichst aussagekräftigen Fehlermeldung in der Oberfläche angezeigt werden müssen, soll für technische Fehler nur eine allgemeine Fehlermeldung angezeigt werden.

==== Ausgabe für fachliche Exceptions

* Im Error-Log und über die GUI: *{Fehler-ID}: {Fehlernachricht} (Referenzcode: {UUID})*

Weil die Fehlertexte der fachlichen Fehler in der GUI angezeigt werden, ist die Verwendung von spezialisierten Exceptions anzuraten, die Fehlertexte enthalten, die für die Anzeige in der GUI geeignet sind.
Hierzu finden sich weitere Informationen im Dokument <<KonzeptFehlerbehandlung>>.

[[ausgabe-fuer-technische-exceptions]]
==== Ausgabe für technische Exceptions

* Im Error-Log: *{Fehler-ID}: {Fehlernachricht} (Referenzcode: {UUID})*
* Über die GUI: *„Es ist ein technischer Fehler aufgetreten {Fehler-ID}. Bitte versuchen Sie es später
noch einmal (Referenzcode: {UUID}).*

In der Oberfläche wird also für technische Fehler immer ein fester Standardtext, zusammen mit dem ursprünglichen Fehlercode, ausgegeben.
Nur das Error-Log enthält ebenso die ursprüngliche Fehlermeldung.
Dadurch wird verhindert, dass interne oder nur für die Systementwicklung oder den Betrieb relevante
Meldungen nach außen getragen werden.

[[behandlung-von-exceptions-innerhalb-des-dialogablaufs]]
=== Behandlung von Exceptions innerhalb des Dialogablaufs

Exceptions, welche während der Ausführung von Logik der GUI-Komponenten (z.B. Datenaufbereitung, Rendering) entstehen, werden immer als technische Exception angesehen.
Für diese wird eine standardisierte Fehlerseite mit der in Punkt <<ausgabe-fuer-technische-exceptions>> angegebenen Fehlermeldung für technische Fehler ausgegeben.

Um die Behandlung solcher Fehler zu ermöglichen, stellt die Bibliothek `isy-web` folgendes sicher, so dass für Anwendungen nichts weiter zu tun ist:

*Globaler Übergang auf einen Fehler-Flow:* Der globale Parent-Flow definiert einen Übergang auf den globalen  Fehler-Flow.

:desc-listing-flowtransitionOnException: Flow Übergang auf Fehlerseite
[id="listing-flowtransitionOnException",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-flowtransitionOnException}
[source,xml]
----
<subflow-state id="fehler" subflow="errorFlow" />

<global-transitions>
  <transition on-exception="java.lang.Exception" to="fehler" />
</global-transitions>
----

*Konfiguration des JSF Exeception Handlers:* Dieser Handler wird in der `faces-config.xml` konfiguriert:

:desc-listing-flowExceptionHandlerKonfiguration: Flow JSF Exception Handler Konfiguration
[id="listing-flowExceptionHandlerKonfiguration",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-flowExceptionHandlerKonfiguration}
[source,xml]
----
<factory>
  <exception-handler-factory>
    de.bund.bva.isyfact.common.web.exception.web.JsfExceptionHandlerFactory
  </exception-handler-factory>
</factory>
----

*Bereitstellung des globalen Error-Flows:* Der Flow `errorFlow` bietet eine globale Fehlerseite an.

[[behandlung-von-exceptions-außerhalb-des-dialogablaufs]]
==== Behandlung von Exceptions außerhalb des Dialogablaufs

Es gibt Exceptions, die außerhalb des “normalen“ Dialogablaufs auftreten.
Beispiele dazu sind fehlende Flow-Definitionen, abgelaufene Sessions und Fehler bei der Autorisierung.
Solche Fehler werden im Rahmen der HTTP-Request-Bearbeitung durch einen `ExceptionResolver` behandelt.
Hierfür stellt Spring Web Flow einen Handler zur Verfügung, über welchen ein Mapping der Fehler
auf spezielle Fehlerseiten möglich ist.

Es gibt keine anwendungsspezifischen Fehlerseiten.
Alle IsyFact-Anwendungen verwenden eine einheitliche Fehlerseite.

Die Fehlerseite gibt aus Sicherheitsgründen keine Informationen über die Art des Fehlers preis.
Die eigentliche Fehlerursache kann nur aus den Server-Logs ermittelt werden.

Die Fehlerbehandlung wird in der Spring Konfiguration konfiguriert:

:desc-listing-SnipConfigxml30: Ausschnitt aus config.xml
[id="listing-SnipConfigxml30",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipConfigxml30}
[source,xml]
----
<bean
  class="de.bund.bva.isyfact.common.web.exception.web.SimpleMappingExceptionResolverWithAdvancedLogging">
  <property name="defaultErrorView" value="common/flow/error/errorViewState"/>
  <property name="snapshotNotFoundView" value="common/flow/error/snapshotNotFoundViewState" />
  <property name="accessDeniedView" value="common/flow/error/accessDeniedViewState" />
  <property name="ausnahmeIdMapper" ref="ausnahmeIdMapper"/>
</bean>
----

=== Behandlung von OptimisticLockExceptions

Für Die Behandlung einer `OptimisticLockException` innerhalb der Anwendung ist ein spezieller Handler eingerichtet.
Beim Auftreten einer `OptimisticLockException` wird eine gesonderte Fehlermeldung ausgegeben, die auf einen konkurrierenden Zugriff hinweist.
Zusätzlich wechselt der Handler in den Zustand `abbrechenEndState` des aktiven Flows, wenn dieser vorhanden ist.
Sonst wird in den allgemeinen Fehlerzustand (`fehler`) gewechselt.


[[behandlung-von-exceptions-innerhalb-des-clients]]
=== Behandlung von Exceptions innerhalb des Clients

Durch die Nutzung von AJAX entstehen clientseitige HTTP-Requests, welche durch die JSF-JavaScript-Bibliothek gesteuert werden.
Auftretende Fehler (z.B. Server nicht erreichbar, Serverfehler) werden daher nicht durch den Browser direkt, sondern durch die JS Bibliothek behandelt.

[[sicherheit]]
== Sicherheit

Die Absicherung von Masken erfolgt auf Dialogablauf-Ebene.
Die Berechtigungsprüfung verwendet die Sicherheits-Komponente.

Gekapselt werden die Bestandteile der Sicherheits-Komponente hinter Spring Security.
Durch den Einsatz von Spring Security ist es einfacher eine Integration der Berechtigungen in die Spring
Umgebung, insbesondere Spring Web Flow, zu erreichen.

[[autorisierung]]
=== Autorisierung

Für die Absicherung von Dialogabläufen wird innerhalb der Spring Web Flow Konfiguration auf dem `<view-state>`
ein `<secured>` Tag mit dem geforderten Recht gesetzt.
Die verwendeten Rechte müssen durch die Rollenrechte-Konfiguration (siehe <<NutzungsvorgabenSicherheit>>)
für den eingeloggten
Benutzer entsprechend gesetzt werden.
Durch die Verwendung des Tags wird vor dem Anzeigen des `<view-state>` eine Überprüfung der
Berechtigung des anfragenden Benutzers durchgeführt.
Fehlt dem Benutzer diese, wird die Fehlerseite angezeigt.

:desc-listing-Snipcreateflow: Ausschnitt aus Flow erstellenFlow.xml
[id="listing-Snipcreateflow",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-Snipcreateflow}
[source,xml]
----
<view-state id="erstellenViewState1" model="erstellenModel">
    <secured attributes="Erstellen"/>
    <transition on="continue" to="validiereStammdaten"/>
    <transition on="add" to="erstellenViewState1">
    ...
</view-state>
----

:desc-listing-Snipflowmanage: Ausschnitt aus Flow verwaltenFlow.xml
[id="listing-Snipflowmanage",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-Snipflowmanage}
[source,xml]
----
<view-state id="verwaltenViewState">
    <secured attributes="Verwalten"/>
    <transition on="abschliessen" o="abschliessenViewState"/>
    <transition on="loeschen" to="loeschenViewState" />
    ...
</view-state>
----

[[berechtigungsabhaengige-darstellung-in-masken]]
=== Berechtigungsabhängige Darstellung in Masken

//S 46 / 642  1990

Um eine berechtigungsabhängige Darstellung von Maskenelementen zu realisieren, muss die Anwendung einen Controller
bereitstellen, mit dessen Hilfe über nicht parametrisierte Methoden Anfragen nach den benötigten Rechten gestellt werden können.
Dieser Controller ist dafür zuständig, den Rechte-Schlüssel aufzulösen und die Anfrage an die Komponente Sicherheit zu delegieren.
Beantwortet werden die Anfragen stets mit einem einfachen Booleschen Wert.

Mit Hilfe dieses Controllers lassen sich einzelne Maskenelemente, aber auch Gruppen von Maskenelementen berechtigungsabhängig ausblenden.
Die JSF-Komponenten bietet hierfür das `rendered`-Attribut (siehe <<listing-HideJSFComp>>). Beantwortet der BerechtigungsController den
Methoden-Aufruf von `getBenutzerDarfAdministrieren()` mit `false`, so wird der Button nicht dargestellt.

:desc-listing-HideJSFComp: JSF-Komponente berechtigungsabhängig ausblenden
[id="listing-HideJSFComp",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-HideJSFComp}
[source,xml]
----
<t:commandButton ... rendered="#{berechtigungsController.benutzerDarfAdministrieren}"/>
----

Sollen mehrere oder nicht-JSF Komponenten berechtigungs­abhängig ausgeblendet werden, kann das Fragment-Tag der
Facelets-Bibliothek verwendet werden.
Dieses kann eine beliebige Anzahl an weiteren Maskenelementen umschließen und bietet ebenfalls das `rendered`-Attribut,
welches sich dann auf alle enthaltenen Komponenten auswirkt (siehe <<listing-HideGUIComp>>).

:desc-listing-HideGUIComp: GUI-Komponenten berechtigungsabhängig ausblenden
[id="listing-HideGUIComp",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-HideGUIComp}
[source,xml]
----
<ui:fragment +
   rendered="#{berechtigungsController.benutzerDarfAnwenderAdministrieren}">
           […] weitere Komponenten […]
</ui:fragment>
----

[[vermeidung-von-sicherheitsluecken-bei-aktiviertem-javascript]]
=== Vermeidung von Sicherheitslücken bei aktiviertem JavaScript

Ist JavaScript in einem Browser aktiviert, eröffnet dies gewisse Risiken bei der Verarbeitung datenschutzbedenklicher Informationen.
Folgende Maßnahmen reduzieren jedoch das Risiko möglicher Attacken für Cross-site-Scripting (XSS):

* *Verwendung von Standardbrowsern*: Die gängigen Browser befolgen festgelegte Sicherheitsrichtlinien, die nur schwer und
vorsätzlich deaktiviert werden können.
Diese Standard­einstellungen erschweren XSS und sind gerade für den folgenden Punkt unerlässlich.
* *Übertragung aller Inhalte per HTTPS zum Browser*: Werden Webinhalte per HTTPS zum Client übertragen, ist ein unerwünschtes
Datenauslesen per JavaScript-Injection oder IFrame-Injection verhindert, da Browser JavaScript-Code nur dann auf einen
domain-fremden DOM zugreifen lassen, sofern dieser nicht sicher übertragen wurde.
* *Keine Verwendung von Request-Variablen in offenem JS*: Werden Request-Parameter, z.B. als Teile eines Formulars,
direkt in offenem JavaScript (`eval([var])` oder `setTimeout([var])`) weiterverwendet, so können Angreifer manipulierte
Parameter für DOM-based-XSS nutzen, d.h. es werden JavaScript Befehle als Parameter übergeben, die Inhalte verändern,
auslesen oder in einen falschen Kontext setzen.
* *Encodierung von Request-Variablen im DOM*: Werden Request-Variablen auf einer Seite dargestellt, so sind diese
XML-encodiert einzubinden (siehe Element `outputText` in Kapitel <<datenkonvertierung-fuer-darstellung-und-eingabe>>).
Somit wird verhindert, dass ein Angreifer ein ungewünschtes Script-Tag übergibt.


[[temporaere-binaerdaten]]
== Temporäre Binärdaten

Für manche Anwendungsfälle in Webanwendungen wird ein Speicherort für temporäre Binärdaten benötigt.
Dies ist z.B. notwendig, um dem Nutzer die Binärdaten wieder zur Verfügung zu stellen, bevor diese in einem Datenbestand
gespeichert wurden (z.B. hochgeladenes Lichtbild anzeigen).

TIP: Für (temporäre) Binärdaten kann der RegisterFactory-Binärdatenservice genutzt werden.
Dieser bietet die Möglichkeit Binärdaten entgegenzunehmen und einen Cleanup-Timertask, der veraltete Binärdaten
automatisch wieder aufräumt.
Somit ist keine Verwendung von Datenbankmitteln notwendig.

[[dynamische-downloads]]
== Dynamische Downloads

JSF ermöglicht über das Element `<outputlink/>` den Download von statischen Dateien.
Der Download bzw. das Streaming von dynamisch generierten Dokumenten wird nicht von Haus aus unterstützt.
Diese Funktionalität wird in der Bibliothek `isy-web` durch die Klasse `DownloadHelper` implementiert.
Unterstützt wird der Download einzelner Dateien (<<listing-dynamischerDownload>>) und der Download mehrerer Dateien, die in einer ZIP-Datei zusammengefasst werden (<<listing-dynamischerDownloadZip>>).

:desc-listing-dynamischerDownload: Download von dynamische generierten Dateien
[id="listing-dynamischerDownload",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-dynamischerDownload}
[source,java]
----
...
private DownloadHelper downloadHelper;
...
public void download() {
    DokumentDatenModel dokumentDatenModel = new DokumentDatenModel();
    dokumentDatenModel.setInhalt(new byte[] {'T', 'e', 's', 't'});
    dokumentDatenModel.setDateiname("Test");
    dokumentDatenModel.setDateityp(DateitypEnum.TXT);

    downloadHelper.starteDownload(dokumentDatenModel);
}
----

:desc-listing-dynamischerDownloadZip: Download von dynamische generierten Dateien als ZIP-Datei
[id="listing-dynamischerDownloadZip",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-dynamischerDownloadZip}
[source,java]
----
...
private DownloadHelper downloadHelper;
...
public void downloadZip() {
    FileModel datei1 = new FileModel();
    datei1.setInhalt(new byte[] {'T', 'e', 's', 't', '1'});
    datei1.setDateiname("Test1.txt");
    datei1.setMimeType(DateitypEnum.TXT.getMimeType());

    FileModel datei2 = new FileModel();
    datei2.setInhalt(new byte[] {'T', 'e', 's', 't', '2'});
    datei2.setDateiname("Test2.txt");
    datei2.setMimeType(DateitypEnum.TXT.getMimeType());

    downloadHelper.downloadZipFileByModel("Test.zip", datei1, datei2);
}
----

Um den `DownloadHelper` zu verwenden, müssen die Beans aus <<listing-downloadHelperBean>> konfiguriert werden.
Die Einbindung erfolgt dann per Depedency Injection z.B. in einem Controller.

:desc-listing-downloadHelperBean: Konfiguration DownloadHelper als Bean
[id="listing-downloadHelperBean",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-downloadHelperBean}
[source,xml]
----
<bean id="zipHelper" class="de.bund.bva.isyfact.common.web.filetransfer.ZipHelper"/>

<bean id="downloadHelper" class="de.bund.bva.isyfact.common.web.filetransfer.DownloadHelper"/>
----

[[konfiguration]]
= Konfiguration

Dieses Kapitel enthält die anwendungsunabhängig benötigten Einstellungen, um eine Web-GUI mit JSF einzurichten.
Konkrete, weiterführende Beispiele bietet die <<Vorlageanwendung>>.

[[web.xml]]
== Web Deployment Deskriptor

Die Datei `web.xml` ist der Web Deployment Deskriptor und enthält die notwendigen Informationen, um die Teilsysteme (JSF, Spring Web Flow, Security) zu konfigurieren.

[[festlegung-der-startseite]]
=== Festlegung der Startseite

Für den initialen Zugriff auf die Applikation wird in der `web.xml` der Startpunkt für den Dialogablauf definiert.
Dieses geschieht durch den Eintrag in der `<welcome-file-list>` auf eine Datei, in welcher der Redirect auf den Startflow steht.
Dieses ist notwendig, weil eine Angabe der Flow Engine im `web.xml` für Welcome Files nicht möglich ist.

:desc-listing-Snipwebxml: Startseitenfestlegung in der web.xml
[id="listing-Snipwebxml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-Snipwebxml}
[source,html]
----
<welcome-file-list>
  <welcome-file>index.html</welcome-file>
</welcome-file-list>
----

Die Datei `index.html` sieht folgendermaßen aus:

:desc-listing-SnipIndexxml: Ausschnitt index.html
[id="listing-SnipIndexxml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipIndexxml}
[source,html]
----
<html>
  <head>
    <meta http-equiv="Refresh" content="0; URL= app/startFlow">
  </head>
</html>
----


=== ApplicationInitialisierungsFilter

Der `ApplicationIntialisierungFilter` ist für die JavaScript Erkennung und die damit verbunden Konfiguration der globalen Einstellungen für die Session des Nutzers zuständig.

:desc-listing-jsfWebXmlKonfigAppInitFilter: web.xml Konfiguration für den ApplicationInitialisierungsFilter
[id="listing-jsfWebXmlKonfigAppInitFilter",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-jsfWebXmlKonfigAppInitFilter}
[source, xml]
----
<filter>
  <filter-name>applicationInitialisierungFilter</filter-name>
  <filter-class>
    de.bund.bva.isyfact.common.web.servlet.filter.ApplicationInitialisierungFilter
  </filter-class>

  <!-- Nicht bei der Anforderung von Ressourcen aufrufen -->
  <init-param>
    <param-name>urlsToSkip</param-name>
    <param-value>/app/resources</param-value>
  </init-param>

  <init-param>
    <param-name>urlApplicationInitialisierung</param-name>
    <param-value>/app/common/init/applicationInitialisierung.xhtml</param-value>
  </init-param>
</filter>
----

[[basis-konfiguration-jsf]]
== Basis-Konfiguration JSF

Dieses Kapitel fasst alle notwendigen Basiskonfigurationen für die Verwendung von JSF zusammen.

[[verwendung-von-facelets-webflow.xml]]
=== Verwendung von Facelets (webflow.xml)

Für die Verwendung von Facelets ist es notwendig, in der Spring Konfiguration ein Mapping zwischen der Datei-Erweiterung
und den Facelets herzustellen.

:desc-listing-SnipConfigxml: Ausschnitt config.xml
[id="listing-SnipConfigxml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipConfigxml}
[source,xml]
----
<!-- Maps logical view names to Facelet templates (e.g. 'search' to '/WEB-INF/search.xhtml' -->
<bean id="faceletsViewResolver"
	class="org.springframework.web.servlet.view.UrlBasedViewResolver">
	<property name="viewClass"
		value="org.springframework.faces.mvc.JsfView" />
	<property name="prefix" value="/WEB-INF/" />
	<property name="suffix" value=".xhtml" />
</bean>
----

[[abschalten-der-ausgabe-von-kommentaren]]
=== Abschalten der Ausgabe von Kommentaren

Die Ausgabe von HTML-Kommentaren, die in der Flow-Definition und im View zur Dokumentation der Software eingebettet
wurden, wird abgeschaltet.

[[konfiguration-von-konvertern]]
=== Konfiguration von Konvertern

Um den gewünschten Konverter für die Verwendung bekannt zu machen, muss dieser in der `faces-config.xml` (Java Server Faces Konfigurationsdatei) erfasst werden.

:desc-listing-SnipFacesConfigxml: Ausschnitt aus faces-config.xml
[id="listing-SnipFacesConfigxml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipFacesConfigxml}
[source,xml]
----
<converter>
	<converter-for-class>java.util.Date</converter-for-class>
	<converter-class>de.msg.terminfindung.gui.util.DateConverter</converter-class>
</converter>
----

[[aktivieren-von-partial-state-saving]]
=== Aktivieren von „Partial State Saving“

Das mit JSF 2.0 eingeführte Feature „Partial State Saving“ muss aktiviert bleiben.
Hintergrund ist, dass JSF 2.0 ansonsten im Zusammenhang mit der Replikation der Session die IDs für JSF-Komponenten
doppelt vergibt und es dadurch zu Fehlern in der Anwendung kommt.

[[erkennung-von-javascript-unterstuetzung]]
=== Erkennung von JavaScript Unterstützung

Je nach Browser und JavaScript Aktivierungsstatus muss die Anwendung Widgets verschieden darstellen.
Hierzu existiert ein Filter, welcher in die web.xml eingebunden wird.
Die Parameter müssen ggf.
angepasst werden.

:desc-listing-Snipwebxml2: Ausschnitt web.xml
[id="listing-Snipwebxml2",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-Snipwebxml2}
[source,xml]
----
<!-- Filter zur Initialisierung der Applikation (JavaScript De-/Aktiviert, ...). -->
	<filter>
		<filter-name>applicationInitialisierungFilter</filter-name>
		<filter-class>de.bund.bva.isyfact.common.web.servlet.filter.ApplicationInitialisierungFilter</filter-class>

		<!-- Optionaler Parameter: Der Parameter "urlsToSkip" dient zur Aufnahme von Url-Pfaden, relativ zum ApplicationContext-Pfad,
    		 die von der Filterung ausgenommen werden. Mehrere Url-Pfade sind kommasepatiert anzugeben. Es ist pro
			 Url ein fuehrendes
			 "/" anzugeben. -->
		<init-param>
			<param-name>urlsToSkip</param-name>
			<param-value>/app/resources</param-value>
		</init-param>

		<!-- Plicht-Parameter: Der Parameter "urlApplicationInitialisierung" enthaelt die Url zur Application-Initialisierungsseite.
			 Es ist ein fuehrendes "/" anzugeben. -->
		<init-param>
			<param-name>urlApplicationInitialisierung</param-name>
			<param-value>/app/common/init/applicationInitialisierung.xhtml</param-value>
		</init-param>
	</filter>
----

[[spezielleWidgetRenderer]]
=== Spezielle Widget-Renderer

Derzeit muss noch folgende Konfiguration in die `faces-config.xml` der Anwendung aufgenommen werden:

:desc-listing-jsfRenderer: JSF Renderer Konfiguration
[id="listing-jsfRenderer",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-jsfRenderer}
[source,xml]
----
<!-- Spezifische Renderer müssen hier erneut angegeben werden, um die existierenden Renderer aus der Tomahawk Bibliothek zu überschreiben -->
 <render-kit>
    <!-- Spezieller Renderer für t:radio Elemente, welcher kein Label rendert. -->
    <renderer> <component-family>org.apache.myfaces.Radio</component-family>
    <renderer-type>org.apache.myfaces.Radio</renderer-type>
    <renderer-class>de.bund.bva.isyfact.common.web.jsf.renderer.NoLabelHtmlRadioRenderer</renderer-class>
    </renderer>

<!-- Spezieller Renderer für Checkboxen, welcher kein Label rendert. -->
   <renderer>
      <component-family>org.apache.myfaces.Checkbox</component-family>
      <renderer-type>org.apache.myfaces.Checkbox</renderer-type>
      <renderer-class>de.bund.bva.isyfact.common.web.jsf.renderer.NoLabelHtmlCheckboxRenderer</renderer-class>
      </renderer>
  </render-kit>
----

[[basis-konfiguration-web-flow]]
== Basis-Konfiguration Web Flow

Dieser Abschnitt beschreibt die Basiskonfiguration für die Verwendung von Spring Web Flow.
Die Datei `webflow.xml` enthält die Spring Konfigurationen für die GUI-Frameworks (Webflow, JSF, Spring MVC).

Folgende Konfigurationsdatei muss für die in die anwendungsspezifische GUI/Spring-Webflow Konfiguration angelegt und importiert werden:

:desc-listing-PfadWebflowXml: webflow.xml Konfigurationsdatei
[id="listing-PfadWebflowXml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-PfadWebflowXml}
[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
   ...
   ...>

    <!-- Webflow -->
    <import resource="classpath:resources/plis-web/spring/webflow.xml"/>
</beans>
----
// Anmerk. (msg systems): Stand 19.07.2018 Pfad plis-web z.Zt. noch richtig, bei einer Verzeichnisstruktur
// anpassung wäre das obige Beispiel anzupassen

[[erweiterung-fuer-servlets-im-web.xml]]
=== Erweiterung für Servlets im web.xml

Damit die Funktionalitäten von Spring Web Flow aufgerufen werden, muss das SWF Dispatcher Servlet registriert werden,
welches die weitere Behandlung an den SWF Kern abgibt.

:desc-listing-Snipwebxml3: Ausschnitt web.xml bezüglich Servlets
[id="listing-Snipwebxml3",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-Snipwebxml3}
[source,xml]
----
<servlet>
	<servlet-name>dispatcher</servlet-name>
	<servlet-class>
		org.springframework.web.servlet.DispatcherServlet
	</servlet-class>
	<init-param>
		<param-name>contextConfigLocation</param-name>
		<param-value>/WEB-INF/config.xml</param-value>
	</init-param>
	<load-on-startup>2</load-on-startup>
</servlet>

<servlet-mapping>
	<servlet-name>dispatcher</servlet-name>
	<url-pattern>/app/*</url-pattern>
</servlet-mapping>
----

[[konfiguration-der-navigation]]
== Konfiguration der Navigation

Nachfolgend werden die notwendigen Konfigurationen beschrieben, um die konkreten Dialog Flows zu definieren, und
wo die entsprechenden Anpassungen vorgenommen werden müssen.

[[jsf-flow-builder-service]]
=== JSF Flow Builder Service

Der JSF Flow Builder Service initialisiert aus der Dialog-Ablaufbeschreibung die konkreten Dialoge.
Zusätzlich kann hier noch der Expression Parser für die EL-Implementierung definiert werden.
Durch die Definition des EL-Parsers kann die konkrete EL-Implementierung festgelegt werden.
Standardmäßig sollte hier keine spezifische Konfiguration vorgenommen werden.

:desc-listing-SnipWebflow1xml: Ausschnitt aus Web Flow.xml
[id="listing-SnipWebflow1xml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebflow1xml}
[source,xml]
----
<!-- Configures the Spring Web Flow JSF integration -->
<faces:flow-builder-services id="facesFlowBuilderServices"
              expression-parser="expressionParser"/>
----

[[ablage-der-konfiguration]]
=== Ablage der Konfiguration

Innerhalb der Spring-Konfiguration wird für den Web Flow die `flow-registry` konfiguriert.
Hier wird die Ablage der Konfigurations-Files definiert.

:desc-listing-SnipWebflow2xml: Ausschnitt aus Web Flow.xml
[id="listing-SnipWebflow2xml",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebflow2xml}
[source,xml]
----
<!-- The registry of executable flow definitions -->
<webflow:flow-registry id="flowRegistry"
        flow-builder-services="facesFlowBuilderServices">
		<webflow:flow-location-pattern value="/WEB-INF/gui/flows/**/*Flow.xml" />
</webflow:flow-registry>
----

[[konfiguration-logging]]
== Konfiguration Logging

Für das Logging kommt logback zum Einsatz.
Das <<KonzeptLogging>> enthält die dafür notwendigen Konfigurationen und weitere Details. Zur Konfiguration des Logging ist folgende Abhängigkeit nötig:

:desc-listing-SnipLoggingDep: Abhängigkeit isy-logging (Ausschnitt pom.xml)
[id="listing-SnipLoggingDep",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipLoggingDep}
[source,xml]
----
<dependency>
    <groupId>de.bund.bva.isyfact</groupId>
    <artifactId>isy-logging</artifactId>
</dependency>
----

Die Ablage der logback-Konfiguration erfolgt in der Datei `web.xml`:

:desc-listing-SnipLogginConf1: Logging Konfiguration (Ausschnitt web.xml)
[id="listing-SnipLogginConf1",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipLogginConf1}
[source,xml]
----
<context-param>
    <param-name>logbackConfigLocation</param-name>
    <param-value>classpath:/config/logback.xml</param-value>
</context-param>
----

Die <<NutzungsvorgabenLogging>> beinhalten Vorgaben zum Schreiben von Log-Einträgen und zur Ablage von Log-Dateien.

[[konfiguration-security]]
== Konfiguration Security

[[setup-web.xml]]
=== Setup web.xml

Für den Einsatz von Spring Security ist ein Servlet Filter notwendig, in welchem die initialen
Abhandlungen der Berechtigungen erfolgen.

Hier wird die Ablage der Spring Security Konfiguration definiert.

:desc-listing-SnipWebxmlt5: Ausschnitt aus web.xml (bezüglich Security)
[id="listing-SnipWebxmlt5",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebxmlt5}
[source,xml]
----
<!-- Spring Security filter, context parameter -->
<context-param>
	<param-name>contextConfigLocation</param-name>
	<param-value>classpath:resources/spring/applicationContext-security.xml
	</param-value>
</context-param>
----

Der Security Filter und die davon betroffenen URL-Patterns werden definiert.
Im Falle eines Einsatzes zur Absicherung der Dialogabläufe sollten alle Zugriffe abgesichert werden.

:desc-listing-SnipWebxmlt6: Ausschnitt aus web.xml (bezüglich Security-Filter)
[id="listing-SnipWebxmlt6",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebxmlt6}
[source,xml]
----
<!-- Spring Security filter -->
<filter>
<filter-name>springSecurityFilterChain</filter-name>
<filter-class>
org.springframework.web.filter.DelegatingFilterProxy
</filter-class>
</filter>
<filter-mapping>
<filter-name>springSecurityFilterChain</filter-name>
<url-pattern>/*</url-pattern>
</filter-mapping>
----

Der Security Filter benötigt einen `ContextLoaderListener`, welcher wie folgt konfiguriert ist.

:desc-listing-SnipWebxmlt7: Ausschnitt aus web.xml (Contextloader)
[id="listing-SnipWebxmlt7",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebxmlt7}
[source,xml]
----
<!-- Context Listener for the spring filter -->
<listener>
<listener-class>
org.springframework.web.context.ContextLoaderListener
</listener-class>
</listener>
----

[[spring-security-konfiguration]]
=== Spring Security Konfiguration

Die Datei `isy-sicherheit-web.xml` beinhaltet die Konfiguration für die Spring Security Definition.
Darin wird konfiguriert, wie die Sicherheitskomponente an Spring Security angeschlossen wird.

Die Spring Konfiguration erfolgt in der Datei `isy-sicherheit-web.xml`, welche durch den Security Filter initial geladen wird.

Für die Konfiguration finden die nachfolgenden Namespaces Verwendung.

:desc-listing-SnipWebxmlSecu: Ausschnitt aus `isy-sicherheit-web.xml` (Namespace)
[id="listing-SnipWebxmlSecu",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebxmlSecu}
[source,xml]
----
<beans:beans xmlns="http://www.springframework.org/schema/security"
xmlns:beans="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/security
http://www.springframework.org/schema/security/spring-security-2.0.1.xsd">
----

Die Definition der HTTP-Konfiguration erfolgt in dem XML-Tag `<http>`.

:desc-listing-SnipApplContxtSec: Ausschnitt aus applicationContext-security.xml
[id="listing-SnipApplContxtSec",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipApplContxtSec}
[source,xml]
----
<http auto-config="true">
	<form-login login-page="/login.jsp" />
</http>
----

Folgende Konfiguration muss für die Spring-Security Konfiguration übernommen werden:

`<import resource="classpath:resources/isy-web/spring/isy-sicherheit-web.xml"/>`

Die eingebundenen Spring-Konfigurationen erwarten folgende Beans unter dem angegebenen Namen vorzufinden:

* Sicherheit ("sicherheit") Die Sicherheit aus der `isy-sicherheit`.

Durch Spring Security wird die Verwendung von Annotationen bei der Berechtigungsprüfung ermöglicht.
Diese wird wie folgt aktiviert.

:desc-listing-SnipApplContextSec: Ausschnitt aus applicationContext-security.xml (Aktivierung)
[id="listing-SnipApplContextSec",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipApplContextSec}
[source,xml]
----
<global-method-security secured-annotations="enabled" />
----

Die Konfiguration von Spring Security setzt die Definition eines User Services voraus.
Dieses kann nach aktuellem Stand nicht umgangen werden.
Daher wird ein Dummy Service definiert, welcher einen inaktiven Benutzer enthält.
Die Abfrage auf die realen Benutzer erfolgt im Authentication Provider, welcher im folgenden Kapitel beschrieben ist.

:desc-listing-SnipWebxmlSec: Ausschnitt aus `isy-sicherheit-web.xml`
[id="listing-SnipWebxmlSec",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebxmlSec}
[source,xml]
----
<user-service>
	<user authorities="ROLE" name="name" password="password"
		  disabled="true" />
</user-service>
----

Für die Anbindung des Berechtigungsmanagers an Spring Security findet die Möglichkeit zur Erstellung
eines “Custom Authentication Providers” Anwendung.
In diesem Authentication Provider wird bei Bedarf überprüft ob der Nutzer die notwendigen Berechtigungen besitzt, bzw.
es wird für die weitere Verarbeitung in Spring Security der notwendige Kontext aufgebaut.

:desc-image-ClassConnSecKomp: Klassendiagramm Anbindung Sicherheitskomponente
[id="image-ClassConnSecKomp",reftext="{figure-caption} {counter:figures}"]
.{desc-image-ClassConnSecKomp}
image::ClassConnSecKomp.png[align="center"]

Das Sequenzdiagramm stellt den Zugriff des Authentication Providers auf die Sicherheitskomponente dar.
Hierbei werden die Rollen eines Benutzers über den Berechtigungsmanager gelesen und in einen Spring Security konformen
Token geschrieben.
Dieser Token findet dann bei der Autorisierung einzelner Benutzerinteraktion durch Spring Security Verwendung.

:desc-image-SecDiaAccessSec: Sequenzdiagramm Zugriff auf Sicherheitskomponente
[id="image-SecDiaAccessSec",reftext="{figure-caption} {counter:figures}"]
.{desc-image-SecDiaAccessSec}
image::SecDiaAccessSec.png[align="center"]

[[konfiguration-sicherheitskomponente]]
==== Konfiguration Sicherheitskomponente

Die Konfiguration der Sicherheitskomponente über eine properties-Datei ist im Konzept <<NutzungsvorgabenSicherheit>> beschrieben.

[[konfiguration-webflowauthenticationprovider]]
==== Konfiguration WebFlowAuthenticationProvider

Der `WebFlowAuthenticationProvider` erhält durch die Konfiguration die Instanz der Bean „`sicherheit`“ injected und wird
als „`custom-authentication-provider`“ Spring Security bekannt gemacht.

:desc-listing-SnipApcntxSec: Ausschnitt aus applicationContext-security.xml
[id="listing-SnipApcntxSec",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipApcntxSec}
[source,xml]
----
<!-- ======================================================================
custom authentication provider setzen um Sicherheits Komponente für Rollen +
Ermittlung zu verwenden
====================================================================== -->
<beans:bean id="Web FlowAuthenticationProvider"
	class="de.bund.bva.pliscommon.plisweb.Web Flow.security.Web FlowAuthenticationProvider">
	<custom-authentication-provider />
	<beans:property name="sicherheit" ref="sicherheit" />
</beans:bean>
----

[[setup-spring-config-webflow.xml]]
=== Setup Spring Config (webflow.xml)

Hier muss ein Listener registriert werden, über welchen die Security Bedürfnisse geprüft werden.

:desc-listing-SnipWebFlowxx: Ausschnitt aus Web Flow.xml (bezüglich Security)
[id="listing-SnipWebFlowxx",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-SnipWebFlowxx}
[source,xml]
----
<bean name="flowExecutionSecurityListener"
      class="org.springframework.Web Flow.security.SecurityFlowExecutionListener">
</bean>

<bean name="flowExecutionListenerLoaderFactory"
	  class="org.springframework.Web Flow.config.FlowExecutionListenerLoaderFactoryBean">
	<property name="listeners">
		<map>
			<entry key-ref="flowExecutionSecurityListener"
				   value="cd-register"></entry>
			<entry key-ref="jpaFlowExecutionListener"
				   value="cd-register"></entry>
		</map>
	</property>
</bean>

<bean name="flowExecutionFactory"
	  class="org.springframework.Web Flow.engine.impl.FlowExecutionImplFactory">
	  <property name="executionKeyFactory"
		        ref="flowExecutionRepository"/>
	  <property name="executionListenerLoader"
				ref="flowExecutionListenerLoaderFactory"/>
</bean>
----

[[konfiguration-portalfarbe]]
== Konfiguration Portalfarbe

Für eine Anwendung kann eine Basisfarbe / Portalfarbe konfiguriert werden. Von dieser `portalColor` werden
viele der weiteren Farbstyles für die Anwendung abgeleitet und in der generierten Datei `color.css` abgelegt,
die in der Zielanwendung einzubinden ist.

Zur Generierung der Datei `color.css` mit der eigenen Portalfarbe sind folgende Schritte erforderlich:

*1.  Konfiguration der Portalfarbe*: In der Datei `Gruntfile.js` ist die Basisfarbe / Portalfarbe zu setzen:

:desc-listing-gruntPortalfarbe: Portalfarbe in Gruntfile.js konfigurieren
[id="listing-gruntPortalfarbe",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-gruntPortalfarbe}
[source, xml]
----
var helper = require('./helper/helper');
module.exports = function (grunt) {

    grunt.loadNpmTasks('grunt-contrib-clean');
    grunt.loadNpmTasks('grunt-contrib-copy');
    grunt.loadNpmTasks('grunt-contrib-less');

    var portalColor = '#004179';

    grunt.initConfig({
        ...
----
[start=2]
*2.   Maven Install*: In der Bibliothek `isy-style` ist ein "Maven install" durchzuführen. Dadurch wird ein "grunt build" ausgelöst und die Farbstyles befinden sich nach der Generierung
in `target/color.css`.

[start=3]
*3.   Einbindung in Zielanwendung*: Die Datei `color.css` aus dem Target-Verzeichnis von `isy-style` ist in die Zielanwendung unterhalb des WEB-INF Verzeichnisses zu kopieren.

:desc-image-colorCssPosition: Zielordner für color.css Datei
[id="image-colorCssPosition",reftext="{figure-caption} {counter:figures}"]
.{desc-image-colorCssPosition}
image::color-css-position.png[align="center"]

[[konfiguration-des-ressource-caching-mechanismus]]
== Konfiguration des Ressource Caching Mechanismus

Möchte man Webressourcen wie Bilder oder CSS-Dateien von Softwareversionen abhängig machen, muss das folgende gemacht werden:

[[jsf-resourcehandler-einrichten]]
=== JSF ResourceHandler einrichten

Die Ressourcenlieferung wird durch so genannte _ResourceHandler_ verkapselt.
Um also den Prozess anpassen zu können, muss man einen eigenen _ResourceHandler_ definieren und an die Web Applikation anbinden.
Da jedoch das GUI mittels JSF erstellt wird, muss es JSF-spezifisch umgesetzt werden.
Der folgende Code ist ein Beispiel so eines Handlers:

[source,java]
----
public class VersionierungResourceHandler extends ResourceHandlerWrapper {

	private ResourceHandler wrapped;
	private SystemVersionBean systemVersionBean;

	public VersionierungResourceHandler(ResourceHandler wrapped) {
		this.wrapped = wrapped;
		if (StatischerKontextInhaber.getApplicationContext() != null) {
			this.systemVersionBean =
				StatischerKontextInhaber.getApplicationContext().getBean(SystemVersionBean.class);
		}
	}

	@Override
	public Resource createResource(String resourceName) {
		return createResource(resourceName, null, null);
	}

	@Override
	public Resource createResource(String resourceName, String libraryName) {
		return createResource(resourceName, libraryName, null);
	}

	@Override
	public Resource createResource(String resourceName, String libraryName, String contentType) {
		final Resource resource = super.createResource(resourceName, libraryName, contentType);
		if (resource == null) {
			return null;
		}
		return new ResourceWrapper() {

			@Override
			public String getRequestPath() {
				String requestPath = super.getRequestPath();
				String version = "v=" + getSystemVersion();
				if (!requestPath.contains("?")) {
					return requestPath + "?" + version;
				}
				return requestPath + "&" + version;
			}

			@Override
			public Resource getWrapped() {
				return resource;
			}
		};
	}

	@Override
	public ResourceHandler getWrapped() {
		return this.wrapped;
	}

	private String getSystemVersion() {
		if (this.systemVersionBean == null && StatischerKontextInhaber.getApplicationContext() != null) {
			this.systemVersionBean = StatischerKontextInhaber.getApplicationContext().getBean(SystemVersionBean.class);
		}
		if (this.systemVersionBean == null) {
			this.systemVersionBean = new SystemVersionBean();
			this.systemVersionBean.setSystemVersion("DEV");
		}
		return this.systemVersionBean.getSystemVersion();
	}
}
----

In der Methode `getRequestPath()` kann man die Pfade der Ressourcen beliebig anpassen und zum Beispiel, wie oben gezeigt, eine Version an sie anhängen.

[[konfiguration-1]]
=== Konfiguration

Der _ResourceHandler_ muss noch mittels Konfiguration an die Web Applikation angebunden werden.
Dies macht man in `faces-config.xml` (Java Server Faces Konfigurationsdatei) auf die folgende Weise:

[source,xml]
----
<application>
	<resource-handler>pfad.VersionierungResourceHandler<resource-handler/>
</application>
----

[[jsf-tags-benutzen]]
=== JSF Tags benutzen

Es gibt noch eine letzte Bedingung die man erfüllen muss, damit der JSF _ResourceHandler_ die Ressourcen überhaupt behandelt.
Es müssen JSF Tags benutzt werden:

* JavaScript: `<h:outputScript>` anstatt `<script>`
* CSS: `<h:outputStylesheet>` anstatt `<link>`

Dank ihnen werden die jeweiligen Ressourcen für unseren _ResourceHandler_ sichtbar und werden von ihn nun verwaltet.

[[optionale-anzeige-der-versionsnummer-im-webseitentitel]]
== Optionale Anzeige der Versionsnummer im Webseitentitel

Es besteht die Möglichkeit, die Versionsnummer einer Anwendung im Webseitentitel anzuzeigen.
Hierzu muss der Parameter _gui.versionsanzeige.seitentitel.aktiv_ in einer Konfigurationsdatei der Anwendung hinterlegt sein und auf `_true_` gesetzt werden.
Ist der Parameter nicht hinterlegt, so ist die Anzeige standardmäßig nicht aktiviert und es ist nichts zu tun (Abwärtskompatibilität).

Zusätzlich muss der Parameter `system.version` in einer Konfigurationsdatei hinterlegt sein.
Dieser Parameter enthält die aktuelle Version der Anwendung.
Es empfiehlt sich, die Versionsnummer beim Build automatisch zu setzen.
Außerdem kann im Parameter `system.name` der Name der Anwendung hinterlegt werden.
Dies ist jedoch nicht zwingend nötig.
Die Anzeige der Versionsnummer funktioniert auch ohne Angabe des Anwendungsnamens.
Dieser entfällt dann einfach.
In <<listing-AnzeigeVersionNameImTitel>> finden sich eine beispielhafte Konfiguration und in <<image-DispNameVersTitle>> wird das eigentliche Feature gezeigt.

:desc-listing-AnzeigeVersionNameImTitel: Konfiguration der Anzeige von Name und Version im Seitentitel
[id="listing-AnzeigeVersionNameImTitel",reftext="{listing-caption} {counter:listings }"]
.{desc-listing-AnzeigeVersionNameImTitel}
[source,ruby]
----
# Ob die Versionsnummer im Seitentitel angezeigt werden soll.
# Mögliche Werte `true` oder `false`. Standardwert ist `false`.
gui.versionsanzeige.seitentitel.aktiv=true

# Die Systemversion wird in richtigen Anwendungen automatisch
# über Maven aktualisiert. Hat hier einfach einen festen
# Wert, da sie nur für Beispiele verwendet wird.
system.version=1.2.3

# Der Systemname
system.name=Terminfindung
----

:desc-image-DispNameVersTitle: Anzeige von Name und Version im Seitentitel
[id="image-DispNameVersTitle",reftext="{figure-caption} {counter:figures}"]
.{desc-image-DispNameVersTitle}
image::DispNameVersTitle.png[align="center",width=60%,pdfwidth=60%]

[[session-behandlung]]
= Session Behandlung

Die nachfolgenden Kapitel beschäftigen sich mit der Behandlung der Session Informationen, welche in Spring Web Flow anfallen.
Hierunter fallen alle Daten, die für die Dialogabläufe benötigt werden:

* Komponentenbaum der Dialogansicht, dieser beinhaltet die Dialogelemente und die Information über die Bindung an die Backing Beans.
* Den Flow Container, in welchem die Backing Beans während dem Dialogfluss vorgehalten werden.
* Die Conversation, welche eine Benutzer Interaktion beinhaltet, bündelt die beiden vorangegangenen Angaben.

Standardmäßig wird diese Information in der HTTP Session abgelegt und wieder hergestellt.
Nach IsyFact-Zielarchitektur erfolgt diese Speicherung in der Datenbank.
Diese Funktionalität übernimmt der Tomcat.
Eine Anpassung der Anwendung ist nicht erforderlich.

[[vergabe-von-cookies-session-ids]]
== Vergabe von Cookies / Session IDs

Für die Identifikation abgelegter Conversations von Spring Web Flow wird auf die Daten im Cookie zurückgegriffen.
Der Cookie wird einmalig definiert und ist durch die Session ID vorgegeben.

Die Vergabe der Session IDs erfolgt über die Standardmechanismen innerhalb des Tomcat.
Bei der Anforderung einer neuen Session innerhalb der Applikation, was für den Benutzer nicht sichtbar ist, wird die neue ID vergeben und an die Session gebunden.
Die Nutzung von Cookies ist zwingend erforderlich, ansonsten können die Webanwendungen nicht genutzt werden.

[[session-zugriff]]
== Session Zugriff

Für die Arbeit mit Spring Web Flow ist es notwendig, die in der Session notwendigen Daten der Conversation für
jeden Schritt bereitzustellen und nach jedem Schritt abzulegen.
Hierfür werden die Daten in der Datenbank persistiert.
Dies erfolgt über einen eigenen Session-Manager im Tomcat (siehe <<TomcatNutzungskonzept>>). Es handelt sich dabei
um eine Erweiterung der IsyFact.
Wenn diese Erweiterung nicht eingesetzt wird, muss entweder die Session-Persistierung auf andere Weise durchgeführt
werden, oder es muss sichergestellt werden, dass die Requests eines Benutzers immer auf die gleiche
Tomcat-Instanz gehen (Sticky Sessions). Die Session-Daten müssen dabei möglichst klein gehalten werden, um
die Performance der Anwendung nicht zu verschlechtern.
Die Größe der Session wird maßgeblich durch die „im Webflow“ gespeicherten Model-Daten bestimmt.
Daher muss darauf geachtet werden nur unbedingt notwendige Daten im Model zu halten.


[[transaktionssteuerung]]
== Transaktionssteuerung

Alle Zugriffe auf die Datenbank müssen in einer Transaktion verpackt werden.
Die Transaktionssteuerung wird dabei vom AWK-Wrapper durch Annotation (`@Transactional`) der Klasse übernommen.

Aus Sicht der GUI-Schicht bedeutet dies, dass jeder Aufruf des AWKs unmittelbar eine Änderung der Daten zufolge hat.
Um eine parallele Aktualisierung eines Datensatzes zu verhindern, können die entsprechenden Versionsnummern der
JPA-Entiäten verwendet werden, indem diese mit in die GUI-Entitäten geladen werden.

[[checkliste-zur-qs]]
= Checkliste zur QS

Die Checkliste für die QS stellt Prüfpunkte zur Verfügung, anhand derer wichtige Kriterien zur Umsetzung der
Oberfläche überprüft werden können.

[[id-vergabe-jsf]]
== ID Vergabe JSF

Für automatisierte Tests ist es notwendig, für Eingabefelder und Controls eine konkrete und in der Seite eindeutige ID zu vergeben.

Wird für eine Komponente keine ID vorgegeben, so erzeugt JSF die IDs dynamisch.
Ein Test über ein GUI-Testwerkzeug wird somit erschwert.

[[verwendung-der-http-session]]
== Verwendung der HTTP-Session

Aufgrund der Vorgabe eines zustandslosen Servers ist nicht sichergestellt, dass der Anwendung beim nächsten
Zugriff auf einen Server die HTTP-Session zur Verfügung steht.
Daher ist es notwendig die Masken und Abläufe so zu entwerfen, das hierauf verzichtet werden kann.

[[nutzung-model-beans]]
== Nutzung Model Beans

Jeder Flow muss eine (oder mehrere) Model Bean hinterlegt haben, in welcher die Daten für die Maske vorgehalten werden.

[[transaktionsbehandlung-1]]
== Transaktionsbehandlung

Bei mehrschrittigen Datenerfassungen muss die Behandlung der Transaktion mit einem besonderen Augenmerk behandelt werden.

[[einhaltung-styleguide]]
== Einhaltung Styleguide

Die Applikation muss auf die Vorgaben des Styleguides überprüft werden.
Der Styleguide befindet sich unter <<Styleguide>>.

[[flow-konfiguration]]
== Flow Konfiguration

Für jede Maske sollte der Flow in einer eigenständigen Konfiguration hinterlegt sein, damit kann jede Maske separat
ausgetauscht und gewartet werden.
Jeder Flow sollte entsprechend dem Layout von dem vorgegebenen Parent-Flow erben.

[[optimierung-jsf-design]]
== Optimierung JSF Design

Aufgrund der automatischen Ablage eines JSF Komponenten-Baumes in der Conversation und damit in der Datenbank,
ist es notwendig sich über die Größe des Komponenten-Baumes Gedanken zu machen.

Begrenzung der real verwendeten Komponenten auf die Ein und Ausgabe Elemente.
Statische Texte bevorzugt nur im HTML verwenden.

[[optimierung-snapshots]]
== Optimierung Snapshots

Für die Benutzung des Back-Buttons ist es notwendig, die Anzahl der Snapshots eines Dialogflusses zu erhöhen.
Dieses sollte in Abhängigkeit der Anforderungen an die konkrete Anwendung erfolgen.

[[festlegung-der-texte-fuer-die-titel]]
== Festlegung der Texte für die Titel

Es sollte ein Standard-Titel und Präfix für die Anwendung angelegt werden.

[[festlegung-der-hilfeseiten]]
== Festlegung der Hilfeseiten

Für alle Masken sollte eine zugehörige Hilfe verfügbar sein, und der Aufruf auf die Seite muss überprüft werden.

[[generische-fehlermeldung]]
== Fehlerbehandlung

Alle Exceptions werden an einer definierten Stelle behandelt.
Für technische Fehler werden keine Details, sondern eine generische Fehlermeldung angezeigt.

[[flow-und-masken-security]]
== Flow und Masken Security

Der Zugriff auf Masken und Dialogelemente muss anhand der Systemspezifikation überprüft werden.

[[regeln-bei-der-javascript-programmierung]]
== Regeln bei der JavaScript-Programmierung

Die unter <<interaktive-elemente-mit-jquery>> und <<vermeidung-von-sicherheitsluecken-bei-aktiviertem-javascript>>
beschriebenen Regeln müssen überprüft werden.

[[regeln-der-sicheren-softwareentwicklung]]
== Regeln der sicheren Softwareentwicklung

Bei der Entwicklung von Web-Anwendungen müssen in besonderem Maße Sicherheitsaspekte berücksichtigt werden.
Die entsprechenden Regeln sind in beschrieben.
