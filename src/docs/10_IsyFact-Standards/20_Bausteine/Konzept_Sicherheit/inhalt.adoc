= Konzept Sicherheit: Inhalt
include::../../../common/isyfact-attributes.adoc[]
include::../../../common/attributes.adoc[]

// tag::inhalt[]
[[prinzipien-der-sicherheitsarchitektur]]
== Prinzipien der Sicherheitsarchitektur
Die IsyFact-Referenzarchitektur beinhaltet auf der technischen Ebene Vorgaben für die Sicherheitsarchitektur und für die Prinzipien, nach denen sie aufgebaut ist.

Die konkrete Sicherheitsarchitektur einer Systemlandschaft muss nach folgenden Prinzipien gestaltet sein:

* IsyFact-konforme IT-Systeme sind gegen nicht autorisierte Nutzung zu schützen.
* Die Authentifizierung und grobgranulare Autorisierung erfolgt an den Außenschnittstellen der Systemlandschaft (Portal, Service-Gateway).
* Liegt kein Aufruf über eine Außenschnittstelle vor (z.B. bei einem Batch-Aufruf), so geschieht die Authentifizierung und grobgranulare Autorisierung innerhalb der Nutzungsschicht (Batch) des konkreten IT-Systems.
* Die feingranulare Autorisierung geschieht in der Nutzungsschicht und im Anwendungskern der IT-Systeme über den IsyFact-Baustein Sicherheit.

Existiert keine Systemlandschaft (d.h. IT-Systeme stehen für sich allein), gilt grundsätzlich, dass die Authentifizierung und grobgranulare Autorisierung in der Nutzungsschicht (GUI, Service oder Batch) des IT-Systems geschehen muss.

Darüber hinaus finden Authentifizierung und Autorisierung nach den Vorgaben des Berechtigungskonzepts statt.
Dieses Dokument beschreibt wesentliche Aspekte der Sicherheitsarchitektur für eine konkrete Anwendungslandschaft.
Da das Berechtigungskonzept individuell für jede Anwendungslandschaft erstellt wird und sich im einzelnen stark von Inhalt und Umfang her unterscheidet, ist es kein Bestandteil des Bausteins Sicherheit oder der IsyFact.

=== Authentifizierung
In der Regel erfolgt die Authentifizierung von Anwendern über eine zentrale Komponente der Systemlandschaft, in welche das IT-System eingebettet ist.
Die Authentifizierung darf auch lokal, d.h. vom IT-System selbst, durchgeführt werden, falls es beispielsweise nicht in eine Systemlandschaft eingebettet ist.

Für die zentrale Authentifizierung wird üblicherweise ein IAM-System verwendet.

NOTE: IAM steht für https://en.wikipedia.org/wiki/Identity_management[Identity and Access Management].

Das IAM-System verwaltet *Anwender* und ihre *Rollen*.

Die Authentifizierung und grobgranulare Autorisierung erfolgt, gemäß der <<prinzipien-der-sicherheitsarchitektur>>, an den Außenschnittstellen der Systemlandschaft.
Hierbei wird eine Session aufgebaut und das IAM-System ermittelt nach erfolgreicher Authentifizierung die Rollen des Anwenders.
Die Rollen allein sind jedoch noch nicht ausreichend, um Anwender vollständig zu autorisieren.

=== Autorisierung
Die Autorisierung geschieht in jedem Fall im jeweiligen IT-System.
Nach der erfolgreichen Authentifizierung eines Anwenders leitet das IAM-System die Anfrage an das IT-System weiter.
Hier wird die Anfrage – je nach Schutzbedarf und Funktionalität – autorisiert.
Dazu weist das IT-System einem Anwender anhand seiner Rollen *Rechte* zu und prüft diese gegen die für die Anfrage benötigten Rechte.
Wie genau Rollen und Rechte spezifiziert werden, beschreibt das nächste Kapitel.


[[rollen-und-rechte]]
== Rollen & Rechte

Die Vergabe von Rollen ist _das_ Mittel der Benutzeradministration, um Anwender der Anwendungslandschaft mit Berechtigungen auszustatten.
Die Vergabe von Rollen an einen Anwender (menschliche und technische) erfolgt im Querschnitt:
entweder in der Querschnittsanwendung Benutzerverzeichnis oder in der Querschnittskomponente Benutzerverwaltung.

Es ist konzeptionell beabsichtigt, dass die Administration per Rollen recht grobgranular erfolgt.
Eine administrative Vergabe feingranularer Rechte ist konzeptionell nicht erwünscht.
Die individuelle Zuordnung von Rechten zu Anwendern ist daher prinzipiell nicht möglich.
Rechte werden Anwendern ausschließlich indirekt über Rollen zugeordnet.
Welche Rechte einer Rolle zugeordnet sind, wird innerhalb der statischen Konfiguration eines IT-Systems definiert und ist damit Teil der Software.

====
Die Fachanwendung X bietet zwei Dialoge zur Administration von Anwendungseigenschaften.
Die Dialoge sind über die Rolle `AnwendungX_Administrator` abgesichert.
Innerhalb der Anwendung ist Dialog 1 mit dem Recht `AdministrierenDialog1` und Dialog 2 mit dem Recht `AdministrierenDialog2` abgesichert.
Grobgranular wird die Rolle `AnwendungX_Administrator` einem Anwender zugeordnet.
Innerhalb der Konfiguration des IT-Systems X sind beide Rechte konfiguriert und der Rolle `AnwendungX_Administrator` zugeordnet.
Alle Anwender mit der Rolle `AnwendungX_Administrator` sind somit innerhalb der Anwendung autorisiert, die beiden Admin-Dialoge zu verwenden.
====

Der Vorteil an diesem Vorgehen ist, dass Änderungen an der Zuordnung von Anwendern zu Rollen oder von Rollen zu Rechten nur zu lokalen Änderungen führen.
Soll eine Rolle andere Rechte in einer Fachanwendung bekommen (z.B. durch das Hinzufügen neuer Dialoge), so kann dies für die Benutzeradministration transparent geschehen.
Ebenso sind Änderungen an Anwendern oder ihren zugehörigen Rollen transparent für einzelne Fachanwendungen.

[[spezifikation-der-rollen]]
=== Spezifikation der Rollen

Rollen werden bereits auf fachlicher Ebene als Teil der Systemspezifikation einer Fachanwendung spezifiziert.
Dazu werden zunächst in geeigneter Granularität Rechte definiert, die zur Benutzung bestimmter Funktionalität der Fachanwendung berechtigen.
Diese Rechte werden fachlichen Rollen zugeordnet, die dann wiederum den Anwendern der Anwendung zugeordnet werden können.
Die fachlichen Rollen ermöglichen in der Regel pauschal den Zugriff auf die Fachanwendung oder, im Sinne der Rolle eines fachlichen Sachbearbeiters, die Nutzung ausgewählter Anwendungsfälle.

=== Struktur einer Rolle

Alle Rollen besitzen die folgende Struktur:

*Name:* Interner Name der Rolle, wie er für die Autorisierung und innerhalb von Anwendungen zur Überprüfung bereitgestellt wird.

Der Rollenname sollte dem folgenden Schema entsprechen: `<Anwendungskürzel>_<Zweck/Funktionalität>[_<Zugang>]`.

Das Suffix `<Zugang>`  ist optional, sollte jedoch wenn möglich verwendet werden. Folgende Werte sind sinnvoll:

* `Schnittstellennutzer` für technische Rollen, die zur Verwendung einer internen Service-Schnittstelle berechtigen,
* `Webservicenutzer` für technische Rollen, die zur Verwendung einer Web-Service-Schnittstelle eines Service-Gateways berechtigen,
* `Nutzer` für fachliche Rollen, die zur Nutzung der Oberfläche einer Anwendung berechtigen,
* `Servicenutzer` für fachliche Rollen, die zur Verwendung eines Service-Gateways berechtigen,
* `Batch` für fachliche Rollen, die zur Ausführung eines Batches zu einer Anwendung berechtigen,
* `Launcher` für fachliche Rollen, die zur Ausführung eines internen Tasks einer Anwendung berechtigen.

*Label:* Name der Rolle, wie sie in der Oberfläche der Benutzeradministration angezeigt wird.
In der Regel ist dieser Name identisch mit dem technischen Namen der Rolle.
Eine Abweichung ist nur dann sinnvoll, wenn die Vergabe der Rollen durch den Administrator dadurch intuitiver wird.

*Beschreibung:* Eine kurze Beschreibung der Rolle in einer fachlichen Sprache, die für die Benutzeradministration verständlich ist.

*Typ:* Eine Rolle kann fachlich oder technisch sein.
Nur fachliche Rollen können über die Benutzeradministration verwaltet werden.
Technische Rollen können fachlichen Rollen allerdings untergeordnet werden (siehe weiter unten: *Untergeordnete Rollen*).

*Enthaltene Rechte:* Die Ausstattung einer fachlichen Rolle mit Rechten beschreibt den Funktionsumfang, den diese Rolle bei Nutzung der Fachanwendung ermöglicht.

*Untergeordnete Rollen:* Optional können fachliche Rollen untergeordnete technische Rollen besitzen.
Dies ist z.B. immer dann notwendig, wenn ein Anwendungsfall die Dienste eines Nachbarsystems verwendet.
Somit muss im Rahmen des Anwendungsfalls die Service-Schnittstelle des Nachbarsystems aufgerufen werden.
Die dazu benötigte, technische Rolle muss der fachlichen Rolle untergeordnet werden, damit dies funktioniert.

*Sichtbarkeit der Rolle:* Die Sichtbarkeit der Rollen bei der Zuordnung an Anwender, externe Systeme und interne Systeme kann eingeschränkt werden, um die Administration zu vereinfachen.

Die meisten Rollen sind fachlicher Natur.
Technische Rollen treten oft im Rahmen von Service-Schnittstellen auf.
Bietet eine Fachanwendung Funktionalität über Service-Schnittstellen an, so ist die Nutzung jeder Service-Schnittstelle zumindest durch eine technische Rolle abzusichern.
Diese Rollen werden nicht direkt an Anwender vergeben, sondern fachlichen Rollen anderer Fachanwendungen untergeordnet.

Wenn die Anwendung fachliche oder technische Batches enthält, dann müssen für diese Batches in der Spezifikation entsprechende „interne Systeme“ definiert werden.
Die Systemnamen sollten dem folgenden Schema entsprechen: `<Anwendungskürzel>_BAT_<Batchname>`.
Für jedes dieser internen System müssen eigene fachliche Rollen definiert werden.


[[sicherheitsarchitektur-eines-it-systems]]
== Sicherheitsarchitektur eines IT-Systems

Der Baustein Sicherheit bildet eine Komponente des Querschnitts der <<IsyFactReferenzarchitekturITSystem>>.
Er ist von jedem IT-System zur Autorisierung von Zugriffen und Vorgängen zu verwenden.
Für ein korrektes Funktionieren benötigt der Baustein die Komponente `AufrufKontextVerwalter`, deren Verwendung ebenfalls in diesem Kapitel erläutert wird.

Die Mechanismen zur Absicherung IsyFact-konformer IT-Systeme haben zum Ziel, die Autorisierung von Zugriffen _systematisch_, _einheitlich_ und _einfach_ umzusetzen.

Die *Systematik* und Vollständigkeit der Berechtigungsprüfungen wird dadurch erreicht, dass Berechtigungsprüfungen in den IT-Systemen an definierten Stellen und auf identische Weise stattfinden.

Die *Einheitlichkeit* wird durch Bereitstellung der Bibliothek `isy-sicherheit` und Nutzungsvorgaben gewährleistet, die von allen IT-Systemen zu verwenden sind.
Berechtigungsprüfungen erfolgen innerhalb eines IT-Systems immer über die Bibliothek `isy-sicherheit`.

Die *Einfachheit* der Nutzung der Bibliothek `isy-sicherheit` wird durch weitgehende Transparenz bei der Initialisierung, kompakte Schnittstellen und deklarative (z.B. per Annotation) statt programmatischer Implementierung erreicht.

[[praemissen]]
=== Prämissen

Aus den <<prinzipien-der-sicherheitsarchitektur>> leiten sich die folgenden Randbedingungen für die Umsetzung der Berechtigungsprüfung innerhalb eines IT-Systems ab:

* Anfragen, die am Dialog eines IT-Systems eingehen, sind immer bereits durch das IAM-System bzw. die lokale Authentifizierung erfolgreich  authentifiziert.
Sorgt ein IAM-System für die Authentifizierung, enthält der HTTP-Header der Anfrage die Identifikation des Anwenders und dessen Rollen.
Die Informationen aus dem HTTP-Header werden als `AufrufKontext` in das IT-System übernommen.
* Anfragen, die an einer Service-Schnittstelle eines IT-Systems eingehen, sind ebenso bereits authentifiziert.
Das mit der Anfrage an das IT-System als Parameter übergebene Transportobjekt `AufrufKontextTo` enthält die Identifikation des Anwenders und dessen Rollen und wird als `AufrufKontext` in das IT-System übernommen.
* Prozesse, die unabhängig von eingehenden Anfragen (über Dialog und Service) durch ein IT-System gestartet werden, müssen zunächst einen (meist technischen) Anwender gegen das IAM-System bzw. die lokale Authentifizierung erfolgreich authentifizieren, dessen Rollen ermitteln und diese Informationen als `AufrufKontext` im IT-System hinterlegen.
* Ein innerhalb der Logik- und Verarbeitungszone eines IT-Systems übergebener `AufrufKontext` ist vertrauenswürdig.
Er kann ohne erneute Rückfrage an das IAM-System bzw. die lokale Authentifizierung verwendet werden.

[[software-architektur]]
=== Software-Architektur

Die folgende Abbildung zeigt den logischen Aufbau für die Authentifizierung und für die Bereitstellung von Berechtigungsinformationen an die Komponenten eines IT-Systems.

:desc-image-Berechtigungspruefung: Software-Architektur der Berechtigungsprüfung
[id="image-Berechtigungspruefung",reftext="{figure-caption} {counter:figures}"]
.{desc-image-Berechtigungspruefung}
image::sicherheit_001.png[align="center"]

Im Folgenden werden die Aufgaben und grobe Funktionsweise der Komponenten für die Autorisierung von Anfragen in einer Fachanwendung erläutert.

Die Komponente `AufrufKontextVerwalter` stellt für eine laufende Anfrage Kontextinformationen zur Anfrage bereit, die in einem `AufrufKontext` hinterlegt werden.
Das sind insbesondere die mit der Anfrage über die Außenschnittstelle eingehenden Informationen zum Anwender und dessen Rollen, die Korrelations-ID und anwendungsspezifisch ggf. weitere Informationen.
Die Komponente bringt Hilfsmittel zur transparenten Nutzung des `AufrufKontextVerwalter` mit.
So wird der `AufrufKontext` bei Serviceaufrufen transparent über Interceptoren via Spring AOP gesetzt.
Weiterhin wird der Aufrufkontext im Rahmen der Authentifizierung automatisch befüllt.
Nach Initialisierung des `AufrufKontextVerwalter` für eine laufende Anfrage kann das IT-System fortan transparent mit den im `AufrufKontextVerwalter` hinterlegten Anwenderinformationen arbeiten (ohne deren Herkunft zu kennen) und damit auch weitere Nachbarsysteme aufrufen.

Der Baustein Sicherheit bietet folgende Funktionen:

* Für Service-Aufrufe werden Interceptoren angeboten, welche über Spring AOP eine deklarative Berechtigungsprüfung ermöglichen.
* Für den Kontext der Anfrage stellt der Baustein einen Berechtigungsmanager zur Verfügung, der die Rollen des anfragenden Anwenders kennt.
Die Informationen zum anfragenden Anwender werden – falls vorhanden – aus dem `AufrufKontextVerwalter` entnommen.
Die Fachkomponenten eines IT-Systems nutzen den Berechtigungsmanager für spezielle Berechtigungsprüfungen, die nicht deklarativ über Annotationen erfolgen können.
* Anwender können anhand der übergebenen Benutzerkennung (und Passwort) authentifiziert werden.
Dazu wird das IAM-System bzw. die lokale Authentifizierung angesprochen.
Die gewonnenen Informationen werden im `AufrufKontextVerwalter` hinterlegt.
* Das Interface `AccessManager` bietet eine Abstraktion für verschiedene Berechtigungsquellen an.

Die Authentifizierung und Autorisierung von Web-Zugriffen wird über Spring Security durchgeführt.
Die Integration von Spring Security und des Bausteins Sicherheit wird im <<DetailkonzeptKomponenteWebGUI>> beschrieben.

[[aussensicht-der-komponente-sicherheit]]
== Schnittstelle des Bausteins Sicherheit

Im Folgenden wird die Schnittstelle des Bausteins Sicherheit beschrieben.

:desc-image-schnittstelle-sicherheit: Schnittstelle des Bausteins Sicherheit
[id="image-schnittstelle-sicherheit",reftext="{figure-caption} {counter:figures}"]
.{desc-image-schnittstelle-sicherheit}
image::sicherheit_002.png[align="center"]

Die zentrale Schnittstelle für den Zugriff auf Rollen und Rechte eines Anwenders ist `Berechtigungsmanager`.
Instanzen des Berechtigungsmanagers zur Autorisierung einer Anfrage werden über die Schnittstelle `Sicherheit` erzeugt.

Der Berechtigungsmanager verwendet die Schnittstellen `Rolle` und `Recht`.
Rollen werden über die Benutzeradministration Anwendern zugewiesen.
Rechte sind anwendungsspezifisch und an Rollen gebunden.

[[aufruf-von-nachbarsystemen]]
== Aufruf von Nachbarsystemen

Ein Nachbarsystem, das aufgerufen wird, erwartet einen gültigen, vollständigen Aufrufkontext vorzufinden.
Das aufrufende System muss daher einen Aufrufkontext mitliefern.
Im Regelfall soll dabei der Aufrufkontext der originären Anfrage verwendet und unverändert weitergeleitet werden.

Zum Aufruf von Nachbarsystemen sollen, falls vorhanden, dedizierte Client-Bibliotheken verwendet werden.
Diese enthalten bereits die Logik zur Weiterleitung des Aufrufkontextes.

Gibt es diese nicht, muss das Nachbarsystem direkt aufgerufen werden.
Hierbei muss das aufrufende IT-System stets ein entsprechendes Transportobjekt befüllen und mit dem Aufruf an das Nachbarsystem übergeben.
Für die Technologie Spring HTTP-Invoker stellt die IsyFact passende Transportobjekte in der Bibliothek `isy-serviceapi-sst` bereit.

// end::inhalt[]